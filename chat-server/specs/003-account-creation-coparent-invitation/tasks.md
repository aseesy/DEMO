# Task Breakdown: Account Creation with Co-Parent Invitation

**Feature**: 003-account-creation-coparent-invitation
**Date**: 2025-11-25
**Generated by**: tasks-agent
**Total Tasks**: 35

---

## Task Execution Strategy

### Dependency Order
```
Database (T001)
  â†’ Libraries (T002-T005) [P]
    â†’ Library Tests (T006-T009) [P]
      â†’ Backend API (T010-T020)
        â†’ Backend Tests (T021-T026)
          â†’ Frontend (T027-T032) [P]
            â†’ Integration Tests (T033-T035)
```

### TDD Workflow
- **Test First**: All test tasks (T006-T009, T021-T026, T033-T035) come before implementation
- **Fail â†’ Implement â†’ Pass**: Tests initially fail, then implementation makes them pass
- **Refactor**: After tests pass, refactor for quality

### Parallel Execution Markers
- **[P]** = Can execute in parallel with other [P] tasks in same phase
- Sequential dependencies indicated in "Dependencies" field

---

## Phase 1: Database Setup

### T001: Create Database Migration for Invitations
**Type**: infrastructure
**Priority**: critical
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Create PostgreSQL migration file `003_invitations.sql` that adds:
1. `invitations` table with fields: id, inviter_id, invitee_email, token_hash, room_id, status, expires_at, created_at, accepted_at, accepted_by
2. `in_app_notifications` table with fields: id, user_id, type, message, data (JSONB), is_read, created_at, read_at
3. Indexes for performance: token_hash, invitee_email, status+expires_at, user_id+is_read
4. Foreign key constraints with CASCADE/SET NULL rules
5. Check constraints for status and type enums
6. Rollback script for down migration

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/migrations/003_invitations.sql`
- Up migration SQL
- Down migration SQL (for rollback)

**Acceptance Criteria**:
- [ ] Migration runs successfully on empty database
- [ ] All tables and indexes created as specified in data-model.md
- [ ] Foreign key constraints enforce referential integrity
- [ ] Down migration cleanly removes all tables (no orphaned data)
- [ ] Migration is idempotent (can run multiple times safely)
- [ ] All column types match data-model.md specification

**Technical Notes**:
- Reference: `/Users/athenasees/Desktop/chat/chat-server/specs/003-account-creation-coparent-invitation/data-model.md`
- Use `CREATE TABLE IF NOT EXISTS` for idempotency
- Include comments on tables/columns for documentation
- Follow existing migration naming convention: `NNN_description.sql`

**Dependencies**: None (must execute first)

**Risk Factors**:
- PostgreSQL version compatibility (ensure JSONB support exists)
- **Mitigation**: Test on local PostgreSQL instance matching production version

---

## Phase 2: Core Library Implementation

### T002: Create invitationManager.js Library [P]
**Type**: feature
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 3

**Description**:
Create standalone library for invitation management with functions:
1. `generateToken()` - Generate cryptographically secure 32-byte base64url token
2. `hashToken(token)` - SHA-256 hash for database storage
3. `createInvitation(inviterId, inviteeEmail, roomId)` - Create invitation record with 7-day expiration
4. `validateToken(token)` - Validate token (hash, check expiration, status='pending')
5. `acceptInvitation(invitationId, userId)` - Mark invitation accepted with timestamp
6. `checkExistingInvitation(inviteeEmail)` - Check for pending invitation to email
7. `expireInvitations()` - Cron job to mark expired invitations (status='expired')

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/invitationManager.js`

**Acceptance Criteria**:
- [ ] Library exports all 7 functions with clear JSDoc comments
- [ ] `generateToken()` uses crypto.randomBytes(32) and returns 43-char base64url string
- [ ] `hashToken()` uses SHA-256 and returns 64-char hex string
- [ ] `createInvitation()` sets expires_at = NOW() + 7 days
- [ ] `validateToken()` returns invitation object if valid, null if expired/invalid
- [ ] `acceptInvitation()` updates status, accepted_at, accepted_by fields atomically
- [ ] All database operations use parameterized queries (dbSafe.safeInsert/safeUpdate)
- [ ] Library has no external dependencies beyond crypto, db modules

**Technical Notes**:
- Reference: `/Users/athenasees/Desktop/chat/chat-server/specs/003-account-creation-coparent-invitation/research.md` (Decisions 2, 3, 7)
- Use existing db.js for database operations
- Token format: `crypto.randomBytes(32).toString('base64url')`
- Hash format: `crypto.createHash('sha256').update(token).digest('hex')`

**Dependencies**: T001 (database migration must run first)

**Risk Factors**:
- Token collision (extremely unlikely with 256-bit entropy)
- **Mitigation**: UNIQUE constraint on token_hash in database

---

### T003: Create notificationManager.js Library [P]
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 2

**Description**:
Create standalone library for in-app notification management with functions:
1. `createNotification(userId, type, message, data)` - Create notification record
2. `getUserNotifications(userId, unreadOnly)` - Get user's notifications (optionally filter unread)
3. `markAsRead(notificationId)` - Mark notification as read with timestamp
4. `deleteNotification(notificationId)` - Delete notification (for user dismissal)
5. `cleanupOldNotifications()` - Cron job to delete read notifications older than 30 days

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/notificationManager.js`

**Acceptance Criteria**:
- [ ] Library exports all 5 functions with JSDoc comments
- [ ] `createNotification()` validates type is in allowed list: 'invitation_received', 'invitation_accepted', 'room_joined'
- [ ] `createNotification()` stores data as JSONB (JSON.stringify before insert)
- [ ] `getUserNotifications()` returns notifications ordered by created_at DESC
- [ ] `markAsRead()` sets is_read=true and read_at=NOW() atomically
- [ ] `cleanupOldNotifications()` only deletes read notifications older than 30 days (keeps unread)
- [ ] All database operations use parameterized queries

**Technical Notes**:
- Reference: data-model.md section 3 (InAppNotification entity)
- JSONB data structure: `{invitation_id, inviter_id, inviter_name, room_id, action_url}`
- Use existing db.js for database operations

**Dependencies**: T001 (database migration must run first)

**Risk Factors**:
- JSONB compatibility (PostgreSQL version <9.4 doesn't support JSONB)
- **Mitigation**: Verify PostgreSQL version â‰¥9.4 in production

---

### T004: Extend emailService.js with Invitation Template [P]
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Add new email template function to existing emailService.js:
1. `sendCoParentInvitation(inviteeEmail, inviterName, token, expiresAt)` - Send invitation email with token link
2. Email should include:
   - Subject: "You're invited to co-parent on LiaiZen"
   - Inviter's name: "{inviterName} has invited you..."
   - Invitation link: `${FRONTEND_URL}/join?token=${token}`
   - Expiration notice: "This invitation will expire in 7 days"
   - HTML template (responsive, mobile-friendly)
   - Plain text fallback

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/emailService.js`

**Acceptance Criteria**:
- [ ] New function `sendCoParentInvitation()` added to exports
- [ ] Email uses existing nodemailer transporter
- [ ] HTML template is responsive (tested on mobile preview)
- [ ] Plain text fallback included (no HTML tags)
- [ ] Call-to-action button clearly visible
- [ ] Link also shown as plain text URL (for clients that strip buttons)
- [ ] Neutral, professional tone (no guilt/pressure language)
- [ ] Development mode logs email to console instead of sending

**Technical Notes**:
- Reference existing `sendNewUserInvite()` function as template
- Use `process.env.FRONTEND_URL` for link base URL
- Use existing email templates in emailService.js as style guide
- Research.md Decision 4 for email template requirements

**Dependencies**: None (extends existing file)

**Risk Factors**:
- Email deliverability (spam filters)
- **Mitigation**: Follow email best practices (SPF/DKIM records, legitimate sender domain)

---

### T005: Extend roomManager.js for Co-Parent Sharing [P]
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Add function to existing roomManager.js to add co-parent to existing room:
1. `addCoParentToRoom(roomId, userId)` - Add user to room as 'member' role
2. Ensure user not already in room (check UNIQUE constraint)
3. Set role='member' for equal permissions (no 'owner' role for co-parents)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/roomManager.js`

**Acceptance Criteria**:
- [ ] New function `addCoParentToRoom(roomId, userId)` exported
- [ ] Function checks if user already in room (prevent duplicate membership)
- [ ] Inserts row into room_members with role='member' (not 'owner')
- [ ] Returns room object with all members
- [ ] Uses parameterized query for INSERT
- [ ] Handles database errors gracefully (returns error message)

**Technical Notes**:
- Reference: research.md Decision 6 (Room Architecture)
- Use existing `dbSafe.safeInsert()` function
- UNIQUE(room_id, user_id) constraint prevents duplicates

**Dependencies**: T001 (database must have room_members table)

**Risk Factors**:
- Room capacity limit (future consideration - MVP is 2 members only)
- **Mitigation**: Add validation to check room member count <2 before adding

---

## Phase 3: Library Unit Tests (Test-First - Will Initially Fail)

### T006: Unit Tests for invitationManager.js [P]
**Type**: test
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 2

**Description**:
Write comprehensive unit tests for invitationManager library:
1. Test `generateToken()` - uniqueness, length, URL-safe characters
2. Test `hashToken()` - deterministic hashing, 64-char output
3. Test `createInvitation()` - database insertion, expiration calculation
4. Test `validateToken()` - valid token, expired token, invalid token, used token
5. Test `acceptInvitation()` - status update, timestamp setting
6. Test `checkExistingInvitation()` - pending invitation found, no invitation found
7. Test `expireInvitations()` - batch update of expired invitations

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/unit/invitationManager.test.js`

**Acceptance Criteria**:
- [ ] Test file uses Jest framework (existing setup)
- [ ] All 7 functions have test coverage
- [ ] Tests use in-memory SQLite database (not production DB)
- [ ] Tests clean up data after each test (afterEach hook)
- [ ] Edge cases tested: duplicate tokens, expired tokens, missing data
- [ ] Security tests: token length, randomness, hash consistency
- [ ] Coverage >95% for invitationManager.js (security-critical code)
- [ ] **Tests initially FAIL** (no implementation exists yet)

**Technical Notes**:
- Use Jest's `describe()` and `it()` syntax
- Mock database calls if needed for isolation
- Reference: research.md Decision 13 (Testing Patterns)

**Dependencies**: T002 (invitationManager must exist to test)

**Risk Factors**:
- Test data pollution (tests affecting each other)
- **Mitigation**: Use `beforeEach` and `afterEach` to reset database state

---

### T007: Unit Tests for notificationManager.js [P]
**Type**: test
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Write unit tests for notificationManager library:
1. Test `createNotification()` - valid notification creation, JSONB data storage
2. Test `getUserNotifications()` - unread filter, ordering by created_at DESC
3. Test `markAsRead()` - is_read flag, read_at timestamp
4. Test `deleteNotification()` - deletion, non-existent notification handling
5. Test `cleanupOldNotifications()` - delete only read + old, keep unread

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/unit/notificationManager.test.js`

**Acceptance Criteria**:
- [ ] All 5 functions have test coverage
- [ ] Tests verify JSONB data is correctly stored and retrieved
- [ ] Edge cases: invalid notification type, missing user_id, null data
- [ ] Cleanup function tested with various date ranges
- [ ] Coverage >90% for notificationManager.js
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Mock Socket.io for notification push tests (optional - unit tests only)
- Use Jest's `expect()` assertions

**Dependencies**: T003 (notificationManager must exist to test)

**Risk Factors**: None significant

---

### T008: Unit Tests for Email Template [P]
**Type**: test
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Write tests for new email template function:
1. Test `sendCoParentInvitation()` - email content generation
2. Test HTML template rendering (inviter name, token link, expiration notice)
3. Test plain text fallback content
4. Test development mode (console logging instead of sending)

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/unit/emailService.test.js` (extend existing if exists)

**Acceptance Criteria**:
- [ ] Test verifies email subject is correct
- [ ] Test verifies invitation link includes token parameter
- [ ] Test verifies both HTML and plain text versions generated
- [ ] Test verifies development mode doesn't actually send email
- [ ] Mock nodemailer transporter for testing (no real emails sent)
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Use Jest to mock nodemailer `sendMail()` function
- Verify email content without actually sending

**Dependencies**: T004 (emailService extension must exist)

**Risk Factors**: None significant

---

### T009: Unit Tests for Room Sharing [P]
**Type**: test
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Write tests for room sharing function:
1. Test `addCoParentToRoom()` - successful addition as 'member'
2. Test duplicate prevention (user already in room)
3. Test non-existent room handling
4. Test non-existent user handling

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/unit/roomManager.test.js` (extend existing)

**Acceptance Criteria**:
- [ ] Test verifies role='member' (not 'owner')
- [ ] Test verifies UNIQUE constraint prevents duplicates
- [ ] Test handles edge cases gracefully (error messages, not crashes)
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Extend existing roomManager tests (don't create new file if tests already exist)

**Dependencies**: T005 (roomManager extension must exist)

**Risk Factors**: None significant

---

## Phase 4: Backend API Implementation

### T010: Extend auth.js Registration Endpoint
**Type**: feature
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 2

**Description**:
Modify `/api/auth/register` endpoint to accept coParentEmail parameter and send invitation:
1. Add `coParentEmail` to request body validation (REQUIRED field)
2. Validate coParentEmail format (RFC 5322)
3. Prevent self-invitation (coParentEmail !== email)
4. After user creation, call `invitationManager.createInvitation()`
5. Check if coParentEmail is existing user:
   - If new user â†’ send email via `emailService.sendCoParentInvitation()`
   - If existing user â†’ create in-app notification via `notificationManager.createNotification()`
6. Return invitation status in response

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/auth.js`

**Acceptance Criteria**:
- [ ] `coParentEmail` is required field (400 error if missing)
- [ ] Email format validation (RFC 5322 regex)
- [ ] Self-invitation blocked (400 error: "You cannot invite yourself")
- [ ] Invitation created with status='pending', expires_at=NOW()+7 days
- [ ] Email sent to new users, in-app notification sent to existing users
- [ ] Response includes invitation object: `{invitationId, inviteeEmail, status, expiresAt, deliveryMethod}`
- [ ] Maintains backward compatibility (existing signup flows without coParentEmail still work)
- [ ] Atomic transaction (user creation + invitation creation + room sharing)

**Technical Notes**:
- Reference: contracts/auth.yaml (POST /api/auth/register schema)
- Use validator library for email validation
- Wrap in try-catch for error handling

**Dependencies**: T002, T003, T004 (libraries must exist)

**Risk Factors**:
- Email delivery failure should not block user signup
- **Mitigation**: Async email sending (don't await), log failures

---

### T011: Create POST /api/invitations/send Endpoint
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Create endpoint to send invitation from authenticated user:
1. Authenticate user via JWT middleware
2. Validate request body: email (required)
3. Rate limit: 5 invitations per hour per user
4. Prevent self-invitation
5. Check existing pending invitation (don't create duplicate)
6. Create invitation via `invitationManager.createInvitation()`
7. Send email or in-app notification based on user existence
8. Return generic success message (don't reveal if user exists - security)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add route)

**Acceptance Criteria**:
- [ ] Endpoint: POST /api/invitations/send
- [ ] Requires authentication (JWT in Authorization header)
- [ ] Rate limited to 5 requests per hour per user
- [ ] Returns 200 with generic message: "If this email is valid, an invitation has been sent"
- [ ] Creates invitation record in database
- [ ] Sends email to new users, in-app notification to existing users
- [ ] Logs invitation creation for audit trail

**Technical Notes**:
- Use express-rate-limit middleware
- Reference: research.md Decision 11 (Prevent Email Enumeration)
- Return same response regardless of whether email exists (security)

**Dependencies**: T002, T003, T004 (libraries must exist)

**Risk Factors**:
- Spam abuse (rate limiting mitigates)
- **Mitigation**: Rate limit + log suspicious activity

---

### T012: Create GET /api/invitations/:token Endpoint
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Create endpoint to validate invitation token (for frontend to check token before showing signup form):
1. Extract token from URL parameter
2. Validate token via `invitationManager.validateToken()`
3. Return invitation details (inviter name, room name) if valid
4. Return 400 error if token expired/invalid
5. Do NOT mark invitation as accepted (read-only validation)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add route)

**Acceptance Criteria**:
- [ ] Endpoint: GET /api/invitations/:token
- [ ] No authentication required (public endpoint for signup flow)
- [ ] Returns 200 with invitation details if valid: `{inviterName, roomName, expiresAt}`
- [ ] Returns 400 with error if token expired: `{error: "Invalid or expired invitation code", code: "INVALID_TOKEN"}`
- [ ] Returns 400 with error if token doesn't exist
- [ ] Logs token validation attempts for security monitoring

**Technical Notes**:
- Token is 43-character base64url string (validate format first)
- Join users table to get inviter's name

**Dependencies**: T002 (invitationManager must exist)

**Risk Factors**:
- Brute force token guessing (extremely unlikely with 256-bit entropy)
- **Mitigation**: Rate limit this endpoint (100 requests per hour per IP)

---

### T013: Create POST /api/invitations/:token/accept Endpoint
**Type**: feature
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 2

**Description**:
Create endpoint for co-parent to accept invitation and create account:
1. Extract token from URL parameter
2. Validate token via `invitationManager.validateToken()`
3. Validate request body: email, password (must match invitee_email)
4. Create user account via `auth.createUserWithEmail()`
5. Mark invitation accepted via `invitationManager.acceptInvitation()`
6. Add user to room via `roomManager.addCoParentToRoom()`
7. Send in-app notification to inviter: "X accepted your invitation"
8. Return user object + JWT token (auto-login)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add route)

**Acceptance Criteria**:
- [ ] Endpoint: POST /api/invitations/:token/accept
- [ ] No authentication required (public endpoint for signup)
- [ ] Validates email matches invitation's invitee_email
- [ ] Creates user account with hashed password
- [ ] Marks invitation status='accepted', accepted_at=NOW(), accepted_by=userId
- [ ] Adds user to inviter's room with role='member'
- [ ] Notifies inviter via in-app notification
- [ ] Returns 201 with user object + JWT token
- [ ] Atomic transaction (all operations succeed or all fail)
- [ ] Returns 400 if token expired/invalid
- [ ] Returns 400 if email already registered (duplicate account)

**Technical Notes**:
- Use database transaction for atomicity
- Reference: contracts/auth.yaml response schema
- Call existing `auth.createUserWithEmail()` function

**Dependencies**: T002, T003, T005 (all libraries must exist)

**Risk Factors**:
- Race condition if multiple users try to accept same invitation
- **Mitigation**: Database UNIQUE constraint on token_hash prevents duplicate acceptance

---

### T014: Create GET /api/notifications Endpoint
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Create endpoint to get user's in-app notifications:
1. Authenticate user via JWT middleware
2. Optional query parameter: unreadOnly=true/false
3. Call `notificationManager.getUserNotifications(userId, unreadOnly)`
4. Return notifications array ordered by created_at DESC

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add route)

**Acceptance Criteria**:
- [ ] Endpoint: GET /api/notifications?unreadOnly=true
- [ ] Requires authentication (JWT)
- [ ] Returns notifications array with id, type, message, data, is_read, created_at
- [ ] Supports filtering by unreadOnly query param
- [ ] Returns empty array if no notifications (not 404 error)
- [ ] Logs notification access for audit trail

**Technical Notes**:
- Use existing JWT authentication middleware
- Query param: `req.query.unreadOnly === 'true'`

**Dependencies**: T003 (notificationManager must exist)

**Risk Factors**: None significant

---

### T015: Create PATCH /api/notifications/:id/read Endpoint
**Type**: feature
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 0.5

**Description**:
Create endpoint to mark notification as read:
1. Authenticate user via JWT middleware
2. Validate notification belongs to authenticated user (security check)
3. Call `notificationManager.markAsRead(notificationId)`
4. Return updated notification object

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add route)

**Acceptance Criteria**:
- [ ] Endpoint: PATCH /api/notifications/:id/read
- [ ] Requires authentication (JWT)
- [ ] Verifies notification belongs to authenticated user (403 if not)
- [ ] Updates is_read=true, read_at=NOW()
- [ ] Returns 200 with updated notification object
- [ ] Returns 404 if notification doesn't exist

**Technical Notes**:
- Security check: `WHERE id = :id AND user_id = :userId`

**Dependencies**: T003 (notificationManager must exist)

**Risk Factors**:
- User could mark another user's notifications as read (prevented by security check)

---

### T016: Add Socket.io Notification Push Event
**Type**: feature
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Emit Socket.io event when notification created (for real-time updates):
1. Modify `notificationManager.createNotification()` to accept optional io instance
2. After creating notification, emit Socket.io event to user's socket: `socket.to(userSocketId).emit('notification', notificationData)`
3. Store user's socket ID when they connect (existing Socket.io connection)
4. Handle user offline gracefully (notification persists in database for later retrieval)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/notificationManager.js`
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (Socket.io setup)

**Acceptance Criteria**:
- [ ] `createNotification()` accepts optional io parameter
- [ ] Socket.io event emitted if io provided: `io.to(userId).emit('notification', notification)`
- [ ] Notification still created in database even if user offline
- [ ] User's socket ID stored in memory map: `userSockets[userId] = socketId`
- [ ] Handle disconnection gracefully (remove socket ID from map)

**Technical Notes**:
- Use existing Socket.io setup in server.js
- Socket.io rooms: each user joins room with their userId
- Reference existing chat message push implementation

**Dependencies**: T003 (notificationManager must exist), T014 (GET notifications for fallback)

**Risk Factors**:
- User has multiple tabs/devices open (send to all sockets)
- **Mitigation**: Use Socket.io rooms (userId = room name, all user sockets join room)

---

### T017: Add Invitation Cleanup Cron Job
**Type**: infrastructure
**Priority**: low
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Create daily cron job to mark expired invitations:
1. Use node-cron (or existing scheduler)
2. Schedule daily at 2am UTC: `cron.schedule('0 2 * * *', ...)`
3. Call `invitationManager.expireInvitations()`
4. Log results (number of invitations expired)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add cron job)

**Acceptance Criteria**:
- [ ] Cron job runs daily at 2am UTC
- [ ] Calls `invitationManager.expireInvitations()`
- [ ] Logs number of invitations expired: "âœ… Expired 5 invitations"
- [ ] Handles errors gracefully (log error, don't crash server)
- [ ] Can be manually triggered for testing: `npm run expire-invitations`

**Technical Notes**:
- Use node-cron package (likely already installed)
- If not installed: `npm install node-cron`
- Low priority - can be added after core features working

**Dependencies**: T002 (invitationManager.expireInvitations must exist)

**Risk Factors**: None significant

---

### T018: Add Notification Cleanup Cron Job
**Type**: infrastructure
**Priority**: low
**Complexity**: small (S)
**Estimated Hours**: 0.5

**Description**:
Create daily cron job to delete old read notifications:
1. Schedule daily at 3am UTC
2. Call `notificationManager.cleanupOldNotifications()`
3. Log results (number of notifications deleted)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js` (add cron job)

**Acceptance Criteria**:
- [ ] Cron job runs daily at 3am UTC
- [ ] Deletes read notifications older than 30 days
- [ ] Logs number of notifications deleted
- [ ] Handles errors gracefully

**Technical Notes**:
- Low priority - database cleanup, not critical for MVP

**Dependencies**: T003 (notificationManager.cleanupOldNotifications must exist)

**Risk Factors**: None significant

---

### T019: Add Rate Limiting Middleware
**Type**: infrastructure
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Add rate limiting to invitation endpoints:
1. Use express-rate-limit package (or existing rate limiter)
2. Limit POST /api/invitations/send to 5 requests per hour per user
3. Limit GET /api/invitations/:token to 100 requests per hour per IP
4. Return 429 error with clear message when rate limit exceeded

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-server/server.js`

**Acceptance Criteria**:
- [ ] Rate limiter middleware applied to invitation endpoints
- [ ] POST /send limited to 5 requests per hour per authenticated user
- [ ] GET /:token limited to 100 requests per hour per IP
- [ ] Returns 429 status with error: "Too many requests. Please try again later."
- [ ] Rate limit counters reset after time window expires

**Technical Notes**:
- Reference: research.md Decision 16 (Rate Limiting)
- Use user ID for send endpoint, IP for validate endpoint
- Log rate limit violations for security monitoring

**Dependencies**: T011, T012 (endpoints must exist)

**Risk Factors**:
- Shared IPs (multiple users behind same NAT)
- **Mitigation**: Use user ID for authenticated endpoints, not IP

---

### T020: Update CLAUDE.md Documentation
**Type**: docs
**Priority**: low
**Complexity**: small (S)
**Estimated Hours**: 0.5

**Description**:
Update `/Users/athenasees/Desktop/chat/CLAUDE.md` with:
1. New API endpoints (POST /send, GET /:token, POST /accept, GET /notifications, PATCH /:id/read)
2. Invitation flow architecture diagram
3. Common troubleshooting patterns (token expiration, email delivery failures)
4. Testing guidance for invitation features
5. Environment variables (none new, but document FRONTEND_URL usage)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/CLAUDE.md`

**Acceptance Criteria**:
- [ ] All new endpoints documented with parameters and responses
- [ ] Invitation flow diagram added (ASCII or markdown)
- [ ] Troubleshooting section includes invitation-specific issues
- [ ] Recent changes section updated with date and summary

**Technical Notes**:
- Keep last 3 updates in "Recent Changes" section
- Follow existing CLAUDE.md format and style

**Dependencies**: T010-T015 (endpoints must be implemented)

**Risk Factors**: None

---

## Phase 5: Backend Contract Tests (Test-First - Will Initially Fail)

### T021: Contract Tests for POST /api/auth/register
**Type**: test
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 2

**Description**:
Write contract tests for extended registration endpoint:
1. Test successful registration with coParentEmail (new user)
2. Test successful registration with coParentEmail (existing user)
3. Test validation: missing coParentEmail (400 error)
4. Test validation: invalid coParentEmail format (400 error)
5. Test validation: self-invitation (400 error)
6. Test validation: duplicate email (400 error)
7. Test response schema matches contracts/auth.yaml

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/contract/auth.test.js` (extend existing)

**Acceptance Criteria**:
- [ ] All 7 test cases pass
- [ ] Tests use supertest for HTTP requests
- [ ] Tests verify HTTP status codes (201 success, 400 error)
- [ ] Tests verify response schema matches OpenAPI spec
- [ ] Tests verify invitation object in response
- [ ] Tests verify email sent (mock nodemailer)
- [ ] **Tests initially FAIL** (endpoint not fully implemented yet)

**Technical Notes**:
- Reference: contracts/auth.yaml for schema validation
- Use Jest + supertest for API testing

**Dependencies**: T010 (registration endpoint extension)

**Risk Factors**: None significant

---

### T022: Contract Tests for POST /api/invitations/send
**Type**: test
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Write contract tests for send invitation endpoint:
1. Test successful invitation send (200 success)
2. Test authentication required (401 error if no JWT)
3. Test validation: missing email (400 error)
4. Test validation: invalid email format (400 error)
5. Test validation: self-invitation (400 error)
6. Test rate limiting (429 error after 5 requests)
7. Test response schema

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/contract/invitations.test.js`

**Acceptance Criteria**:
- [ ] All 7 test cases pass
- [ ] Tests verify authentication enforcement
- [ ] Tests verify rate limiting works
- [ ] Tests verify invitation created in database
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Mock JWT authentication for valid user
- Use supertest to simulate multiple requests (rate limit test)

**Dependencies**: T011 (send endpoint)

**Risk Factors**: None significant

---

### T023: Contract Tests for GET /api/invitations/:token
**Type**: test
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Write contract tests for token validation endpoint:
1. Test valid token (200 with invitation details)
2. Test expired token (400 error)
3. Test invalid token format (400 error)
4. Test non-existent token (400 error)
5. Test response schema

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/contract/invitations.test.js` (extend)

**Acceptance Criteria**:
- [ ] All 5 test cases pass
- [ ] Tests create test invitation tokens in database
- [ ] Tests verify response schema matches OpenAPI spec
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Create test tokens with varying expiration dates

**Dependencies**: T012 (validate endpoint)

**Risk Factors**: None significant

---

### T024: Contract Tests for POST /api/invitations/:token/accept
**Type**: test
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 2

**Description**:
Write contract tests for accept invitation endpoint:
1. Test successful acceptance (201 with user + token)
2. Test email mismatch (400 error)
3. Test expired token (400 error)
4. Test duplicate email (400 error if email already registered)
5. Test weak password (400 error)
6. Test response schema
7. Test invitation marked accepted in database
8. Test user added to room

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/contract/invitations.test.js` (extend)

**Acceptance Criteria**:
- [ ] All 8 test cases pass
- [ ] Tests verify user account created
- [ ] Tests verify invitation status='accepted'
- [ ] Tests verify user added to room_members
- [ ] Tests verify JWT token returned
- [ ] **Tests initially FAIL**

**Technical Notes**:
- This is the most complex contract test (multiple operations)
- Verify database state after acceptance

**Dependencies**: T013 (accept endpoint)

**Risk Factors**: None significant

---

### T025: Contract Tests for GET /api/notifications
**Type**: test
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Write contract tests for notifications endpoint:
1. Test successful retrieval (200 with notifications array)
2. Test authentication required (401 error)
3. Test unreadOnly filter (returns only unread)
4. Test empty notifications (200 with empty array)
5. Test response schema

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/contract/notifications.test.js`

**Acceptance Criteria**:
- [ ] All 5 test cases pass
- [ ] Tests create test notifications in database
- [ ] Tests verify filtering works
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Create test notifications with is_read=true/false

**Dependencies**: T014 (get notifications endpoint)

**Risk Factors**: None significant

---

### T026: Contract Tests for PATCH /api/notifications/:id/read
**Type**: test
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 0.5

**Description**:
Write contract tests for mark as read endpoint:
1. Test successful mark as read (200 with updated notification)
2. Test authentication required (401 error)
3. Test security: cannot mark another user's notification (403 error)
4. Test non-existent notification (404 error)
5. Test response schema

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/contract/notifications.test.js` (extend)

**Acceptance Criteria**:
- [ ] All 5 test cases pass
- [ ] Tests verify is_read flag updated
- [ ] Tests verify read_at timestamp set
- [ ] **Tests initially FAIL**

**Technical Notes**:
- Test with different user JWTs to verify security

**Dependencies**: T015 (mark as read endpoint)

**Risk Factors**: None significant

---

## Phase 6: Frontend Implementation (Parallel Execution)

### T027: Create InvitationForm.jsx Component [P]
**Type**: feature
**Priority**: high
**Complexity**: small (S)
**Estimated Hours**: 2

**Description**:
Create React component for sending invitation during/after signup:
1. Form with single email input field
2. Validation: email format, not same as user's email
3. Submit handler calls POST /api/invitations/send
4. Success message: "Invitation sent to {email}"
5. Error handling: display validation errors, rate limit errors
6. Loading state during API call

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-client-vite/src/components/InvitationForm.jsx`

**Acceptance Criteria**:
- [ ] Component renders email input field
- [ ] Client-side validation before API call
- [ ] Displays loading spinner during submission
- [ ] Shows success message after successful invitation
- [ ] Shows error message if API call fails
- [ ] Accessible (WCAG 2.1 AA): labels, keyboard navigation, screen reader support

**Technical Notes**:
- Use existing form styling patterns
- Reference: quickstart.md Scenario 2 for UI flow

**Dependencies**: T011 (API endpoint must exist)

**Risk Factors**: None significant

---

### T028: Create NotificationBell.jsx Component [P]
**Type**: feature
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Create notification bell icon with unread count badge:
1. Bell icon in header/navigation bar
2. Red badge showing unread count (if >0)
3. Click opens notification panel
4. Real-time updates via Socket.io listener
5. Fetch unread count on component mount (GET /api/notifications?unreadOnly=true)

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-client-vite/src/components/NotificationBell.jsx`

**Acceptance Criteria**:
- [ ] Bell icon visible in header
- [ ] Badge shows unread count (hidden if 0)
- [ ] Clicking bell opens NotificationPanel
- [ ] Socket.io listener updates count in real-time
- [ ] Accessible: keyboard clickable, aria-label="Notifications"

**Technical Notes**:
- Use existing icon library (Heroicons or similar)
- Socket.io listener: `socket.on('notification', () => fetchUnreadCount())`

**Dependencies**: T014 (GET notifications API), T016 (Socket.io push)

**Risk Factors**: None significant

---

### T029: Create NotificationPanel.jsx Component [P]
**Type**: feature
**Priority**: medium
**Complexity**: medium (M)
**Estimated Hours**: 2.5

**Description**:
Create notification panel UI for displaying and managing notifications:
1. List of notifications (type-based rendering)
2. Each notification shows: icon, message, timestamp, action buttons
3. "Invitation Received" type shows [Accept] [Decline] buttons
4. Clicking notification marks as read (PATCH /api/notifications/:id/read)
5. Empty state: "No notifications"
6. Real-time updates via Socket.io

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-client-vite/src/components/NotificationPanel.jsx`

**Acceptance Criteria**:
- [ ] Panel displays list of notifications
- [ ] Notifications grouped by type with appropriate icons
- [ ] Accept button calls invitation accept flow
- [ ] Mark as read when notification clicked
- [ ] Real-time updates when new notification arrives
- [ ] Accessible: keyboard navigation, focus management

**Technical Notes**:
- Reference data-model.md for notification types and data structure
- Use existing UI components for buttons/cards

**Dependencies**: T014, T015 (API endpoints)

**Risk Factors**: None significant

---

### T030: Modify SignupForm.jsx to Include Invitation [P]
**Type**: feature
**Priority**: critical
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Extend existing signup form to include coParentEmail field:
1. Add "Co-Parent Email" field (REQUIRED)
2. Validation: email format, not same as user email
3. Update API call to include coParentEmail in registration request
4. Show invitation confirmation after successful signup: "Account created. Invitation sent to {coParentEmail}."
5. Handle invitation errors gracefully (account created but invitation failed)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-client-vite/src/components/SignupForm.jsx`

**Acceptance Criteria**:
- [ ] New field added: "Co-Parent Email" (required)
- [ ] Client-side validation before submission
- [ ] Registration API call includes coParentEmail
- [ ] Success message shows invitation sent confirmation
- [ ] Error handling for invitation failures (don't block signup)

**Technical Notes**:
- Reference: contracts/auth.yaml for request body schema
- Existing form already has email, password, firstName, lastName fields

**Dependencies**: T010 (registration endpoint extension)

**Risk Factors**:
- Breaking existing signup flow (test thoroughly)
- **Mitigation**: Test both old and new signup flows

---

### T031: Create AcceptInvite.jsx Page [P]
**Type**: feature
**Priority**: critical
**Complexity**: medium (M)
**Estimated Hours**: 2.5

**Description**:
Create dedicated page for invitation acceptance (/join?token=XXX):
1. Extract token from URL query parameter
2. Validate token on page load (GET /api/invitations/:token)
3. Show error if token invalid/expired
4. Show signup form if token valid (pre-filled context: inviter name)
5. Email field pre-filled (or validated to match invitation)
6. Submit calls POST /api/invitations/:token/accept
7. Redirect to shared room on success

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-client-vite/src/pages/AcceptInvite.jsx`

**Acceptance Criteria**:
- [ ] Page validates token on mount
- [ ] Shows loading state during token validation
- [ ] Shows error page if token invalid/expired
- [ ] Shows signup form if token valid
- [ ] Form includes: email (required, must match invitation), password, firstName, lastName
- [ ] Submit creates account and auto-logs in user
- [ ] Redirects to shared room after acceptance
- [ ] Accessible: error messages announced, form accessible

**Technical Notes**:
- Reference: quickstart.md Scenario 3 for flow
- Use React Router for URL parameter extraction
- Show inviter name in context: "You've been invited by {inviterName}"

**Dependencies**: T012, T013 (API endpoints)

**Risk Factors**:
- Token expired during signup form filling
- **Mitigation**: Validate token again on submit (API handles this)

---

### T032: Add Socket.io Notification Listener [P]
**Type**: feature
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1

**Description**:
Add Socket.io event listener for real-time notifications:
1. Connect to Socket.io server on app mount
2. Join user's room (user ID)
3. Listen for 'notification' event
4. Update notification count/panel when event received
5. Show browser notification (optional, with permission)

**Deliverables**:
- Modified `/Users/athenasees/Desktop/chat/chat-client-vite/src/App.jsx` or context provider

**Acceptance Criteria**:
- [ ] Socket.io connection established on login
- [ ] User joins room with their userId
- [ ] 'notification' event listener registered
- [ ] Notification bell badge updates in real-time
- [ ] Notification panel updates in real-time
- [ ] Browser notification shown (if permission granted)

**Technical Notes**:
- Use existing Socket.io connection (already used for chat)
- Event format: `socket.on('notification', (data) => { ... })`

**Dependencies**: T016 (Socket.io push implementation)

**Risk Factors**: None significant

---

## Phase 7: Integration Testing (End-to-End Flows)

### T033: Integration Test - Full Signup â†’ Invite â†’ Accept Flow
**Type**: test
**Priority**: critical
**Complexity**: large (L)
**Estimated Hours**: 3

**Description**:
Write end-to-end integration test for complete invitation flow:
1. Parent 1 signs up with coParentEmail
2. Verify invitation created in database
3. Verify email sent (or in-app notification if existing user)
4. Parent 2 accepts invitation via token link
5. Verify Parent 2 account created
6. Verify both parents in same room
7. Verify both can send messages to each other
8. Verify invitation status='accepted'

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/integration/signup-invite-accept.test.js`

**Acceptance Criteria**:
- [ ] Test covers entire user journey (Scenario 1-4 from spec.md)
- [ ] Tests verify database state at each step
- [ ] Tests verify email content (mock email service)
- [ ] Tests verify room membership
- [ ] Tests verify messages can be exchanged
- [ ] Test cleans up data after execution

**Technical Notes**:
- Reference: quickstart.md for detailed test steps
- Use Jest + supertest for API calls
- Use database transactions for test data isolation

**Dependencies**: T010, T013, T005 (all endpoints and libraries)

**Risk Factors**:
- Test data pollution (cleanup critical)
- **Mitigation**: Use unique email addresses per test run

---

### T034: Integration Test - Existing User Invitation
**Type**: test
**Priority**: high
**Complexity**: medium (M)
**Estimated Hours**: 2

**Description**:
Write integration test for inviting existing user:
1. Create Parent 2 account (existing user)
2. Parent 1 sends invitation to Parent 2's email
3. Verify in-app notification created (NOT email)
4. Parent 2 logs in and sees notification
5. Parent 2 accepts via notification panel
6. Verify both in same room
7. Verify notification marked as read

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/integration/existing-user-invite.test.js`

**Acceptance Criteria**:
- [ ] Test creates existing user before invitation
- [ ] Verifies in-app notification created (not email)
- [ ] Verifies notification appears in GET /api/notifications
- [ ] Verifies acceptance flow works
- [ ] Test cleans up data after execution

**Technical Notes**:
- Reference: quickstart.md Scenario 5
- Simulate existing user by creating account first

**Dependencies**: T011, T014, T015 (invitation send + notifications)

**Risk Factors**: None significant

---

### T035: Integration Test - Invitation Expiration
**Type**: test
**Priority**: medium
**Complexity**: small (S)
**Estimated Hours**: 1.5

**Description**:
Write integration test for expired invitation handling:
1. Create invitation with backdated expires_at (8 days ago)
2. Try to validate token via GET /api/invitations/:token
3. Verify 400 error returned
4. Try to accept via POST /api/invitations/:token/accept
5. Verify 400 error returned
6. Run expireInvitations() cron job
7. Verify status changed to 'expired'

**Deliverables**:
- `/Users/athenasees/Desktop/chat/chat-server/tests/integration/invite-expiration.test.js`

**Acceptance Criteria**:
- [ ] Test creates expired invitation (backdated)
- [ ] Verifies validation fails with clear error
- [ ] Verifies acceptance fails with clear error
- [ ] Verifies cron job updates status correctly
- [ ] Test cleans up data after execution

**Technical Notes**:
- Reference: quickstart.md Scenario 6
- Manually insert expired invitation into database

**Dependencies**: T012, T013, T017 (validation, acceptance, cron job)

**Risk Factors**: None significant

---

## Task Summary

### By Phase
- **Phase 1 (Database)**: 1 task (T001)
- **Phase 2 (Libraries)**: 4 tasks (T002-T005)
- **Phase 3 (Library Tests)**: 4 tasks (T006-T009)
- **Phase 4 (Backend API)**: 11 tasks (T010-T020)
- **Phase 5 (API Tests)**: 6 tasks (T021-T026)
- **Phase 6 (Frontend)**: 6 tasks (T027-T032)
- **Phase 7 (Integration)**: 3 tasks (T033-T035)

### By Complexity
- **Small (S)**: 22 tasks (63%)
- **Medium (M)**: 11 tasks (31%)
- **Large (L)**: 2 tasks (6%)

### By Priority
- **Critical**: 10 tasks
- **High**: 11 tasks
- **Medium**: 11 tasks
- **Low**: 3 tasks

### Total Estimated Hours
- **Phase 1**: 1 hour
- **Phase 2**: 7.5 hours
- **Phase 3**: 6.5 hours
- **Phase 4**: 12.5 hours
- **Phase 5**: 8 hours
- **Phase 6**: 11 hours
- **Phase 7**: 6.5 hours
- **TOTAL**: ~53 hours (approximately 7-8 working days)

---

## Parallel Execution Opportunities

**Maximum Parallelism**:
- Phase 2: 4 tasks can run in parallel [P] (T002-T005)
- Phase 3: 4 tasks can run in parallel [P] (T006-T009)
- Phase 6: 6 tasks can run in parallel [P] (T027-T032)

**Critical Path** (longest sequential dependency chain):
```
T001 â†’ T002 â†’ T006 â†’ T010 â†’ T021 â†’ T033
Database â†’ invitationManager â†’ Tests â†’ Registration â†’ Contract Tests â†’ Integration
= 1 + 3 + 2 + 2 + 2 + 3 = 13 hours (critical path)
```

With parallelization, total wall-clock time: ~20-25 hours (3-4 working days)

---

## Validation Checklist

Before marking feature complete, verify:

### Constitutional Compliance
- [ ] **Principle I (Library-First)**: invitationManager, notificationManager are standalone libraries
- [ ] **Principle II (Test-First)**: All tests written and passing (>80% coverage)
- [ ] **Principle III (Contract-First)**: OpenAPI contracts defined and validated
- [ ] **Principle VI (Git Approval)**: No automatic git operations performed
- [ ] **Principle VII (Observability)**: All operations logged for audit trail

### Functional Requirements
- [ ] All 21 functional requirements from spec.md met
- [ ] All 6 acceptance scenarios from quickstart.md pass
- [ ] All edge cases handled (11 edge cases from spec.md)

### Non-Functional Requirements
- [ ] Account creation <3 seconds (NFR-004)
- [ ] Email delivery <5 minutes (NFR-005)
- [ ] Token validation <200ms p95
- [ ] WCAG 2.1 AA accessibility compliance (NFR-008)

### Security Requirements
- [ ] Tokens hashed in database (SHA-256)
- [ ] Rate limiting enforced (5 invitations/hour per user)
- [ ] Input validation on all endpoints
- [ ] No email enumeration vulnerability
- [ ] SQL injection prevention (parameterized queries)

### Documentation
- [ ] CLAUDE.md updated with new endpoints
- [ ] API contracts documented (OpenAPI)
- [ ] README.md includes invitation feature overview
- [ ] Quickstart.md test scenarios verified

---

**Task Generation Complete**: Ready for implementation ðŸš€

**Next Step**: Execute tasks in dependency order following TDD workflow

**Generated by**: tasks-agent (Constitutional Principle X)
**Date**: 2025-11-25
**Constitution Version**: v2.0.0
