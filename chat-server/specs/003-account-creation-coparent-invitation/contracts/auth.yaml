openapi: 3.1.0
info:
  title: LiaiZen Authentication API (Extended)
  description: User registration with co-parent invitation step
  version: 1.0.0
  contact:
    name: LiaiZen API Support
    email: info@liaizen.com

servers:
  - url: https://demo-production-6dcd.up.railway.app
    description: Production server
  - url: http://localhost:8080
    description: Local development server

paths:
  /api/auth/register:
    post:
      summary: Register new user account (with invitation step)
      description: |
        Creates a new user account and immediately requires invitation of co-parent.
        This is a mandatory step in the onboarding flow (not optional).

        **Flow**:
        1. User provides email, password, and name
        2. System creates account and logs user in
        3. User MUST invite co-parent before accessing other features
        4. Co-parent invitation sent via email (new user) or in-app notification (existing user)

        **MVP Constraints**:
        - One co-parent only (rooms limited to 2 members)
        - Invitation is required (cannot be skipped)
      operationId: registerUser
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - firstName
                - coParentEmail
              properties:
                email:
                  type: string
                  format: email
                  description: User's email address (must be unique)
                  example: parent1@example.com
                password:
                  type: string
                  format: password
                  description: Password (min 8 chars, 1 uppercase, 1 number)
                  example: Password123
                  minLength: 8
                firstName:
                  type: string
                  description: User's first name
                  example: John
                  minLength: 1
                  maxLength: 50
                lastName:
                  type: string
                  description: User's last name (optional)
                  example: Smith
                  maxLength: 50
                coParentEmail:
                  type: string
                  format: email
                  description: Co-parent's email address (REQUIRED for invitation)
                  example: parent2@example.com
            examples:
              newUser:
                summary: New user registration
                value:
                  email: parent1@example.com
                  password: Password123
                  firstName: John
                  lastName: Smith
                  coParentEmail: parent2@example.com
      responses:
        '201':
          description: User created successfully, invitation sent
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - message
                  - user
                  - token
                  - invitation
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Account created. Invitation sent to co-parent.
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    description: JWT authentication token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  invitation:
                    $ref: '#/components/schemas/InvitationStatus'
              examples:
                successResponse:
                  value:
                    success: true
                    message: Account created. Invitation sent to co-parent.
                    user:
                      id: 1
                      username: parent1
                      email: parent1@example.com
                      firstName: John
                      lastName: Smith
                      createdAt: '2025-11-25T10:00:00Z'
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    invitation:
                      invitationId: 123
                      inviteeEmail: parent2@example.com
                      status: pending
                      expiresAt: '2025-12-02T10:00:00Z'
                      deliveryMethod: email
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidEmail:
                  summary: Invalid email format
                  value:
                    error: Invalid email format
                    code: INVALID_EMAIL
                duplicateEmail:
                  summary: Email already registered
                  value:
                    error: Email already exists
                    code: DUPLICATE_EMAIL
                weakPassword:
                  summary: Password doesn't meet requirements
                  value:
                    error: Password must be at least 8 characters with 1 uppercase and 1 number
                    code: WEAK_PASSWORD
                selfInvite:
                  summary: User trying to invite themselves
                  value:
                    error: You cannot invite yourself
                    code: SELF_INVITE
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                rateLimitExceeded:
                  value:
                    error: Too many registration attempts. Please try again later.
                    code: RATE_LIMIT_EXCEEDED
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                serverError:
                  value:
                    error: Internal server error
                    code: INTERNAL_ERROR

  /api/auth/login:
    post:
      summary: Login existing user
      description: Authenticate user with email and password (existing endpoint - no changes)
      operationId: loginUser
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: parent1@example.com
                password:
                  type: string
                  format: password
                  example: Password123
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                required:
                  - success
                  - user
                  - token
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidCredentials:
                  value:
                    error: Invalid email or password
                    code: INVALID_CREDENTIALS

components:
  schemas:
    User:
      type: object
      required:
        - id
        - username
        - email
        - createdAt
      properties:
        id:
          type: integer
          description: Unique user identifier
          example: 1
        username:
          type: string
          description: Auto-generated username from email
          example: parent1
        email:
          type: string
          format: email
          description: User's email address
          example: parent1@example.com
        firstName:
          type: string
          description: User's first name
          example: John
        lastName:
          type: string
          description: User's last name
          example: Smith
        createdAt:
          type: string
          format: date-time
          description: Account creation timestamp
          example: '2025-11-25T10:00:00Z'
        lastLogin:
          type: string
          format: date-time
          description: Last login timestamp
          example: '2025-11-25T10:00:00Z'

    InvitationStatus:
      type: object
      required:
        - invitationId
        - inviteeEmail
        - status
        - expiresAt
        - deliveryMethod
      properties:
        invitationId:
          type: integer
          description: Unique invitation identifier
          example: 123
        inviteeEmail:
          type: string
          format: email
          description: Email address of invited co-parent
          example: parent2@example.com
        status:
          type: string
          enum: [pending, accepted, expired, cancelled]
          description: Current invitation status
          example: pending
        expiresAt:
          type: string
          format: date-time
          description: When invitation expires (7 days from creation)
          example: '2025-12-02T10:00:00Z'
        deliveryMethod:
          type: string
          enum: [email, in_app_notification]
          description: How invitation was delivered
          example: email

    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Invalid email format
        code:
          type: string
          description: Machine-readable error code
          example: INVALID_EMAIL

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token returned from /api/auth/login or /api/auth/register

security: []
