#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Secret detection - MUST pass before commit
echo "ğŸ” Scanning for secrets..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | xargs npx secretlint
  if [ $? -ne 0 ]; then
    echo "âŒ Secret detected! Remove secrets before committing."
    echo "   If false positive, add to .secretlintignore"
    exit 1
  fi
  echo "âœ… No secrets detected"
fi

# Run lint-staged to check only staged files
npx lint-staged

# Check for naming convention violations in staged files
echo "ğŸ” Checking naming conventions..."
STAGED_JS=$(git diff --cached --name-only | grep -E '\.(js|jsx)$' || true)

if [ -n "$STAGED_JS" ]; then
  # Check for fetch*/lookup* function names (should be get*)
  if echo "$STAGED_JS" | xargs grep -E 'function\s+fetch[A-Z]|function\s+lookup[A-Z]' 2>/dev/null | grep -v 'Deprecated'; then
    echo "âŒ Error: Found fetch*/lookup* function names. Use get* instead."
    echo "   See CLAUDE.md 'Function Naming Standards' section."
    exit 1
  fi

  # Check for "Error fetching" messages (should be "Error getting")
  if echo "$STAGED_JS" | xargs grep -i 'Error fetching' 2>/dev/null | grep -v 'Deprecated'; then
    echo "âš ï¸  Warning: Found 'Error fetching' messages. Use 'Error getting' instead."
  fi
fi

# Check for console.log and debugger statements (warn only)
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -E '(console\.(log|warn|error|debug)|debugger)' 2>/dev/null; then
  echo "âš ï¸  Warning: Found console.log or debugger statements. Consider removing them before committing."
  echo "   (This is a warning, not a blocker)"
fi

# Check for TODO/FIXME comments (warn only)
if git diff --cached --name-only | grep -E '\.(js|jsx|ts|tsx)$' | xargs grep -E '(TODO|FIXME|XXX|HACK)' 2>/dev/null; then
  echo "âš ï¸  Warning: Found TODO/FIXME comments. Ensure they're tracked in issues."
  echo "   (This is a warning, not a blocker)"
fi

# Contract analysis (warn only - doesn't block commit)
# Only run if contract analysis tool is available
if [ -f "chat-server/tools/analyze_contracts.py" ] && [ -d "chat-server/.venv" ]; then
  echo "ğŸ” Running contract analysis (warning only)..."
  cd chat-server
  ./tools/analyze --quiet 2>&1 | grep -E "(âš ï¸|âŒ|violations|issues)" || true
  cd ..
  echo "ğŸ’¡ Fix contract violations before pushing (run: ./tools/analyze-contracts)"
fi






























