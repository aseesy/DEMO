#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-push checks..."

# Run tests for backend
if [ -d "chat-server" ]; then
  echo "üì¶ Running backend tests..."
  cd chat-server
  npm test -- --passWithNoTests || {
    echo "‚ùå Backend tests failed. Please fix before pushing."
    exit 1
  }
  cd ..
fi

# Run tests for frontend
if [ -d "chat-client-vite" ]; then
  echo "üì¶ Running frontend tests..."
  cd chat-client-vite
  npm test -- --run || {
    echo "‚ùå Frontend tests failed. Please fix before pushing."
    exit 1
  }
  cd ..
fi

# Quick export verification (fast check before full build)
if [ -d "chat-client-vite" ]; then
  echo "üîó Verifying critical exports..."

  # Check useModalControllerDefault export matches import
  if grep -q "useModalControllerDefault" chat-client-vite/src/hooks/useDashboard.js 2>/dev/null; then
    if ! grep -q "export.*useModalControllerDefault" chat-client-vite/src/hooks/useModalController.js 2>/dev/null; then
      echo "‚ùå FATAL: useDashboard imports useModalControllerDefault but useModalController doesn't export it"
      exit 1
    fi
  fi

  # Check getRegisteredModals export matches import
  if grep -q "getRegisteredModals" chat-client-vite/src/hooks/useModalController.js 2>/dev/null; then
    if ! grep -q "export.*getRegisteredModals" chat-client-vite/src/hooks/modalRegistry.js 2>/dev/null; then
      echo "‚ùå FATAL: useModalController imports getRegisteredModals but modalRegistry doesn't export it"
      exit 1
    fi
  fi

  echo "‚úÖ Critical exports verified"
fi

# Contract & Architecture Analysis
# Ensures no cross-layer imports and API contracts are valid
if [ -f "chat-server/tools/analyze_contracts.py" ] && [ -d "chat-server/.venv" ]; then
  echo "üîç Running contract & architecture analysis..."
  cd chat-server
  
  # Run contract analysis
  if ./tools/analyze --quiet 2>&1 | grep -qE "(‚ùå|violations.*[1-9]|issues.*[1-9])"; then
    echo "‚ùå Contract analysis found violations!"
    echo "   Run: ./tools/analyze-contracts to see details"
    echo "   Or: cd chat-server && ./tools/analyze"
    exit 1
  fi
  echo "‚úÖ Contract analysis passed"
  
  # Run architecture analysis (check for errors only - circular deps, forbidden imports)
  if [ -f "tools/analyze_architecture.py" ]; then
    echo "üèóÔ∏è  Running architecture analysis..."
    
    # Run analysis and capture output
    ARCH_OUTPUT=$(./tools/analyze-architecture --quiet 2>&1)
    ARCH_EXIT=$?
    
    # Check JSON report for errors (more reliable than parsing output)
    if [ -f "../reports/architecture_analysis.json" ]; then
      # Count errors (severity == "error")
      ERROR_COUNT=$(python3 -c "
import json
try:
    with open('../reports/architecture_analysis.json') as f:
        data = json.load(f)
    errors = [i for i in data.get('dependency_issues', []) if i.get('severity') == 'error']
    print(len(errors))
except:
    print(0)
" 2>/dev/null || echo "0")
      
      if [ "$ERROR_COUNT" -gt 0 ]; then
        echo "‚ùå Architecture analysis found $ERROR_COUNT error(s)!"
        echo "   Issues: Circular dependencies or forbidden imports"
        echo "   Run: ./tools/analyze-architecture to see details"
        echo "   Or: cd chat-server && npm run analyze:architecture"
        exit 1
      fi
    fi
    
    # Also check exit code as fallback
    if [ $ARCH_EXIT -ne 0 ]; then
      echo "‚ùå Architecture analysis failed!"
      echo "   Run: ./tools/analyze-architecture to see details"
      exit 1
    fi
    
    # Show warnings if any (but don't block)
    if echo "$ARCH_OUTPUT" | grep -qE "(‚ö†Ô∏è|warning)"; then
      echo "‚ö†Ô∏è  Architecture analysis found warnings (not blocking)"
      echo "   Review: cd chat-server && npm run analyze:architecture"
    else
      echo "‚úÖ Architecture analysis passed"
    fi
  fi
  
  cd ..
fi

# CRITICAL: Run production build to catch missing exports/imports
# This catches issues that tests miss but would fail on Vercel
if [ -d "chat-client-vite" ]; then
  echo "üèóÔ∏è  Running production build verification..."
  cd chat-client-vite
  npm run build 2>&1 | tail -5 || {
    echo "‚ùå Production build failed. This would fail on Vercel."
    echo "   Fix build errors before pushing."
    exit 1
  }
  echo "‚úÖ Production build succeeded"
  cd ..
fi

echo "‚úÖ All pre-push checks passed!"






























