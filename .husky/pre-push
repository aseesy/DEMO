#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-push checks..."

# Run tests for backend
if [ -d "chat-server" ]; then
  echo "üì¶ Running backend tests..."
  cd chat-server
  npm test -- --passWithNoTests || {
    echo "‚ùå Backend tests failed. Please fix before pushing."
    exit 1
  }
  cd ..
fi

# Run tests for frontend
if [ -d "chat-client-vite" ]; then
  echo "üì¶ Running frontend tests..."
  cd chat-client-vite
  npm test -- --run || {
    echo "‚ùå Frontend tests failed. Please fix before pushing."
    exit 1
  }
  cd ..
fi

# Quick export verification (fast check before full build)
if [ -d "chat-client-vite" ]; then
  echo "üîó Verifying critical exports..."

  # Check useModalControllerDefault export matches import
  if grep -q "useModalControllerDefault" chat-client-vite/src/hooks/useDashboard.js 2>/dev/null; then
    if ! grep -q "export.*useModalControllerDefault" chat-client-vite/src/hooks/useModalController.js 2>/dev/null; then
      echo "‚ùå FATAL: useDashboard imports useModalControllerDefault but useModalController doesn't export it"
      exit 1
    fi
  fi

  # Check getRegisteredModals export matches import
  if grep -q "getRegisteredModals" chat-client-vite/src/hooks/useModalController.js 2>/dev/null; then
    if ! grep -q "export.*getRegisteredModals" chat-client-vite/src/hooks/modalRegistry.js 2>/dev/null; then
      echo "‚ùå FATAL: useModalController imports getRegisteredModals but modalRegistry doesn't export it"
      exit 1
    fi
  fi

  echo "‚úÖ Critical exports verified"
fi

# CRITICAL: Run production build to catch missing exports/imports
# This catches issues that tests miss but would fail on Vercel
if [ -d "chat-client-vite" ]; then
  echo "üèóÔ∏è  Running production build verification..."
  cd chat-client-vite
  npm run build 2>&1 | tail -5 || {
    echo "‚ùå Production build failed. This would fail on Vercel."
    echo "   Fix build errors before pushing."
    exit 1
  }
  echo "‚úÖ Production build succeeded"
  cd ..
fi

echo "‚úÖ All pre-push checks passed!"


























