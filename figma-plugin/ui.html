<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LiaiZen Design Sync</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      background: #fff;
      padding: 12px;
    }

    .header {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .header h1 {
      font-size: 14px;
      font-weight: 600;
      color: #275559;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 11px;
      color: #666;
    }

    .section {
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    button {
      width: 100%;
      padding: 10px 16px;
      background: #275559;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 8px;
    }

    button:hover {
      background: #1f4447;
    }

    button:active {
      transform: scale(0.98);
    }

    button.secondary {
      background: #4DA8B0;
    }

    button.secondary:hover {
      background: #3d8a92;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .input-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: #666;
      margin-bottom: 4px;
    }

    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    input:focus {
      outline: none;
      border-color: #275559;
    }

    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 11px;
    }

    .status.success {
      background: #e6f7f5;
      color: #275559;
      border: 1px solid #c5e8e4;
    }

    .status.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .status.info {
      background: #eff6ff;
      color: #2563eb;
      border: 1px solid #bfdbfe;
    }

    .file-info {
      background: #f9fafb;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 11px;
      border: 1px solid #e5e7eb;
    }

    .file-info-item {
      margin-bottom: 4px;
    }

    .file-info-label {
      font-weight: 500;
      color: #666;
    }

    .tokens-preview {
      background: #f9fafb;
      padding: 10px;
      border-radius: 4px;
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 10px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      border: 1px solid #e5e7eb;
    }

    .loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #275559;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé® LiaiZen Design Sync</h1>
    <p>Sync design tokens and components with your codebase</p>
  </div>

  <div id="fileInfo" class="file-info">
    <div class="file-info-item">
      <span class="file-info-label">Loading file info...</span>
    </div>
  </div>

  <div id="status"></div>

  <div class="section">
    <div class="section-title">‚ú® Create Design System</div>
    <button onclick="createDesignSystem()" style="background: #10b981; font-size: 13px; font-weight: 600;">
      üé® Create LiaiZen Design System
    </button>
    <p style="font-size: 10px; color: #666; margin-top: 4px; line-height: 1.4;">
      Automatically creates all color styles, text styles, and effects from the LiaiZen design tokens
    </p>
  </div>

  <div class="section">
    <div class="section-title">üìê Sync from Codebase</div>
    <button onclick="syncFromCode('wireframes')" style="background: #3b82f6; font-size: 13px; font-weight: 600;">
      üîÑ Sync Wireframes
    </button>
    <button onclick="syncFromCode('design')" style="background: #10b981; font-size: 13px; font-weight: 600; margin-top: 8px;">
      üé® Sync Design Pages (Styled)
    </button>
    <button class="secondary" onclick="fetchComponents()" style="margin-top: 8px;">
      View Available Components
    </button>
    <p style="font-size: 10px; color: #666; margin-top: 4px; line-height: 1.4;">
      Wireframes: Structure only | Design Pages: Full styling with colors and typography
    </p>
    <div id="componentsList" class="file-info hidden" style="margin-top: 12px; max-height: 150px; overflow-y: auto;"></div>
  </div>

  <div class="section">
    <div class="section-title">Backend API</div>
    <div class="input-group">
      <label for="apiUrl">API URL</label>
      <input
        type="text"
        id="apiUrl"
        value="http://localhost:3001"
        placeholder="http://localhost:3001"
      />
      <button class="secondary" onclick="setApiUrl()">Update API URL</button>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Design Tokens</div>
    <button onclick="extractTokens()">Extract Design Tokens</button>
    <button class="secondary" onclick="syncTokens()">Sync to Backend</button>
    <div id="tokensPreview" class="tokens-preview hidden"></div>
  </div>

  <div class="section">
    <div class="section-title">Components</div>
    <button onclick="exportSelected()">Export Selected Component</button>
  </div>

  <script>
    let apiUrl = 'http://localhost:3001';
    let fileKey = null;

    // Listen for messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;

      switch (msg.type) {
        case 'file-info':
          displayFileInfo(msg.info);
          fileKey = msg.info.fileKey;
          break;

        case 'design-system-created':
          showStatus(msg.message, 'success');
          console.log('Design system stats:', msg.stats);
          break;

        case 'sync-started':
          showStatus('Syncing components from codebase...', 'info');
          break;

        case 'sync-complete':
          showStatus(msg.message, 'success');
          console.log('Synced components:', msg.components);
          break;

        case 'components-fetched':
          displayComponentsList(msg.components);
          showStatus(`Found ${msg.count} components`, 'success');
          break;

        case 'tokens-extracted':
          displayTokens(msg.tokens);
          showStatus('Tokens extracted successfully!', 'success');
          break;

        case 'sync-started':
          showStatus('Syncing tokens to backend...', 'info');
          syncTokensToBackend(msg.tokens || getExtractedTokens());
          break;

        case 'component-exported':
          showStatus('Component exported successfully!', 'success');
          console.log('Component:', msg.component);
          break;

        case 'error':
          showStatus(`Error: ${msg.message}`, 'error');
          break;

        case 'api-url-set':
          showStatus('API URL updated', 'success');
          break;
      }
    };

    function displayFileInfo(info) {
      const fileInfoDiv = document.getElementById('fileInfo');
      fileInfoDiv.innerHTML = `
        <div class="file-info-item">
          <span class="file-info-label">File:</span> ${info.fileName}
        </div>
        <div class="file-info-item">
          <span class="file-info-label">File Key:</span> ${info.fileKey}
        </div>
        <div class="file-info-item">
          <span class="file-info-label">Styles:</span> ${info.styles.colors} colors, ${info.styles.text} text styles
        </div>
      `;
    }

    function createDesignSystem() {
      showStatus('Creating LiaiZen Design System...', 'info');
      parent.postMessage({ pluginMessage: { type: 'create-design-system' } }, '*');
    }

    let currentPageType = 'wireframes';

    function syncFromCode(pageType = 'wireframes') {
      currentPageType = pageType;
      const typeName = pageType === 'design' ? 'design pages' : 'wireframes';
      showStatus(`Fetching components and generating ${typeName}...`, 'info');
      parent.postMessage({ 
        pluginMessage: { 
          type: 'sync-from-code',
          pageType: pageType
        } 
      }, '*');
    }

    function fetchComponents() {
      showStatus('Scanning codebase...', 'info');
      parent.postMessage({ pluginMessage: { type: 'fetch-components' } }, '*');
    }

    function displayComponentsList(components) {
      const listDiv = document.getElementById('componentsList');
      if (!components || components.length === 0) {
        listDiv.innerHTML = '<div style="font-size: 11px; color: #666;">No components found</div>';
        listDiv.classList.remove('hidden');
        return;
      }

      const listHtml = components.map(c => `
        <div style="font-size: 11px; margin-bottom: 4px; padding: 4px; background: #f3f4f6; border-radius: 4px;">
          <strong>${c.name}</strong> <span style="color: #9ca3af;">(${c.category})</span>
        </div>
      `).join('');

      listDiv.innerHTML = `
        <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #374151;">Available Components:</div>
        ${listHtml}
      `;
      listDiv.classList.remove('hidden');
    }

    function extractTokens() {
      showStatus('Extracting design tokens...', 'info');
      parent.postMessage({ pluginMessage: { type: 'extract-tokens' } }, '*');
    }

    function syncTokens() {
      showStatus('Starting sync...', 'info');
      parent.postMessage({ pluginMessage: { type: 'sync-tokens' } }, '*');
    }

    function displayTokens(tokens) {
      const preview = document.getElementById('tokensPreview');
      preview.textContent = JSON.stringify(tokens, null, 2);
      preview.classList.remove('hidden');
    }

    function getExtractedTokens() {
      const preview = document.getElementById('tokensPreview');
      if (preview.textContent) {
        return JSON.parse(preview.textContent);
      }
      return null;
    }

    async function syncTokensToBackend(tokens) {
      if (!tokens) {
        showStatus('No tokens to sync. Extract tokens first.', 'error');
        return;
      }

      try {
        const response = await fetch(`${apiUrl}/api/figma/sync-tokens`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            fileKey: fileKey,
            tokens: tokens
          })
        });

        if (response.ok) {
          showStatus('Tokens synced successfully!', 'success');
        } else {
          const error = await response.json();
          showStatus(`Sync failed: ${error.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        showStatus(`Sync error: ${error.message}`, 'error');
      }
    }

    function exportSelected() {
      showStatus('Exporting selected component...', 'info');
      parent.postMessage({ 
        pluginMessage: { 
          type: 'export-component'
        } 
      }, '*');
    }

    function setApiUrl() {
      const input = document.getElementById('apiUrl');
      apiUrl = input.value;
      parent.postMessage({ 
        pluginMessage: { 
          type: 'set-api-url',
          url: apiUrl
        } 
      }, '*');
    }

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');

      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 3000);
      }
    }

    // Initialize API URL from input
    document.getElementById('apiUrl').addEventListener('change', (e) => {
      apiUrl = e.target.value;
    });
  </script>
</body>
</html>

