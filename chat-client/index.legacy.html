<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <!-- Primary Meta Tags -->
  <title>LiaiZen - Better Co-Parenting Through Better Communication | AI-Powered Mediation</title>
  <meta name="title" content="LiaiZen - Better Co-Parenting Through Better Communication | AI-Powered Mediation">
  <meta name="description" content="LiaiZen helps separated parents communicate effectively with AI-powered mediation and tools designed to improve outcomes for you and your children. Start your free trial today.">
  <meta name="keywords" content="co-parenting, separated parents, parenting communication, AI mediation, conflict resolution, shared custody, parenting tools, family communication">
  <meta name="author" content="LiaiZen">
  <meta name="robots" content="index, follow">
  <meta name="language" content="English">
  <meta name="theme-color" content="#275559">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://coparentliaizen.com/">
  <meta property="og:title" content="LiaiZen - Better Co-Parenting Through Better Communication">
  <meta property="og:description" content="AI-powered mediation and communication tools designed to improve outcomes for separated parents and their children.">
  <meta property="og:image" content="https://coparentliaizen.com/icon-512.png">
  <meta property="og:site_name" content="LiaiZen">
  <meta property="og:locale" content="en_US">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://coparentliaizen.com/">
  <meta name="twitter:title" content="LiaiZen - Better Co-Parenting Through Better Communication">
  <meta name="twitter:description" content="AI-powered mediation and communication tools designed to improve outcomes for separated parents and their children.">
  <meta name="twitter:image" content="https://coparentliaizen.com/icon-512.png">
  
  <!-- Apple / iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="LiaiZen">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://coparentliaizen.com/">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fallback styles if Tailwind fails to load -->
  <style>
    /* Basic fallback styles - ensures content is visible even if Tailwind fails */
    * { box-sizing: border-box; }
    html, body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 0; 
      overflow-x: hidden; /* Prevent horizontal scrolling */
      width: 100%;
      max-width: 100vw;
    }
    .min-h-screen { min-height: 100vh; }
    .bg-gradient-to-br { background: linear-gradient(to bottom right, #f0fdfa, #ffffff, #eff6ff); }
    .bg-white { background-color: white; }
    .bg-gray-900 { background-color: #111827; }
    .text-white { color: white !important; }
    .text-gray-900 { color: #111827; }
    .text-gray-600 { color: #4b5563; }
    .text-primary { color: #275559; }
    .max-w-7xl { max-width: 1280px; }
    .max-w-4xl { max-width: 56rem; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-20 { padding-top: 5rem; padding-bottom: 5rem; }
    .py-12 { padding-top: 3rem; padding-bottom: 3rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mb-12 { margin-bottom: 3rem; }
    .text-center { text-align: center; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
    .text-5xl { font-size: 3rem; line-height: 1; }
    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .bg-primary { background-color: #275559 !important; }
    .from-primary { background-color: #275559; }
    .to-secondary { background-color: #4DA8B0; }
    /* Benefits section gradient - handle multiple class combinations */
    .bg-gradient-to-br.from-primary.to-secondary,
    section.bg-gradient-to-br.from-primary,
    [class*="bg-gradient-to-br"][class*="from-primary"][class*="to-secondary"] { 
      background: linear-gradient(to bottom right, #275559, #4DA8B0) !important; 
    }
    /* Ensure text is visible on gradient background */
    section[class*="from-primary"] .text-white,
    section[class*="from-primary"] h2,
    section[class*="from-primary"] h3,
    section[class*="from-primary"] p {
      color: white !important;
    }
    .text-white.text-opacity-90 { color: rgba(255, 255, 255, 0.9) !important; }
    .bg-white.bg-opacity-20 { background-color: rgba(255, 255, 255, 0.2) !important; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-full { border-radius: 9999px; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .px-8 { padding-left: 2rem; padding-right: 2rem; }
    .px-10 { padding-left: 2.5rem; padding-right: 2.5rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .p-6 { padding: 1.5rem; }
    .w-10 { width: 2.5rem; }
    .h-10 { height: 2.5rem; }
    .w-12 { width: 3rem; }
    .h-12 { height: 3rem; }
    .w-16 { width: 4rem; }
    .h-16 { height: 4rem; }
    .w-8 { width: 2rem; }
    .h-8 { height: 2rem; }
    .h-16 { height: 4rem; }
    button { cursor: pointer; border: none; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .flex-shrink-0 { flex-shrink: 0; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .grid { display: grid; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .gap-8 { gap: 2rem; }
    .block { display: block; }
    .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    .border-2 { border-width: 2px; }
    .border-primary { border-color: #275559; }
    .border-gray-300 { border-color: #d1d5db; }
    .border-gray-800 { border-color: #1f2937; }
    .border-t { border-top-width: 1px; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-2xl { border-radius: 1rem; }
    .hover\\:bg-primary-dark:hover { background-color: #1e3d40; }
    .hover\\:text-white:hover { color: white; }
    .hover\\:text-primary-dark:hover { color: #1e3d40; }
    .transition-colors { transition-property: color, background-color, border-color; transition-duration: 150ms; }
    section { display: block; }
    article { display: block; }
    @media (min-width: 640px) {
      .sm\\:px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
      .sm\\:flex-row { flex-direction: row; }
    }
    @media (min-width: 768px) {
      .md\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .md\\:text-6xl { font-size: 3.75rem; line-height: 1; }
    }
    @media (min-width: 1024px) {
      .lg\\:px-8 { padding-left: 2rem; padding-right: 2rem; }
    }
  </style>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Socket.io Client -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  
  <!-- API Configuration - Must be loaded before other scripts -->
  <script src="/config.js"></script>
  
  <!-- Structured Data (JSON-LD) for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "LiaiZen",
    "applicationCategory": "CommunicationApplication",
    "operatingSystem": "Web, iOS, Android",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "ratingCount": "150"
    },
    "description": "AI-powered co-parenting communication platform designed to improve outcomes for separated parents and their children.",
    "url": "https://coparentliaizen.com",
    "author": {
      "@type": "Organization",
      "name": "LiaiZen"
    },
    "featureList": [
      "AI-Powered Mediation",
      "Real-time Communication",
      "Shared Calendar",
      "Expense Tracking",
      "Document Sharing",
      "Conflict Resolution Tools"
    ]
  }
  </script>
  
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background-color: #f8f9fa;
    }
    
    @keyframes slide-down {
      from {
        transform: translate(-50%, -100%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }
    
    .animate-slide-down {
      animation: slide-down 0.3s ease-out;
    }
    
    /* Logo Color Palette - Only colors from Bird of Paradise logo */
    /* Orange (from logo petals) */
    .bg-orange {
      background-color: #FF8C42;
    }
    
    .bg-orange-light {
      background-color: #FFB88C;
    }
    
    .text-orange {
      color: #FF6B35;
    }
    
    .border-orange {
      border-color: #FF8C42;
    }
    
    /* Blue (from logo blue petals) */
    .bg-blue {
      background-color: #87CEEB;
    }
    
    .bg-blue-light {
      background-color: #B8E3F0;
    }
    
    .bg-blue-dark {
      background-color: #4169E1;
    }
    
    .text-blue {
      color: #4169E1;
    }
    
    .text-blue-light {
      color: #87CEEB;
    }
    
    .border-blue {
      border-color: #87CEEB;
    }
    
    /* Teal (from logo stem and leaves) */
    .bg-teal {
      background-color: #4DA8B0;
    }
    
    .bg-teal-light {
      background-color: #7BC4CA;
    }
    
    .bg-teal-dark {
      background-color: #3A7D85;
    }
    
    .text-teal {
      color: #3A7D85;
    }
    
    .border-teal {
      border-color: #4DA8B0;
    }
    
    /* Green (from logo sheath) */
    .bg-green {
      background-color: #90EE90;
    }
    
    .bg-green-light {
      background-color: #C8F6C8;
    }
    
    .bg-green-dark {
      background-color: #66CDAA;
    }
    
    .text-green {
      color: #66CDAA;
    }
    
    .border-green {
      border-color: #90EE90;
    }
    
    /* Pink (from logo stem) */
    .bg-pink {
      background-color: #FFB6C1;
    }
    
    .bg-pink-light {
      background-color: #FFD9E0;
    }
    
    .bg-pink-dark {
      background-color: #FF69B4;
    }
    
    .text-pink {
      color: #FF69B4;
    }
    
    .border-pink {
      border-color: #FFB6C1;
    }
    
    /* Primary brand color */
    .bg-primary {
      background-color: #275559;
    }
    
    .bg-primary:hover {
      background-color: #1e3f42;
    }
    
    .text-primary {
      color: #275559;
    }
    
    .border-primary {
      border-color: #275559;
    }
    
    /* Primary action color - using orange from logo (for legacy support) */
    .bg-primary-orange {
      background-color: #FF8C42;
    }
    
    .bg-primary-orange:hover {
      background-color: #FF6B35;
    }
    
    .text-primary-orange {
      color: #FF6B35;
    }
    
    /* Text colors using logo dark blue */
    .text-dark {
      color: #4169E1;
    }
    
    /* Neumorphic shadows */
    .shadow-neumorphic {
      box-shadow: 
        8px 8px 16px rgba(0, 0, 0, 0.08),
        -8px -8px 16px rgba(255, 255, 255, 0.9);
    }
    
    .shadow-neumorphic-inset {
      box-shadow: 
        inset 4px 4px 8px rgba(0, 0, 0, 0.08),
        inset -4px -4px 8px rgba(255, 255, 255, 0.9);
    }
    
    .shadow-soft {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    .shadow-soft-lg {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    
    /* Neumorphic card style */
    .card-neumorphic {
      background-color: #ffffff;
      border-radius: 24px;
      box-shadow: 
        8px 8px 16px rgba(0, 0, 0, 0.08),
        -8px -8px 16px rgba(255, 255, 255, 0.9);
    }
    
    /* Soft text colors */
    .text-soft-dark {
      color: #2d3748;
    }
    
    .text-soft-gray {
      color: #718096;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    // Lucide React icons as components
    function Send(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      }, 
        React.createElement('path', { d: "m22 2-7 20-4-9-9-4Z" }),
        React.createElement('path', { d: "M22 2 11 13" })
      );
    }

    function Users(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('path', { d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" }),
        React.createElement('circle', { cx: "9", cy: "7", r: "4" }),
        React.createElement('path', { d: "M22 21v-2a4 4 0 0 0-3-3.87" }),
        React.createElement('path', { d: "M16 3.13a4 4 0 0 1 0 7.75" })
      );
    }

    function MessageCircle(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('path', { d: "M7.9 20A9 9 0 1 0 4 16.1L2 22Z" })
      );
    }

    function AlertCircle(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('circle', { cx: "12", cy: "12", r: "10" }),
        React.createElement('line', { x1: "12", x2: "12", y1: "8", y2: "12" }),
        React.createElement('line', { x1: "12", x2: "12.01", y1: "16", y2: "16" })
      );
    }

    // Bird of Paradise Logo Component
    function BirdOfParadiseLogo(props) {
      const { width = 40, height = 40, ...rest } = props;
      return React.createElement('svg', {
        ...rest,
        width: width,
        height: height,
        viewBox: "0 0 120 140",
        xmlns: "http://www.w3.org/2000/svg"
      },
        React.createElement('defs', null,
          React.createElement('linearGradient', { id: 'orangeGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#FF8C42', stopOpacity: 1 }),
            React.createElement('stop', { offset: '100%', stopColor: '#FF6B35', stopOpacity: 1 })
          ),
          React.createElement('linearGradient', { id: 'blueGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#87CEEB', stopOpacity: 1 }),
            React.createElement('stop', { offset: '100%', stopColor: '#4169E1', stopOpacity: 1 })
          ),
          React.createElement('linearGradient', { id: 'tealGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#40E0D0', stopOpacity: 1 }),
            React.createElement('stop', { offset: '100%', stopColor: '#20B2AA', stopOpacity: 1 })
          ),
          React.createElement('linearGradient', { id: 'greenGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#90EE90', stopOpacity: 1 }),
            React.createElement('stop', { offset: '100%', stopColor: '#66CDAA', stopOpacity: 1 })
          ),
          React.createElement('linearGradient', { id: 'pinkGrad', x1: '0%', y1: '0%', x2: '0%', y2: '100%' },
            React.createElement('stop', { offset: '0%', stopColor: '#FFB6C1', stopOpacity: 1 }),
            React.createElement('stop', { offset: '100%', stopColor: '#FF69B4', stopOpacity: 1 })
          )
        ),
        // Left orange petal
        React.createElement('ellipse', { cx: '50', cy: '25', rx: '18', ry: '35', fill: 'url(#orangeGrad)', transform: 'rotate(-15 50 25)' }),
        // Right orange petal
        React.createElement('ellipse', { cx: '70', cy: '25', rx: '18', ry: '35', fill: 'url(#orangeGrad)', transform: 'rotate(15 70 25)' }),
        // Green sheath
        React.createElement('ellipse', { cx: '60', cy: '50', rx: '25', ry: '15', fill: 'url(#greenGrad)' }),
        // Blue petals
        React.createElement('ellipse', { cx: '65', cy: '55', rx: '12', ry: '20', fill: 'url(#blueGrad)', transform: 'rotate(10 65 55)' }),
        React.createElement('ellipse', { cx: '75', cy: '55', rx: '12', ry: '20', fill: 'url(#blueGrad)', transform: 'rotate(-10 75 55)' }),
        // Pink stem section
        React.createElement('path', { d: 'M 60 65 Q 55 75 50 85', stroke: 'url(#pinkGrad)', strokeWidth: '8', fill: 'none', strokeLinecap: 'round' }),
        // Blue/teal stem
        React.createElement('path', { d: 'M 50 85 Q 45 100 40 115', stroke: 'url(#tealGrad)', strokeWidth: '8', fill: 'none', strokeLinecap: 'round' }),
        // Left leaf
        React.createElement('ellipse', { cx: '30', cy: '110', rx: '35', ry: '18', fill: 'url(#tealGrad)', transform: 'rotate(-30 30 110)' }),
        // Right leaf
        React.createElement('ellipse', { cx: '90', cy: '110', rx: '35', ry: '18', fill: 'url(#tealGrad)', transform: 'rotate(30 90 110)' }),
        // Small upper right leaf
        React.createElement('ellipse', { cx: '85', cy: '75', rx: '20', ry: '10', fill: 'url(#tealGrad)', transform: 'rotate(45 85 75)' })
      );
    }

    function Wifi(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('path', { d: "M12 20h.01" }),
        React.createElement('path', { d: "M2 8.82a15 15 0 0 1 20 0" }),
        React.createElement('path', { d: "M5 12.859a10 10 0 0 1 14 0" }),
        React.createElement('path', { d: "M8.5 16.429a5 5 0 0 1 7 0" })
      );
    }

    function WifiOff(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('path', { d: "M12 20h.01" }),
        React.createElement('path', { d: "M8.5 16.429a5 5 0 0 1 7 0" }),
        React.createElement('path', { d: "M5 12.859a10 10 0 0 1 5.17-2.69" }),
        React.createElement('path', { d: "M19 12.859a10 10 0 0 0-2.007-1.523" }),
        React.createElement('path', { d: "M2 8.82a15 15 0 0 1 4.177-2.643" }),
        React.createElement('path', { d: "M22 8.82a15 15 0 0 0-11.288-3.764" }),
        React.createElement('path', { d: "m2 2 20 20" })
      );
    }

    function Settings(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('path', { d: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" }),
        React.createElement('circle', { cx: "12", cy: "12", r: "3" })
      );
    }

    function User(props) {
      return React.createElement('svg', {
        ...props,
        xmlns: "http://www.w3.org/2000/svg",
        width: "24",
        height: "24",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round"
      },
        React.createElement('path', { d: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" }),
        React.createElement('circle', { cx: "12", cy: "7", r: "4" })
      );
    }

    // ChatRoom Component
    function ChatRoom() {
      const [username, setUsername] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [email, setEmail] = React.useState('');
      const [isLoginMode, setIsLoginMode] = React.useState(true);
      const [isAuthenticated, setIsAuthenticated] = React.useState(false);
      const [showLandingPage, setShowLandingPage] = React.useState(true);
      const [isCheckingAuth, setIsCheckingAuth] = React.useState(true); // Track auth check status
      const [isJoined, setIsJoined] = React.useState(false);
      const [messages, setMessages] = React.useState([]);
      const [inputMessage, setInputMessage] = React.useState('');
      const [activeUsers, setActiveUsers] = React.useState([]);
      const [isConnected, setIsConnected] = React.useState(false);
      const [error, setError] = React.useState('');
      const [typingUsers, setTypingUsers] = React.useState(new Set());
      const [messageSearch, setMessageSearch] = React.useState('');
      const [showSettings, setShowSettings] = React.useState(false);
      const [showUserMenu, setShowUserMenu] = React.useState(false);
      const [hasContext, setHasContext] = React.useState(false);
      const [showContextPrompt, setShowContextPrompt] = React.useState(false);
      const [isLoggingIn, setIsLoggingIn] = React.useState(false);
      const [isSigningUp, setIsSigningUp] = React.useState(false);
      const [isSavingContext, setIsSavingContext] = React.useState(false);
      const [connectionSuccess, setConnectionSuccess] = React.useState(false);
      const [userContextData, setUserContextData] = React.useState({
        coParentName: '',
        separationDate: '',
        children: [{ name: '', birthday: '' }],
        concerns: [],
        newPartner: { name: '', livesWith: false }
      });

      // Room and invite state
      const [roomInfo, setRoomInfo] = React.useState(null);
      const [showInviteModal, setShowInviteModal] = React.useState(false);
      const [inviteCode, setInviteCode] = React.useState('');
      const [isCreatingInvite, setIsCreatingInvite] = React.useState(false);
      const [copiedCode, setCopiedCode] = React.useState(false);
      const [showInviteAcceptModal, setShowInviteAcceptModal] = React.useState(false);
      const [pendingInviteCode, setPendingInviteCode] = React.useState(null);
      const [roomMembers, setRoomMembers] = React.useState([]);
      const [coparentName, setCoparentName] = React.useState('');
      const [contextInviteCode, setContextInviteCode] = React.useState('');
      const [isJoiningRoom, setIsJoiningRoom] = React.useState(false);
      const [contextInviteStatus, setContextInviteStatus] = React.useState(null);
      const [showJoinRoomModal, setShowJoinRoomModal] = React.useState(false);
      const [joinRoomCode, setJoinRoomCode] = React.useState('');
      const [joinRoomStatus, setJoinRoomStatus] = React.useState(null);
      const [isJoinRoomProcessing, setIsJoinRoomProcessing] = React.useState(false);
      const [showNoCoparentModal, setShowNoCoparentModal] = React.useState(false);
      const [isCheckingCoparent, setIsCheckingCoparent] = React.useState(false);
      const [notificationPermission, setNotificationPermission] = React.useState('default');
      const [showFlagModal, setShowFlagModal] = React.useState(false);
      const [flaggingMessageId, setFlaggingMessageId] = React.useState(null);
      const [flagReason, setFlagReason] = React.useState('');
      
      // Navigation state
      // Initialize currentView from localStorage or default to 'chat'
      const [currentView, setCurrentViewState] = React.useState(() => {
        const storedView = localStorage.getItem('currentView');
        return storedView && ['chat', 'dashboard', 'profile', 'contacts', 'account'].includes(storedView) ? storedView : 'chat';
      });
      
      // Wrapper to save view to localStorage when it changes
      const setCurrentView = (view) => {
        setCurrentViewState(view);
        currentViewRef.current = view;
        if (isAuthenticated) {
          localStorage.setItem('currentView', view);
        }
      };
      const [isInSharedRoom, setIsInSharedRoom] = React.useState(false);
      const [showDashboard, setShowDashboard] = React.useState(false);
      const [onboardingStatus, setOnboardingStatus] = React.useState({
        profileComplete: false,
        hasCoparent: false,
        isConnected: false,
        hasChildren: false,
        showDashboard: true
      });
      
      // Tasks state
      const [tasks, setTasks] = React.useState([]);
      const [isLoadingTasks, setIsLoadingTasks] = React.useState(false);
      const [taskSearch, setTaskSearch] = React.useState('');
      const [taskFilter, setTaskFilter] = React.useState('all'); // 'all', 'open', 'completed'
      const [showTaskForm, setShowTaskForm] = React.useState(false);
      const [editingTask, setEditingTask] = React.useState(null);
      const [taskFormData, setTaskFormData] = React.useState({
        title: '',
        description: '',
        status: 'open',
        priority: 'medium',
        due_date: ''
      });
      
      // Profile state
      const [profileData, setProfileData] = React.useState({
        username: '',
        email: '',
        first_name: '',
        last_name: '',
        address: '',
        household_members: '',
        occupation: '',
        parenting_philosophy: '',
        personal_growth: ''
      });
      const [isLoadingProfile, setIsLoadingProfile] = React.useState(false);
      const [isSavingProfile, setIsSavingProfile] = React.useState(false);
      const [showPasswordChange, setShowPasswordChange] = React.useState(false);
      const [passwordData, setPasswordData] = React.useState({
        currentPassword: '',
        newPassword: '',
        confirmPassword: ''
      });
      const [isChangingPassword, setIsChangingPassword] = React.useState(false);
      
      // Contacts state
      const [contacts, setContacts] = React.useState([]);
      const [isLoadingContacts, setIsLoadingContacts] = React.useState(false);
      const [showContactForm, setShowContactForm] = React.useState(false);
      const [contactSearch, setContactSearch] = React.useState('');
      const [showContactSuggestion, setShowContactSuggestion] = React.useState(false);
      const [suggestedContact, setSuggestedContact] = React.useState(null);
      const [suggestedRelationship, setSuggestedRelationship] = React.useState('');
      const [editingContact, setEditingContact] = React.useState(null);
      const [contactFormData, setContactFormData] = React.useState({
        contact_name: '',
        contact_email: '',
        relationship: '',
        notes: '',
        separation_date: '',
        address: '',
        difficult_aspects: '',
        friction_situations: '',
        legal_matters: '',
        safety_concerns: '',
        substance_mental_health: '',
        neglect_abuse_concerns: '',
        additional_thoughts: '',
        other_parent: ''
      });
      const [isSavingContact, setIsSavingContact] = React.useState(false);
      
      const socketRef = React.useRef(null);
      const messagesEndRef = React.useRef(null);
      const typingTimeoutRef = React.useRef(null);
      const shouldAutoJoinRef = React.useRef(false);
      const usernameRef = React.useRef('');
      const isAuthenticatedRef = React.useRef(false);
      const isJoinedRef = React.useRef(false);
      const isCreatingTasksRef = React.useRef(false);
      const onboardingTasksCheckedRef = React.useRef(false);
      const currentViewRef = React.useRef('chat');

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      // Request notification permission
      const requestNotificationPermission = async () => {
        if (!('Notification' in window)) {
          console.log('This browser does not support notifications');
          return false;
        }

        if (Notification.permission === 'granted') {
          setNotificationPermission('granted');
          return true;
        }

        if (Notification.permission !== 'denied') {
          const permission = await Notification.requestPermission();
          setNotificationPermission(permission);
          return permission === 'granted';
        }

        setNotificationPermission('denied');
        return false;
      };

      // Show notification for new message
      const showMessageNotification = (message) => {
        // Only show notifications if:
        // 1. Notifications are enabled
        // 2. App is not in focus OR user is not viewing chat
        // 3. Message is from someone else
        // 4. Message is not a system message
        // 5. User is authenticated and joined
        if (Notification.permission !== 'granted') {
          return;
        }

        // Show notification if app is hidden OR user is not on chat view
        const shouldNotify = document.hidden || currentViewRef.current !== 'chat';

        if (!shouldNotify) {
          // App is visible and user is viewing chat, don't show notification
          return;
        }

        if (message.username === username) {
          // Message from self, don't notify
          return;
        }

        if (message.type === 'system' || message.type === 'contact_suggestion' || message.private) {
          // System messages or private messages, don't notify
          return;
        }

        if (!isAuthenticated || !isJoined) {
          return;
        }

        // Get co-parent name or use username
        const senderName = coparentName || message.username || 'Co-Parent';
        const messageText = message.text || '';
        const truncatedText = messageText.length > 100 ? messageText.substring(0, 100) + '...' : messageText;

        // Show notification
        const notification = new Notification(`${senderName}`, {
          body: truncatedText,
          icon: './assets/CEECE0%20(8).svg',
          badge: './assets/CEECE0%20(8).svg',
          tag: `message-${message.id}`, // Prevent duplicate notifications
          requireInteraction: false,
          silent: false
        });

        // Handle notification click
        notification.onclick = () => {
          window.focus();
          setCurrentView('chat');
          notification.close();
        };

        // Auto-close notification after 5 seconds
        setTimeout(() => {
          notification.close();
        }, 5000);
      };

      // Format timestamp to show relative time or day and time
      const formatTimestamp = (timestamp) => {
        if (!timestamp) return '';
        try {
          // If it's already a formatted string, try to parse it
          let date;
          if (typeof timestamp === 'string') {
            // Check if it's already a formatted time string (e.g., "3:45:23 PM")
            if (timestamp.match(/^\d{1,2}:\d{2}:\d{2}/)) {
              // It's just a time, use today's date
              date = new Date();
            } else {
              // Try to parse as ISO string or other date format
              date = new Date(timestamp);
            }
          } else {
            date = new Date(timestamp);
          }
          
          // Check if date is valid
          if (isNaN(date.getTime())) {
            return '';
          }
          
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          // Show relative time for recent messages
          if (diffMins < 1) {
            return 'just now';
          } else if (diffMins < 60) {
            return `${diffMins}m ago`;
          } else if (diffHours < 24) {
            return `${diffHours}h ago`;
          }
          
          // For older messages, show day and time
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
          
          const dayDiff = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
          
          let dayLabel;
          if (dayDiff === 0) {
            dayLabel = 'Today';
          } else if (dayDiff === 1) {
            dayLabel = 'Yesterday';
          } else if (dayDiff < 7) {
            dayLabel = date.toLocaleDateString('en-US', { weekday: 'short' });
          } else {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: diffDays > 365 ? 'numeric' : undefined });
          }
          
          const timeStr = date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          });
          
          return `${dayLabel} ${timeStr}`;
        } catch (err) {
          console.error('Error formatting timestamp:', err, timestamp);
          return '';
        }
      };

      React.useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Check notification permission on mount
      React.useEffect(() => {
        if ('Notification' in window) {
          setNotificationPermission(Notification.permission);
        }
        // Initialize currentViewRef
        currentViewRef.current = currentView;
      }, []);

      // Handle visibility change to check if app is in background
      React.useEffect(() => {
        const handleVisibilityChange = () => {
          // When app becomes visible, we can optionally clear notifications or update state
          if (!document.hidden) {
            // App is now visible, notifications will be suppressed automatically
            console.log('App is now visible');
          }
        };

        document.addEventListener('visibilitychange', handleVisibilityChange);
        return () => {
          document.removeEventListener('visibilitychange', handleVisibilityChange);
        };
      }, []);

      // Close user menu when clicking outside
      React.useEffect(() => {
        if (!showUserMenu) return;
        
        const handleClickOutside = (event) => {
          // Check if click is inside the menu container
          const menuContainer = event.target.closest('.user-menu-container');
          if (!menuContainer) {
            setShowUserMenu(false);
          }
        };
        
        // Use a small delay to avoid immediate closure when opening
        const timeoutId = setTimeout(() => {
          document.addEventListener('click', handleClickOutside, true);
        }, 100);
        
        return () => {
          clearTimeout(timeoutId);
          document.removeEventListener('click', handleClickOutside, true);
        };
      }, [showUserMenu]);

      // Handle Google OAuth callback
      React.useEffect(() => {
        const handleGoogleCallback = async () => {
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          const error = urlParams.get('error');

          if (error) {
            setError('Google Sign-In was cancelled or failed');
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
            return;
          }

          if (code) {
            try {
              // Send code to backend
              const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/auth/google/callback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ code })
              });

              const data = await response.json();
            
              if (!response.ok) {
                setError(data.error || 'Google Sign-In failed');
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
              }

              // Login successful - token is now in httpOnly cookie
              setIsAuthenticated(true);
              setUsername(data.user.username);
              usernameRef.current = data.user.username;
              isAuthenticatedRef.current = true;
              
              // Store minimal info in localStorage (not sensitive data)
              localStorage.setItem('username', data.user.username);
              localStorage.setItem('isAuthenticated', 'true');
              if (data.token) {
                localStorage.setItem('auth_token_backup', data.token);
              }
              if (data.user) {
                localStorage.setItem('chatUser', JSON.stringify(data.user));
              }

              // Clean up URL
              window.history.replaceState({}, document.title, window.location.pathname);

              // Redirect to dashboard
              setCurrentView('dashboard');
              loadOnboardingStatus();
              loadTasks(data.user.username);
              shouldAutoJoinRef.current = true;
            } catch (err) {
              setError('Unable to connect to server. Please try again.');
              console.error('Google callback error:', err);
              // Clean up URL
              window.history.replaceState({}, document.title, window.location.pathname);
            }
          }
        };

        handleGoogleCallback();
      }, []);

      // Restore authentication state from cookie (not localStorage)
      React.useEffect(() => {
        // Skip if we're handling a Google OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('code')) {
          return; // Let the Google callback handler run
        }

        // Verify session with backend instead of trusting localStorage
        const verifySession = async () => {
          setIsCheckingAuth(true); // Start checking
          try {
            const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/auth/verify`, {
              method: 'GET',
              credentials: 'include', // Include cookies
              headers: {
                // Include backup token if cookie doesn't work
                'Authorization': localStorage.getItem('auth_token_backup') 
                  ? `Bearer ${localStorage.getItem('auth_token_backup')}` 
                  : undefined
              }
            });

            if (response.ok) {
              const data = await response.json();
              if (data.authenticated && data.user) {
                console.log('âœ… Session verified - user authenticated');
                setUsername(data.user.username);
                usernameRef.current = data.user.username;
                setIsAuthenticated(true);
                isAuthenticatedRef.current = true;
                
                // Restore view from localStorage (safe - not auth data)
                const storedView = localStorage.getItem('currentView');
              if (storedView && ['chat', 'dashboard', 'profile', 'contacts'].includes(storedView)) {
                setCurrentViewState(storedView);
              } else {
                setCurrentViewState('dashboard');
              }
                setIsCheckingAuth(false); // Done checking - authenticated
              } else {
                // Not authenticated
                setIsCheckingAuth(false);
                setShowLandingPage(true);
              }
            } else {
              // Session invalid - clear any stale localStorage
              localStorage.removeItem('username');
              localStorage.removeItem('isAuthenticated');
              localStorage.removeItem('auth_token_backup');
              localStorage.removeItem('chatUser');
              console.log('âŒ Session invalid or expired');
              // Show landing page when session is invalid
              setIsCheckingAuth(false); // Done checking - not authenticated
              setShowLandingPage(true);
            }
          } catch (err) {
            console.error('Error verifying session:', err);
            // On error, don't auto-login - require manual login
            // Show landing page on error
            setIsCheckingAuth(false); // Done checking - error occurred
            setShowLandingPage(true);
          }
        };

        // Only verify if we have a username stored (to avoid unnecessary API calls)
        const storedUsername = localStorage.getItem('username');
        if (storedUsername) {
          verifySession();
        } else {
          // No stored username - ensure landing page shows
          setIsCheckingAuth(false); // Done checking - no stored username
          setShowLandingPage(true);
        }
      }, []);

      // Check for URL parameters on mount (invite code, username, connection status)
      React.useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Check for invite code
        const inviteCode = urlParams.get('invite');
        if (inviteCode) {
          console.log('Invite code detected:', inviteCode);
          setPendingInviteCode(inviteCode);
          // If there's an invite code, skip landing page and show login form
          setShowLandingPage(false);
          setShowInviteAcceptModal(true);
        }
        
        // Check for username parameter (from join.html redirect)
        const usernameParam = urlParams.get('username');
        if (usernameParam) {
          console.log('Username parameter detected:', usernameParam);
          setUsername(usernameParam);
          // Update ref immediately so it's available for auto-join
          usernameRef.current = usernameParam;
          
          // Check if user exists in localStorage
          const storedUser = localStorage.getItem('chatUser');
          if (storedUser) {
            try {
              const user = JSON.parse(storedUser);
              if (user.username === usernameParam) {
                // Auto-authenticate if username matches
                setIsAuthenticated(true);
                isAuthenticatedRef.current = true;
                console.log('Auto-authenticated user from localStorage');
                // Redirect to dashboard
                setCurrentView('dashboard');
              }
            } catch (err) {
              console.error('Error parsing stored user:', err);
            }
          }
        }
        
        // Check for connection=accepted parameter
        const connectionAccepted = urlParams.get('connection');
        if (connectionAccepted === 'accepted') {
          console.log('Connection accepted - showing success message');
          setConnectionSuccess(true);
          // Set flag to skip context prompt for newly connected users
          setHasContext(true); // Temporarily set to true to skip prompt
          // Redirect to dashboard after connection is accepted
          if (usernameParam) {
            // Update username ref immediately
            usernameRef.current = usernameParam;
            // Redirect to dashboard instead of auto-joining chat
            setCurrentView('dashboard');
          }
          // Clear URL parameter after processing
          window.history.replaceState({}, document.title, window.location.pathname + (usernameParam ? `?username=${usernameParam}` : ''));
          // Hide success message after 5 seconds
          setTimeout(() => {
            setConnectionSuccess(false);
          }, 5000);
        }
      }, []);

      React.useEffect(() => {
        // Initialize socket connection
        // For Safari compatibility, prefer polling first, then websocket
        socketRef.current = io(window.SOCKET_URL || 'http://localhost:3001', {
          transports: ['polling', 'websocket'], // Safari works better with polling first
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 10, // More attempts for Safari
          timeout: 20000, // Longer timeout for Safari
          forceNew: false,
          upgrade: true
        });

        const socket = socketRef.current;

        socket.on('connect', () => {
          console.log('Connected to server');
          setIsConnected(true);
          setError('');
          
          // Auto-join if user is authenticated
          // Check both ref and state for username
          const usernameToJoin = usernameRef.current || username;
          if (isAuthenticatedRef.current && usernameToJoin && socketRef.current && !isJoinedRef.current) {
            console.log('Auto-joining chat on connect as:', usernameToJoin);
            socketRef.current.emit('join', { username: usernameToJoin });
          }
        });

        socket.on('disconnect', () => {
          console.log('Disconnected from server');
          setIsConnected(false);
          
          // If user was in chat and disconnected, auto-rejoin on reconnect
          if (isAuthenticatedRef.current && isJoinedRef.current) {
            setIsJoined(false);
            shouldAutoJoinRef.current = true;
          }
        });

        socket.on('connect_error', (err) => {
          console.error('Connection error:', err);
          setIsConnected(false);
          // Only show error if user is not authenticated (on login page)
          // Authenticated users will see errors in the chat interface
          if (!isAuthenticatedRef.current) {
            setError('Unable to connect to chat server. Please check if the server is running.');
          }
        });

        socket.on('join_success', (data) => {
          console.log('Successfully joined room:', data);
          setIsJoined(true);
          isJoinedRef.current = true;
          setActiveUsers(data.users || []);
          setRoomInfo({
            roomId: data.roomId,
            roomName: data.roomName
          });
          setRoomMembers(data.roomMembers || []);
          setError('');
          
          // Request notification permission when user joins chat
          requestNotificationPermission();
        });

        socket.on('error', ({ message }) => {
          console.error('Socket error:', message);
          setError(message);
          setTimeout(() => setError(''), 5000);
          // If join failed, reset auto-join flag
          if (message.includes('not found') || message.includes('Invalid')) {
            shouldAutoJoinRef.current = false;
          }
          // If contact creation failed, refresh contacts list to ensure consistency
          if (message.includes('contact') || message.includes('Contact')) {
            setTimeout(() => {
              loadContacts();
            }, 1000);
          }
        });

        socket.on('message_history', (history) => {
          setMessages(history.map(msg => ({
            ...msg,
            timestamp: msg.timestamp // Keep original timestamp for formatting
          })));
        });

        socket.on('user_joined', ({ message, users }) => {
          // Don't add system messages for join/leave - just update active users
          setActiveUsers(users);
        });

        socket.on('new_message', (message) => {
          // Handle contact suggestion messages specially
          if (message.type === 'contact_suggestion') {
            console.log('ðŸ“¥ Received contact suggestion:', message);
            setSuggestedContact({
              detectedName: message.detectedName,
              messageContext: message.messageContext || message.text,
              messageId: message.id
            });
            setShowContactSuggestion(true);
            // Don't add to messages - we'll show it as a modal
            return;
          }
          
          // Handle success messages for contact creation
          if (message.type === 'system' && message.text && message.text.includes('has been added to your contacts')) {
            console.log('âœ… Contact added successfully:', message.text);
            // Refresh contacts list when we see the success message
            setTimeout(() => {
              loadContacts();
              loadOnboardingStatus();
              loadCoparentName();
            }, 500);
          }
          
          setMessages(prev => {
            const newMsg = {
              ...message,
              timestamp: message.timestamp || new Date().toISOString() // Keep original timestamp for formatting
            };
            return [...prev, newMsg];
          });
          
          // Show notification for new messages from others
          showMessageNotification(message);
        });

        socket.on('user_left', ({ message, users }) => {
          // Don't add system messages for join/leave - just update active users
          setActiveUsers(users);
        });

        socket.on('user_typing', ({ username, isTyping }) => {
          setTypingUsers(prev => {
            const newSet = new Set(prev);
            if (isTyping) {
              newSet.add(username);
            } else {
              newSet.delete(username);
            }
            return newSet;
          });
        });

        socket.on('reaction_updated', ({ messageId, reactions }) => {
          setMessages(prev => prev.map(msg => 
            msg.id === messageId ? { ...msg, reactions } : msg
          ));
        });

        socket.on('message_flagged', ({ messageId, flaggedBy }) => {
          setMessages(prev => prev.map(msg => 
            msg.id === messageId ? { ...msg, user_flagged_by: flaggedBy } : msg
          ));
        });

        return () => {
          socket.disconnect();
        };
      }, []);

      // Keep refs in sync with state
      React.useEffect(() => {
        usernameRef.current = username;
      }, [username]);

      // Auto-join when authenticated and username is set (fallback for auto-join)
      React.useEffect(() => {
        if (isAuthenticated && username && socketRef.current && socketRef.current.connected && !isJoined) {
          console.log('Auto-join triggered from useEffect - username:', username, 'isAuthenticated:', isAuthenticated, 'isJoined:', isJoined);
          socketRef.current.emit('join', { username });
          shouldAutoJoinRef.current = false;
        }
      }, [isAuthenticated, username, isJoined]);

      // Auto-join when navigating to chat view if not already joined
      React.useEffect(() => {
        if (currentView === 'chat' && isAuthenticated && username && socketRef.current && socketRef.current.connected && !isJoined) {
          console.log('Auto-join triggered from chat view navigation - username:', username);
          socketRef.current.emit('join', { username });
        }
      }, [currentView, isAuthenticated, username, isJoined]);

      React.useEffect(() => {
        isAuthenticatedRef.current = isAuthenticated;
      }, [isAuthenticated]);

      React.useEffect(() => {
        isJoinedRef.current = isJoined;
      }, [isJoined]);

      const sanitizeInput = (input) => {
        return input.replace(/[<>]/g, '').trim();
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setIsLoggingIn(true);
        
        const cleanEmail = email.trim().toLowerCase();
        const cleanPassword = password.trim();
        
        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(cleanEmail)) {
          setError('Please enter a valid email address');
          setIsLoggingIn(false);
          return;
        }
        
        if (cleanPassword.length < 4) {
          setError('Password must be at least 4 characters');
          setIsLoggingIn(false);
          return;
        }

        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/auth/login`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json'
            },
            credentials: 'include', // IMPORTANT: Include cookies
            body: JSON.stringify({ email: cleanEmail, password: cleanPassword })
          });

          const data = await response.json();

          if (!response.ok) {
            setError(data.error || 'Login failed');
            setIsLoggingIn(false);
            return;
          }

          // Login successful - token is now in httpOnly cookie
          setIsAuthenticated(true);
          // Set username from user object (auto-generated from email)
          if (data.user && data.user.username) {
            setUsername(data.user.username);
            usernameRef.current = data.user.username;
            localStorage.setItem('username', data.user.username);
          }
          isAuthenticatedRef.current = true;

          // Store minimal info in localStorage (not sensitive data)
          // Token is in httpOnly cookie, more secure
          localStorage.setItem('isAuthenticated', 'true');
          localStorage.setItem('userEmail', cleanEmail);
          // Store token if provided (backup for cookie issues)
          if (data.token) {
            localStorage.setItem('auth_token_backup', data.token);
          }
          if (data.user) {
            localStorage.setItem('chatUser', JSON.stringify(data.user));
          }

          // If there's a pending invite, show the accept modal first
          if (pendingInviteCode) {
            setShowInviteAcceptModal(true);
            return;
          }

          // Redirect to dashboard on login
          setCurrentView('dashboard');
          loadOnboardingStatus();
          loadTasks(cleanUsername); // Pass username directly to avoid state update timing issues
          // Set auto-join flag for when user navigates to chat
          shouldAutoJoinRef.current = true;
        } catch (err) {
          setError('Unable to connect to server. Please try again.');
          console.error('Login error:', err);
        } finally {
          setIsLoggingIn(false);
        }
      };

      const handleSignup = async (e) => {
        e.preventDefault();
        setError('');
        setIsSigningUp(true);
        
        const cleanEmail = email.trim().toLowerCase();
        const cleanPassword = password.trim();
        
        if (!cleanEmail) {
          setError('Email is required');
          setIsSigningUp(false);
          return;
        }
        
        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(cleanEmail)) {
          setError('Please enter a valid email address');
          setIsSigningUp(false);
          return;
        }
        
        if (cleanPassword.length < 4) {
          setError('Password must be at least 4 characters');
          setIsSigningUp(false);
          return;
        }

        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/auth/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ 
              email: cleanEmail,
              password: cleanPassword,
              context: {}
            })
          });

          const data = await response.json();

          if (!response.ok) {
            setError(data.error || 'Signup failed');
            setIsSigningUp(false);
            return;
          }

          // Signup successful
          setIsAuthenticated(true);
          // Set username from user object (auto-generated from email)
          if (data.user && data.user.username) {
            setUsername(data.user.username);
            usernameRef.current = data.user.username;
            localStorage.setItem('username', data.user.username);
          }
          // Update refs immediately
          isAuthenticatedRef.current = true;

          // Save user to localStorage
          localStorage.setItem('chatUser', JSON.stringify(data.user));
          localStorage.setItem('isAuthenticated', 'true');
          localStorage.setItem('userEmail', cleanEmail);

          // If there's a pending invite, show the accept modal first
          if (pendingInviteCode) {
            setShowInviteAcceptModal(true);
            return;
          }

          // Redirect to dashboard on signup
          setCurrentView('dashboard');
          loadOnboardingStatus();
          loadTasks(cleanUsername); // Pass username directly to avoid state update timing issues
          // Set auto-join flag for when user navigates to chat
          shouldAutoJoinRef.current = true;
        } catch (err) {
          setError('Unable to connect to server. Please try again.');
          console.error('Signup error:', err);
        } finally {
          setIsSigningUp(false);
        }
      };

      const handleJoinRoom = (e) => {
        e.preventDefault();
        if (!isAuthenticated) {
          setError('Please login or signup first');
          return;
        }
        
        if (!isConnected) {
          setError('Not connected to server. Please wait...');
          return;
        }

        socketRef.current.emit('join', { username });
      };

      const handleSendMessage = (e) => {
        e.preventDefault();
        const cleanMessage = sanitizeInput(inputMessage);
        
        if (!cleanMessage) return;
        
        if (cleanMessage.length > 500) {
          setError('Message is too long (max 500 characters)');
          return;
        }

        socketRef.current.emit('send_message', { text: cleanMessage });
        setInputMessage('');
        
        if (typingTimeoutRef.current) {
          clearTimeout(typingTimeoutRef.current);
        }
        socketRef.current.emit('typing', { isTyping: false });
      };

      const handleInputChange = (e) => {
        setInputMessage(e.target.value);
        
        socketRef.current.emit('typing', { isTyping: true });
        
        if (typingTimeoutRef.current) {
          clearTimeout(typingTimeoutRef.current);
        }
        
        typingTimeoutRef.current = setTimeout(() => {
          socketRef.current.emit('typing', { isTyping: false });
        }, 1000);
      };

      const stringToColor = (str) => {
        const colors = [
          'bg-blue',
          'bg-green',
          'bg-teal',
          'bg-pink',
          'bg-orange'
        ];
        
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        return colors[Math.abs(hash) % colors.length];
      };

      // Smart task handler - detects onboarding tasks and navigates to appropriate section
      const handleSmartTask = (task) => {
        if (task.status === 'completed') {
          // If completed, allow normal editing
          return false;
        }
        
        const titleLower = (task.title || '').toLowerCase().trim();
        
        // Check for smart tasks and navigate accordingly
        if (titleLower.includes('add your co-parent') || titleLower.includes('add coparent')) {
          setCurrentView('contacts');
          return true;
        }
        
        if (titleLower.includes('complete your profile') || titleLower.includes('complete profile')) {
          setCurrentView('profile');
          return true;
        }
        
        if (titleLower.includes('add your children') || titleLower.includes('add children')) {
          setCurrentView('contacts');
          return true;
        }
        
        return false;
      };

      // Load tasks
      const loadTasks = async (overrideUsername = null) => {
        const usernameToUse = overrideUsername || username || usernameRef.current;
        if (!usernameToUse) return;
        setIsLoadingTasks(true);
        try {
          const params = new URLSearchParams({
            username: usernameToUse,
            status: taskFilter !== 'all' ? taskFilter : '',
            search: taskSearch
          });
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/tasks?${params.toString()}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            // Ensure data is an array
            if (Array.isArray(data)) {
              // Deduplicate all onboarding tasks - keep only the oldest of each type
              const onboardingTaskTypes = {
                'welcome to liaizen': [],
                'complete your profile': [],
                'add your co-parent': [],
                'add your children': []
              };
              const regularTasks = [];
              const seenIds = new Set();
              
              // Categorize tasks
              data.forEach(task => {
                if (!task.id || seenIds.has(task.id)) return;
                seenIds.add(task.id);
                
                const titleKey = task.title?.toLowerCase().trim() || '';
                let categorized = false;
                
                // Check each onboarding task type
                for (const [key, arr] of Object.entries(onboardingTaskTypes)) {
                  if (titleKey.includes(key)) {
                    arr.push(task);
                    categorized = true;
                    break;
                  }
                }
                
                if (!categorized) {
                  regularTasks.push(task);
                }
              });
              
              // For each onboarding task type, keep only the oldest one
              const deduplicatedOnboardingTasks = [];
              for (const [key, tasks] of Object.entries(onboardingTaskTypes)) {
                if (tasks.length > 0) {
                  tasks.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateA - dateB; // Oldest first
                  });
                  deduplicatedOnboardingTasks.push(tasks[0]); // Keep only the oldest
                }
              }
              
              // Combine deduplicated onboarding tasks with regular tasks
              const deduplicated = [...deduplicatedOnboardingTasks, ...regularTasks];
              
              // Check for missing onboarding tasks only once per session and if no filter/search is active
              if (taskFilter === 'all' && !taskSearch.trim() && !onboardingTasksCheckedRef.current && !isCreatingTasksRef.current) {
                onboardingTasksCheckedRef.current = true;
                isCreatingTasksRef.current = true;
                
                try {
                  // Check if onboarding tasks exist (use already loaded data)
                  const taskTitles = deduplicated.map(t => t.title?.toLowerCase().trim()).filter(Boolean);
                  const missingTasks = [];
                  
                  if (!taskTitles.some(t => t.includes('complete your profile') || t.includes('complete profile'))) {
                    missingTasks.push({
                      title: 'Complete Your Profile',
                      description: 'Add your profile information to help LiaiZen understand your situation better. Go to Profile to add your name, email, and other details.',
                      priority: 'high'
                    });
                  }
                  
                  if (!taskTitles.some(t => t.includes('add your co-parent') || t.includes('add coparent'))) {
                    missingTasks.push({
                      title: 'Add Your Co-parent',
                      description: 'Add your co-parent as a contact to enable communication and coordination features. Go to Contacts to add them.',
                      priority: 'high'
                    });
                  }
                  
                  if (!taskTitles.some(t => t.includes('add your children') || t.includes('add children'))) {
                    missingTasks.push({
                      title: 'Add Your Children',
                      description: 'Add your children as contacts so LiaiZen can help you coordinate their care and activities.',
                      priority: 'high'
                    });
                  }
                  
                  // Create missing onboarding tasks (server will check for duplicates)
                  if (missingTasks.length > 0) {
                    for (const task of missingTasks) {
                      await fetch(`${window.API_URL || 'http://localhost:3001'}/api/tasks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                          username: usernameToUse,
                          title: task.title,
                          description: task.description,
                          status: 'open',
                          priority: task.priority
                        })
                      });
                    }
                    // Reload tasks after creating missing ones
                    const reloadParams = new URLSearchParams({
                      username: usernameToUse,
                      status: taskFilter !== 'all' ? taskFilter : '',
                      search: taskSearch
                    });
                    const reloadResponse = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/tasks?${reloadParams.toString()}`, {
                      credentials: 'include'
                    });
                    if (reloadResponse.ok) {
                      const reloadData = await reloadResponse.json();
                      if (Array.isArray(reloadData)) {
                        // Apply same deduplication logic to reloaded data
                        const reloadOnboardingTaskTypes = {
                          'welcome to liaizen': [],
                          'complete your profile': [],
                          'add your co-parent': [],
                          'add your children': []
                        };
                        const reloadRegularTasks = [];
                        const reloadSeenIds = new Set();
                        
                        reloadData.forEach(task => {
                          if (!task.id || reloadSeenIds.has(task.id)) return;
                          reloadSeenIds.add(task.id);
                          
                          const titleKey = task.title?.toLowerCase().trim() || '';
                          let categorized = false;
                          
                          for (const [key, arr] of Object.entries(reloadOnboardingTaskTypes)) {
                            if (titleKey.includes(key)) {
                              arr.push(task);
                              categorized = true;
                              break;
                            }
                          }
                          
                          if (!categorized) {
                            reloadRegularTasks.push(task);
                          }
                        });
                        
                        const reloadDeduplicatedOnboarding = [];
                        for (const [key, tasks] of Object.entries(reloadOnboardingTaskTypes)) {
                          if (tasks.length > 0) {
                            tasks.sort((a, b) => {
                              const dateA = new Date(a.created_at || 0);
                              const dateB = new Date(b.created_at || 0);
                              return dateA - dateB;
                            });
                            reloadDeduplicatedOnboarding.push(tasks[0]);
                          }
                        }
                        
                        deduplicated.length = 0;
                        deduplicated.push(...reloadDeduplicatedOnboarding, ...reloadRegularTasks);
                        
                        // Sort reloaded tasks: Welcome to LiaiZen first, then by created_at DESC
                        deduplicated.sort((a, b) => {
                          const titleA = a.title?.toLowerCase().trim() || '';
                          const titleB = b.title?.toLowerCase().trim() || '';
                          
                          const isWelcomeA = titleA.includes('welcome to liaizen');
                          const isWelcomeB = titleB.includes('welcome to liaizen');
                          
                          if (isWelcomeA && !isWelcomeB) return -1;
                          if (!isWelcomeA && isWelcomeB) return 1;
                          
                          const dateA = new Date(a.created_at || 0);
                          const dateB = new Date(b.created_at || 0);
                          return dateB - dateA;
                        });
                      }
                    }
                  }
                } catch (err) {
                  console.error('Error creating missing onboarding tasks:', err);
                } finally {
                  isCreatingTasksRef.current = false;
                }
              }
              
              // Sort tasks: Welcome to LiaiZen first, then by created_at DESC (newest first)
              deduplicated.sort((a, b) => {
                const titleA = a.title?.toLowerCase().trim() || '';
                const titleB = b.title?.toLowerCase().trim() || '';
                
                // Welcome to LiaiZen always comes first
                const isWelcomeA = titleA.includes('welcome to liaizen');
                const isWelcomeB = titleB.includes('welcome to liaizen');
                
                if (isWelcomeA && !isWelcomeB) return -1;
                if (!isWelcomeA && isWelcomeB) return 1;
                
                // For all other tasks, sort by created_at DESC (newest first)
                const dateA = new Date(a.created_at || 0);
                const dateB = new Date(b.created_at || 0);
                return dateB - dateA;
              });
              
              // Limit to 5 tasks for display
              setTasks(deduplicated.slice(0, 5));
            } else {
              console.error('Tasks API returned non-array:', data);
              setTasks([]);
            }
          } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('Error loading tasks:', response.status, errorData);
            setTasks([]);
          }
        } catch (err) {
          console.error('Error loading tasks:', err);
          setTasks([]);
        } finally {
          setIsLoadingTasks(false);
        }
      };

      // Check if user has a co-parent connection
      const checkCoparentConnection = async () => {
        if (!username) return false;
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/room/shared-check/${encodeURIComponent(username)}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            return data.isShared || false;
          }
          return false;
        } catch (err) {
          console.error('Error checking co-parent connection:', err);
          return false;
        }
      };

      // Handle Chat button click - check for co-parent connection first
      const handleChatClick = async () => {
        if (!isAuthenticated || !username) {
          setCurrentView('chat');
          return;
        }

        setIsCheckingCoparent(true);
        const hasCoparent = await checkCoparentConnection();
        setIsCheckingCoparent(false);

        if (hasCoparent) {
          // User has co-parent connection, proceed to chat
          setCurrentView('chat');
          // Trigger join if not already joined
          if (socketRef.current && socketRef.current.connected && !isJoined) {
            console.log('Manually joining chat from navigation');
            socketRef.current.emit('join', { username });
          }
        } else {
          // No co-parent connection, show modal to create or enter code
          setShowNoCoparentModal(true);
        }
      };

      // Load onboarding status
      const loadOnboardingStatus = async () => {
        if (!username) return;
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/user/onboarding-status?username=${encodeURIComponent(username)}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            setOnboardingStatus(data);
            // Auto-show dashboard on first login if tasks are incomplete
            // Only auto-show if we're not already viewing something else and user just logged in
            if (data.showDashboard && isAuthenticated && currentView === 'chat') {
              setShowDashboard(true);
              setCurrentView('dashboard');
            }
          }
        } catch (err) {
          console.error('Error loading onboarding status:', err);
        }
      };

      // Reset onboarding tasks check flag when username changes
      React.useEffect(() => {
        onboardingTasksCheckedRef.current = false;
      }, [username]);

      // Check shared room status and onboarding when user is authenticated
      React.useEffect(() => {
        if (isAuthenticated && username) {
          checkSharedRoom();
          loadOnboardingStatus();
          loadCoparentName();
          loadTasks(); // Auto-load tasks for authenticated users
        }
      }, [isAuthenticated, username, isJoined]);

      // Load tasks when dashboard view is active
      React.useEffect(() => {
        if (currentView === 'dashboard' && isAuthenticated && username) {
          loadTasks();
        }
      }, [currentView, isAuthenticated, username, taskFilter, taskSearch]);

      // Reload onboarding status when profile or contacts are updated
      React.useEffect(() => {
        if (currentView === 'profile' || currentView === 'contacts' || currentView === 'dashboard') {
          loadOnboardingStatus();
        }
      }, [currentView, profileData, contacts]);

      // Load profile when navigating to profile view
      React.useEffect(() => {
        if (currentView === 'profile' && isAuthenticated && username) {
          loadProfile();
        }
      }, [currentView, isAuthenticated, username]);

      // Load contacts when navigating to contacts view
      React.useEffect(() => {
        if (currentView === 'contacts' && isAuthenticated && username) {
          loadContacts();
        }
      }, [currentView, isAuthenticated, username]);

      // Load user context when user joins (non-blocking)
      React.useEffect(() => {
        if (isJoined && username) {
          fetch(`${window.API_URL || 'http://localhost:3001'}/api/user-context/${username}`, {
            credentials: 'include'
          })
            .then(res => res.ok ? res.json() : null)
            .then(data => {
              if (data && (data.coParentName || data.separationDate || (data.children && data.children.length > 0) || (data.concerns && data.concerns.length > 0) || data.newPartner)) {
                // User has existing context
                setHasContext(true);
                setShowContextPrompt(false);
                setUserContextData({
                  coParentName: data.coParentName || '',
                  separationDate: data.separationDate || '',
                  children: data.children && data.children.length > 0 ? data.children : [{ name: '', birthday: '' }],
                  concerns: data.concerns || [],
                  newPartner: data.newPartner || { name: '', livesWith: false }
                });
              } else {
                // No context found - but don't block chat (show optional prompt later)
                setHasContext(false);
                // Only show context prompt if user is not newly connected
                // Check URL for connection=accepted to skip prompt
                const urlParams = new URLSearchParams(window.location.search);
                const connectionAccepted = urlParams.get('connection');
                if (connectionAccepted !== 'accepted') {
                  // Show prompt after a delay, non-blocking
                  setTimeout(() => {
                    setShowContextPrompt(true);
                  }, 2000); // Show after 2 seconds, allowing chat to load first
                }
              }
            })
            .catch(err => {
              console.error('Error loading user context:', err);
              // If error (like 404), user has no context - but don't block
              setHasContext(false);
              // Only show prompt if not newly connected
              const urlParams = new URLSearchParams(window.location.search);
              const connectionAccepted = urlParams.get('connection');
              if (connectionAccepted !== 'accepted') {
                setTimeout(() => {
                  setShowContextPrompt(true);
                }, 2000);
              }
            });
        }
      }, [isJoined, username]);

      const handleSaveContext = async () => {
        setIsSavingContext(true);
        try {
          const contextToSave = {
            coParentName: userContextData.coParentName.trim(),
            separationDate: userContextData.separationDate,
            children: userContextData.children.filter(c => c.name.trim()),
            concerns: userContextData.concerns.filter(c => c.trim()),
            newPartner: userContextData.newPartner.name.trim() ? userContextData.newPartner : null
          };

          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/user-context/${username}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(contextToSave)
          });

          if (response.ok) {
            setShowSettings(false);
            setShowContextPrompt(false);
            setHasContext(true);
            setError('');
            
            // Join chat room if not already joined (context is optional, don't block)
            if (!isJoined) {
              if (socketRef.current && socketRef.current.connected) {
                socketRef.current.emit('join', { username });
              } else {
                shouldAutoJoinRef.current = true;
              }
            }
          } else {
            setError('Failed to save context');
          }
        } catch (err) {
          console.error('Error saving context:', err);
          setError('Failed to save context');
        } finally {
          setIsSavingContext(false);
        }
      };

      const addChild = () => {
        setUserContextData(prev => ({
          ...prev,
          children: [...prev.children, { name: '', birthday: '' }]
        }));
      };

      const updateChild = (index, field, value) => {
        setUserContextData(prev => ({
          ...prev,
          children: prev.children.map((child, i) => 
            i === index ? { ...child, [field]: value } : child
          )
        }));
      };

      const removeChild = (index) => {
        setUserContextData(prev => ({
          ...prev,
          children: prev.children.filter((_, i) => i !== index)
        }));
      };

      const addConcern = () => {
        const concern = prompt('Enter concern:');
        if (concern) {
          setUserContextData(prev => ({
            ...prev,
            concerns: [...prev.concerns, concern]
          }));
        }
      };

      const removeConcern = (index) => {
        setUserContextData(prev => ({
          ...prev,
          concerns: prev.concerns.filter((_, i) => i !== index)
        }));
      };

      // Handle invite creation (code-based)
      const handleCreateInvite = async () => {
        setIsCreatingInvite(true);
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/room/invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            setInviteCode(data.inviteCode);
            setShowInviteModal(true);
            setCopiedCode(false);
          } else {
            setError(data.error || 'Failed to create invite');
          }
        } catch (err) {
          console.error('Error creating invite:', err);
          setError('Failed to create invite. Please try again.');
        } finally {
          setIsCreatingInvite(false);
        }
      };

      const handleCopyInviteCode = async () => {
        try {
          await navigator.clipboard.writeText(inviteCode);
          setCopiedCode(true);
          setTimeout(() => setCopiedCode(false), 2000);
        } catch (err) {
          console.error('Failed to copy code:', err);
          setError('Failed to copy code. Please try again.');
        }
      };


      const acceptInviteCode = async (inviteCodeRaw) => {
        const inviteCode = (inviteCodeRaw || '').trim();
        if (!inviteCode) {
          return { success: false, message: 'Invite code is required.' };
        }

        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/room/join`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              inviteCode,
              username
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            if (socketRef.current && socketRef.current.connected) {
              socketRef.current.emit('join', { username });
            } else {
              shouldAutoJoinRef.current = true;
            }
            return { success: true };
          }

          return { success: false, message: data.error || 'Failed to accept invite' };
        } catch (err) {
          console.error('Error accepting invite:', err);
          return { success: false, message: 'Failed to accept invite. Please try again.' };
        }
      };

      // Handle accepting an invite from the modal (pending invite from URL)
      const handleAcceptInvite = async (event) => {
        if (event && typeof event.preventDefault === 'function') {
          event.preventDefault();
        }

        if (!pendingInviteCode) return;

        const result = await acceptInviteCode(pendingInviteCode);
        if (result.success) {
          setShowInviteAcceptModal(false);
          setPendingInviteCode(null);
          window.history.replaceState({}, document.title, window.location.pathname);
          // Redirect to dashboard after accepting invite
          setCurrentView('dashboard');
          loadContacts();
          loadOnboardingStatus();
        } else {
          setError(result.message);
        }
      };

      // Handle joining a room via the context/profile modal
      const handleJoinRoomFromContext = async () => {
        const trimmedCode = contextInviteCode.trim();
        if (!trimmedCode) {
          setContextInviteStatus({ type: 'error', message: 'Please enter an invite code.' });
          return;
        }

        setIsJoiningRoom(true);
        setContextInviteStatus(null);

        const result = await acceptInviteCode(trimmedCode);
        if (result.success) {
          setContextInviteStatus({ type: 'success', message: 'Success! Joining the shared roomâ€¦' });
          setContextInviteCode('');
        } else {
          setContextInviteStatus({ type: 'error', message: result.message });
        }

        setIsJoiningRoom(false);
      };

      // Load coparent name from contacts
      const loadCoparentName = async () => {
        if (!username) return;
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/contacts?username=${encodeURIComponent(username)}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            const coparentContact = data.contacts?.find(c => c.relationship === 'co-parent');
            if (coparentContact) {
              setCoparentName(coparentContact.contact_name);
            }
          }
        } catch (err) {
          console.error('Error loading coparent name:', err);
        }
      };

      // Check if user is in shared room
      const checkSharedRoom = async () => {
        if (!username) return;
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/room/shared-check/${username}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            setIsInSharedRoom(data.isShared || false);
          }
        } catch (err) {
          console.error('Error checking shared room:', err);
        }
      };

      // Load profile data
      const loadProfile = async () => {
        if (!username) return;
        setIsLoadingProfile(true);
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/user/profile?username=${encodeURIComponent(username)}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            setProfileData({
              username: data.username || username,
              email: data.email || '',
              first_name: data.first_name || '',
              last_name: data.last_name || '',
              address: data.address || '',
              household_members: data.household_members || '',
              occupation: data.occupation || '',
              parenting_philosophy: data.parenting_philosophy || '',
              personal_growth: data.personal_growth || ''
            });
          }
        } catch (err) {
          console.error('Error loading profile:', err);
          setError('Failed to load profile');
        } finally {
          setIsLoadingProfile(false);
        }
      };

      // Save profile
      const handleSaveProfile = async () => {
        if (!username) return;
        setIsSavingProfile(true);
        setError('');
        try {
          // Validate username if it was changed
          const newUsername = profileData.username?.trim();
          if (newUsername && newUsername !== username) {
            if (newUsername.length < 2 || newUsername.length > 20) {
              setError('Username must be between 2 and 20 characters');
              setIsSavingProfile(false);
              return;
            }
          }

          // Send current username separately and profile data
          // Extract username from profileData and send it explicitly
          const { username: newUsernameFromProfile, ...profileDataWithoutUsername } = profileData;
          
          // Ensure all profile fields are explicitly included
          // Preserve empty strings, only use null for truly undefined/missing values
          const requestBody = {
            currentUsername: username, // Current username (used to find user)
            username: newUsernameFromProfile || username, // New username if changed, otherwise current
            email: profileDataWithoutUsername.email !== undefined ? profileDataWithoutUsername.email : null,
            first_name: profileDataWithoutUsername.first_name !== undefined ? profileDataWithoutUsername.first_name : null,
            last_name: profileDataWithoutUsername.last_name !== undefined ? profileDataWithoutUsername.last_name : null,
            address: profileDataWithoutUsername.address !== undefined ? profileDataWithoutUsername.address : null,
            household_members: profileDataWithoutUsername.household_members !== undefined ? profileDataWithoutUsername.household_members : null,
            occupation: profileDataWithoutUsername.occupation !== undefined ? profileDataWithoutUsername.occupation : null,
            parenting_philosophy: profileDataWithoutUsername.parenting_philosophy !== undefined ? profileDataWithoutUsername.parenting_philosophy : null,
            personal_growth: profileDataWithoutUsername.personal_growth !== undefined ? profileDataWithoutUsername.personal_growth : null
          };
          
          // Debug logging
          console.log('Saving profile with personal_growth:', {
            hasPersonalGrowth: requestBody.personal_growth !== null && requestBody.personal_growth !== undefined,
            personalGrowthValue: requestBody.personal_growth,
            personalGrowthLength: requestBody.personal_growth ? requestBody.personal_growth.length : 0,
            fullRequestBody: requestBody
          });
          
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/user/profile`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(requestBody)
          });

          // Check if response is ok before trying to parse JSON
          let data;
          try {
            const responseText = await response.text();
            if (!responseText) {
              throw new Error('Empty response from server');
            }
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Error parsing response:', parseError);
            setError('Server returned invalid response. Please try again.');
            setIsSavingProfile(false);
            return;
          }

          if (response.ok) {
            setError('');
            
            // If username was changed, update state and localStorage
            if (data.username && data.username !== username) {
              const newUsername = data.username;
              setUsername(newUsername);
              usernameRef.current = newUsername;
              localStorage.setItem('username', newUsername);
              // Update profileData username to match
              setProfileData({ ...profileData, username: newUsername });
            }
            
            // Show success message
            alert('Profile saved successfully!');
            // Reload onboarding status
            loadOnboardingStatus();
          } else {
            // Safari-specific: Show detailed error message
            const errorMessage = data.error || data.message || `Failed to save profile (Status: ${response.status})`;
            console.error('Profile save failed:', {
              status: response.status,
              statusText: response.statusText,
              error: data.error,
              data: data
            });
            setError(errorMessage);
          }
        } catch (err) {
          console.error('Error saving profile:', err);
          // Safari-specific: More detailed error message
          const errorMessage = err.message || 'Failed to save profile. Please check your connection and try again.';
          setError(errorMessage);
          
          // Log full error for debugging
          console.error('Full error details:', {
            name: err.name,
            message: err.message,
            stack: err.stack
          });
        } finally {
          setIsSavingProfile(false);
        }
      };

      // Change password
      const handleChangePassword = async () => {
        if (!username) return;
        if (passwordData.newPassword !== passwordData.confirmPassword) {
          setError('New passwords do not match');
          return;
        }
        if (passwordData.newPassword.length < 4) {
          setError('Password must be at least 4 characters');
          return;
        }

        setIsChangingPassword(true);
        setError('');
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/user/password`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              username,
              currentPassword: passwordData.currentPassword,
              newPassword: passwordData.newPassword
            })
          });

          const data = await response.json();
          if (response.ok) {
            setError('');
            setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
            setShowPasswordChange(false);
            alert('Password changed successfully!');
          } else {
            setError(data.error || 'Failed to change password');
          }
        } catch (err) {
          console.error('Error changing password:', err);
          setError('Failed to change password. Please try again.');
        } finally {
          setIsChangingPassword(false);
        }
      };

      // Load contacts
      const loadContacts = async () => {
        if (!username) return;
        setIsLoadingContacts(true);
        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/contacts?username=${encodeURIComponent(username)}`, {
            credentials: 'include'
          });
          if (response.ok) {
            const data = await response.json();
            setContacts(data.contacts || []);
          }
        } catch (err) {
          console.error('Error loading contacts:', err);
          setError('Failed to load contacts');
        } finally {
          setIsLoadingContacts(false);
        }
      };

      // Save contact (create or update)
      const handleSaveContact = async () => {
        if (!username || !contactFormData.contact_name.trim()) {
          setError('Contact name is required');
          return;
        }
        
        if (!contactFormData.relationship) {
          setError('Relationship is required');
          return;
        }

        setIsSavingContact(true);
        setError('');
        try {
          const url = editingContact
            ? `${window.API_URL || 'http://localhost:3001'}/api/contacts/${editingContact.id}`
            : `${window.API_URL || 'http://localhost:3001'}/api/contacts`;
          const method = editingContact ? 'PUT' : 'POST';
          
          // Map "My Co-Parent" to "co-parent" for backward compatibility
          const relationshipValue = contactFormData.relationship === 'My Co-Parent' ? 'co-parent' : contactFormData.relationship;

          // Debug logging
          console.log('Saving contact:', {
            editingContact: editingContact ? editingContact.id : 'new',
            contactName: contactFormData.contact_name,
            relationship: relationshipValue,
            formData: contactFormData
          });

          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include', // IMPORTANT: Include cookies for authentication
            body: JSON.stringify({
              username,
              ...contactFormData,
              relationship: relationshipValue
            })
          });

          // Check if response is ok before trying to parse JSON
          let data;
          try {
            const responseText = await response.text();
            if (!responseText) {
              throw new Error('Empty response from server');
            }
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.error('Error parsing contact response:', parseError);
            setError('Server returned invalid response. Please try again.');
            setIsSavingContact(false);
            return;
          }

          if (response.ok) {
            console.log('Contact saved successfully:', data);
            setError('');
            setShowContactForm(false);
            setEditingContact(null);
            setContactFormData({ 
              contact_name: '', 
              contact_email: '', 
              relationship: '', 
              notes: '',
              separation_date: '',
              address: '',
              difficult_aspects: '',
              friction_situations: '',
              legal_matters: '',
              safety_concerns: '',
              substance_mental_health: '',
              neglect_abuse_concerns: '',
              additional_thoughts: '',
              other_parent: ''
            });
            // Refresh list after a short delay to ensure server has saved
            setTimeout(() => {
              loadContacts(); // Refresh list
              loadOnboardingStatus(); // Update onboarding status
              loadCoparentName(); // Reload coparent name
            }, 100);
          } else {
            // Show detailed error message
            const errorMessage = data.error || data.message || `Failed to save contact (Status: ${response.status})`;
            console.error('Contact save failed:', {
              status: response.status,
              statusText: response.statusText,
              error: data.error,
              data: data
            });
            setError(errorMessage);
          }
        } catch (err) {
          console.error('Error saving contact:', err);
          // More detailed error message
          const errorMessage = err.message || 'Failed to save contact. Please check your connection and try again.';
          setError(errorMessage);
          
          // Log full error for debugging
          console.error('Full error details:', {
            name: err.name,
            message: err.message,
            stack: err.stack
          });
        } finally {
          setIsSavingContact(false);
        }
      };

      // Delete contact
      const handleDeleteContact = async (contactId) => {
        if (!username || !window.confirm('Are you sure you want to delete this contact?')) return;

        try {
          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/contacts/${contactId}?username=${encodeURIComponent(username)}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          const data = await response.json();
          if (response.ok) {
            loadContacts(); // Refresh list
            loadCoparentName(); // Reload coparent name
          } else {
            setError(data.error || 'Failed to delete contact');
          }
        } catch (err) {
          console.error('Error deleting contact:', err);
          setError('Failed to delete contact. Please try again.');
        }
      };

      // Edit contact
      const handleEditContact = (contact) => {
        setEditingContact(contact);
        // Map "co-parent" back to "My Co-Parent" for display in dropdown
        const relationshipDisplay = contact.relationship === 'co-parent' ? 'My Co-Parent' : (contact.relationship || '');
        setContactFormData({
          contact_name: contact.contact_name || '',
          contact_email: contact.contact_email || '',
          relationship: relationshipDisplay,
          notes: contact.notes || '',
          separation_date: contact.separation_date || '',
          address: contact.address || '',
          difficult_aspects: contact.difficult_aspects || '',
          friction_situations: contact.friction_situations || '',
          legal_matters: contact.legal_matters || '',
          safety_concerns: contact.safety_concerns || '',
          substance_mental_health: contact.substance_mental_health || '',
          neglect_abuse_concerns: contact.neglect_abuse_concerns || '',
          additional_thoughts: contact.additional_thoughts || '',
          other_parent: contact.other_parent || ''
        });
        setShowContactForm(true);
      };

      // Logout
      const handleLogout = async () => {
        try {
          // Call logout endpoint to clear cookie on server
          await fetch(`${window.API_URL || 'http://localhost:3001'}/api/auth/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (err) {
          console.error('Error logging out:', err);
        }
        
        // Disconnect socket
        if (socketRef.current) {
          socketRef.current.disconnect();
        }
        
        // Clear all authentication data from localStorage
        localStorage.removeItem('chatUser');
        localStorage.removeItem('username');
        localStorage.removeItem('isAuthenticated');
        localStorage.removeItem('auth_token_backup');
        localStorage.removeItem('currentView');
        
        setIsAuthenticated(false);
        setIsJoined(false);
        setUsername('');
        setCurrentViewState('chat');
        window.location.href = '/';
      };

      // Handle joining a room via the dedicated join modal
      const handleManualJoinRoom = async () => {
        const trimmedCode = joinRoomCode.trim();
        if (!trimmedCode) {
          setJoinRoomStatus({ type: 'error', message: 'Please enter an invite code.' });
          return;
        }

        setIsJoinRoomProcessing(true);
        setJoinRoomStatus(null);

        const result = await acceptInviteCode(trimmedCode);
        if (result.success) {
          setJoinRoomStatus({ type: 'success', message: 'Joined room successfully!' });
          setJoinRoomCode('');
          setTimeout(() => {
            setShowJoinRoomModal(false);
            setJoinRoomStatus(null);
          }, 1500);
        } else {
          setJoinRoomStatus({ type: 'error', message: result.message });
        }

        setIsJoinRoomProcessing(false);
      };


      if (!isAuthenticated) {
        // Show loading state while checking authentication to prevent flash of wrong content
        if (isCheckingAuth) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-blue-50 flex items-center justify-center">
              <div className="text-center">
                <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
                <p className="text-gray-600">Loading...</p>
              </div>
            </div>
          );
        }
        
        // Show landing page first, then login form when user clicks CTA
        if (showLandingPage && !pendingInviteCode) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-blue-50">
              {/* Navigation */}
              <header>
              <nav className="bg-white shadow-sm" role="navigation" aria-label="Main navigation">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center h-16">
                    <div className="flex items-center gap-3">
                      <img 
                        src="./assets/CEECE0%20(8).svg" 
                        alt="LiaiZen Logo" 
                        className="w-10 h-10 object-contain"
                      />
                      <span className="text-2xl font-bold text-primary">LiaiZen</span>
                    </div>
                    <div className="flex items-center gap-4">
                      <button
                        onClick={() => {
                          setShowLandingPage(false);
                          setIsLoginMode(true);
                        }}
                        className="text-primary hover:text-primary-dark font-medium"
                      >
                        Sign In
                      </button>
                      <button
                        onClick={() => {
                          setShowLandingPage(false);
                          setIsLoginMode(false);
                        }}
                        className="bg-primary text-white px-6 py-2 rounded-lg font-semibold hover:bg-primary-dark transition-colors"
                      >
                        Get Started
                      </button>
                    </div>
                  </div>
                </div>
              </nav>
              </header>

              {/* Hero Section */}
              <main>
              <section className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20" aria-label="Hero section">
                <div className="text-center">
                  <h1 className="text-5xl md:text-6xl font-bold text-gray-900 mb-6">
                    Better Co-Parenting
                    <span className="block text-primary">Through Better Communication</span>
                  </h1>
                  <p className="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">
                    LiaiZen helps separated parents communicate effectively with AI-powered mediation 
                    and tools designed to improve outcomes for you and your children.
                  </p>
                  <div className="flex flex-col sm:flex-row gap-4 justify-center">
                    <button
                      onClick={() => {
                        setShowLandingPage(false);
                        setIsLoginMode(false);
                      }}
                      className="bg-primary text-white px-8 py-4 rounded-xl font-semibold text-lg hover:bg-primary-dark transition-colors shadow-lg hover:shadow-xl"
                    >
                      Start Free Trial
                    </button>
                    <button
                      onClick={() => {
                        setShowLandingPage(false);
                        setIsLoginMode(true);
                      }}
                      className="bg-white text-primary border-2 border-primary px-8 py-4 rounded-xl font-semibold text-lg hover:bg-primary hover:text-white transition-colors"
                    >
                      Sign In
                    </button>
                  </div>
                </div>
              </section>

              {/* Features Section */}
              <section className="bg-white py-20" aria-label="Features">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <h2 className="text-4xl font-bold text-center text-gray-900 mb-12">
                    Everything You Need for Successful Co-Parenting
                  </h2>
                  <div className="grid md:grid-cols-3 gap-8">
                    {/* Feature 1 */}
                    <article className="text-center p-6 rounded-xl bg-gradient-to-br from-teal-50 to-blue-50">
                      <div className="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                      </div>
                      <h3 className="text-xl font-bold text-gray-900 mb-2">AI-Powered Mediation</h3>
                      <p className="text-gray-600">
                        Our AI analyzes messages in real-time, suggesting tone improvements and conflict resolution strategies to keep conversations productive.
                      </p>
                    </article>

                    {/* Feature 2 */}
                    <article className="text-center p-6 rounded-xl bg-gradient-to-br from-blue-50 to-teal-50">
                      <div className="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                      </div>
                      <h3 className="text-xl font-bold text-gray-900 mb-2">Child-Centered</h3>
                      <p className="text-gray-600">
                        Every feature is designed with your children's best interests in mind, helping you create a stable and supportive environment for them.
                      </p>
                    </article>

                    {/* Feature 3 */}
                    <article className="text-center p-6 rounded-xl bg-gradient-to-br from-teal-50 to-blue-50">
                      <div className="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </div>
                      <h3 className="text-xl font-bold text-gray-900 mb-2">Integrated Tools</h3>
                      <p className="text-gray-600">
                        Shared calendar, expense tracking, and document sharing all in one platform designed specifically for co-parents.
                      </p>
                    </article>
                  </div>
                </div>
              </section>

              {/* Benefits Section */}
              <section 
                className="bg-gradient-to-br from-primary to-secondary py-20 text-white" 
                aria-label="Benefits"
                style={{background: 'linear-gradient(to bottom right, #275559, #4DA8B0)'}}
              >
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <h2 className="text-4xl font-bold text-center mb-12">
                    Why Choose LiaiZen?
                  </h2>
                  <div className="grid md:grid-cols-2 gap-8">
                    <div className="flex gap-4">
                      <div className="flex-shrink-0">
                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                      </div>
                      <div>
                        <h3 className="text-xl font-bold mb-2">Reduce Conflict</h3>
                        <p className="text-white text-opacity-90">
                          AI-powered suggestions help you communicate more effectively, reducing misunderstandings and tension.
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-4">
                      <div className="flex-shrink-0">
                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                      </div>
                      <div>
                        <h3 className="text-xl font-bold mb-2">Focus on Your Children</h3>
                        <p className="text-white text-opacity-90">
                          Spend less time on communication logistics and more time focusing on what matters most - your kids.
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-4">
                      <div className="flex-shrink-0">
                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                      </div>
                      <div>
                        <h3 className="text-xl font-bold mb-2">Document Everything</h3>
                        <p className="text-white text-opacity-90">
                          Keep a complete record of all communications, which can be helpful for legal or mediation purposes.
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-4">
                      <div className="flex-shrink-0">
                        <div className="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                      </div>
                      <div>
                        <h3 className="text-xl font-bold mb-2">Easy to Use</h3>
                        <p className="text-white text-opacity-90">
                          Intuitive interface designed for busy parents. Get started in minutes, not hours.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              {/* CTA Section */}
              <section className="bg-white py-20" aria-label="Call to action">
                <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                  <h2 className="text-4xl font-bold text-gray-900 mb-4">
                    Ready to Improve Your Co-Parenting Communication?
                  </h2>
                  <p className="text-xl text-gray-600 mb-8">
                    Be among the first to experience a new way of co-parenting communication designed to improve outcomes for you and your children.
                  </p>
                  <button
                    onClick={() => {
                      setShowLandingPage(false);
                      setIsLoginMode(false);
                    }}
                    className="bg-primary text-white px-10 py-4 rounded-xl font-semibold text-lg hover:bg-primary-dark transition-colors shadow-lg hover:shadow-xl"
                  >
                    Get Started Free
                  </button>
                </div>
              </section>
              </main>

              {/* Footer */}
              <footer className="bg-gray-900 text-white py-12">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="grid md:grid-cols-3 gap-8">
                    <div>
                      <div className="flex items-center gap-2 mb-4">
                        <img 
                          src="./assets/CEECE0%20(8).svg" 
                          alt="LiaiZen Logo" 
                          className="w-8 h-8 object-contain"
                        />
                        <span className="text-xl font-bold">LiaiZen</span>
                      </div>
                      <p className="text-gray-400">
                        Better co-parenting through better communication.
                      </p>
                    </div>
                    <div>
                      <h4 className="font-semibold mb-4">Legal</h4>
                      <ul className="space-y-2 text-gray-400">
                        <li><a href="/privacy" className="hover:text-white transition-colors">Privacy Policy</a></li>
                        <li><a href="/terms" className="hover:text-white transition-colors">Terms of Service</a></li>
                      </ul>
                    </div>
                    <div>
                      <h4 className="font-semibold mb-4">Support</h4>
                      <p className="text-gray-400">
                        Need help? Contact us at info@liaizen.com
                      </p>
                    </div>
                  </div>
                  <div className="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                    <p>Â© 2025 LiaiZen. All rights reserved.</p>
                  </div>
                </div>
              </footer>
            </div>
          );
        }

        // Show login/signup form
        return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 w-full max-w-md mx-auto">
              {/* Back to landing page button */}
              {!pendingInviteCode && (
                <button
                  onClick={() => setShowLandingPage(true)}
                  className="mb-4 text-primary hover:text-primary-dark flex items-center gap-2 text-sm"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                  </svg>
                  Back to Home
                </button>
              )}
              {pendingInviteCode && (
                <div className="mb-6 bg-green-light border border-green rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <svg className="w-6 h-6 text-green-dark flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                      <p className="text-sm font-semibold text-green-dark">You have a pending invite!</p>
                      <p className="text-xs text-green mt-1">
                        {isLoginMode ? 'Sign in to accept your invite, or create a new account below.' : 'Create an account to accept your invite, or sign in if you already have one.'}
                      </p>
                    </div>
                  </div>
                </div>
              )}
              <div className="flex flex-col items-center justify-center gap-2 mb-6">
                <img 
                  src="./assets/TransB.svg" 
                  alt="LiaiZen" 
                  className="h-8 object-contain"
                  style={{ maxHeight: '32px' }}
                />
                <img 
                  src="./assets/LZlogo.svg" 
                  alt="LiaiZen Logo" 
                  className="h-20 object-contain"
                  style={{ maxHeight: '80px' }}
                />
              </div>
              <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">
                {isLoginMode ? 'Login' : 'Sign Up'}
              </h1>

              {error && (
                <div className="bg-pink-light border border-pink text-pink-dark px-4 py-3 rounded-lg mb-4 flex items-center gap-2">
                  <AlertCircle className="w-5 h-5 flex-shrink-0" />
                  <span className="text-sm">{error}</span>
                </div>
              )}
              
              <form onSubmit={isLoginMode ? handleLogin : handleSignup}>
                  <input
                    type="email"
                    placeholder="Email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                  autoComplete="email"
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal transition-colors mb-4"
                  autoFocus
                  />
                <input
                  type="password"
                  placeholder="Password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  autoComplete={isLoginMode ? "current-password" : "new-password"}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal transition-colors mb-4"
                />
                <button
                  type="submit"
                  disabled={isLoggingIn || isSigningUp}
                  className="w-full bg-teal text-white py-3 rounded-xl font-semibold hover:bg-teal transition-colors shadow-soft hover:shadow-soft-lg disabled:bg-gray-400 disabled:cursor-not-allowed mb-4 flex items-center justify-center gap-2"
                >
                  {(isLoginMode ? isLoggingIn : isSigningUp) ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                      Processing...
                    </>
                  ) : (
                    isLoginMode ? 'Login' : 'Sign Up'
                  )}
                </button>
              </form>

              <div className="relative my-6">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-gray-300"></div>
                </div>
                <div className="relative flex justify-center text-sm">
                  <span className="px-2 bg-white text-gray-500">Or</span>
                </div>
              </div>

              <button
                onClick={async () => {
                  setError('');
                  try {
                    const apiUrl = window.API_URL || 'http://localhost:3001';
                    console.log('Attempting Google Sign-In with API URL:', apiUrl);
                    
                    // Get auth URL from backend
                    const response = await fetch(`${apiUrl}/api/auth/google`, {
                      method: 'GET',
                      credentials: 'include'
                    });
                    
                    // Check if response is OK before parsing JSON
                    if (!response.ok) {
                      // Try to parse error message
                      let errorMessage = 'Failed to initiate Google Sign-In';
                      try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                      } catch (e) {
                        // If JSON parsing fails, use status text
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                      }
                      
                      // Provide helpful message for common issues
                      if (response.status === 500 && errorMessage.includes('not configured')) {
                        setError('Google Sign-In is not configured on the server. Please contact support.');
                      } else {
                        setError(errorMessage);
                      }
                      console.error('Google Sign-In API error:', response.status, errorMessage);
                      return;
                    }
                    
                    const data = await response.json();
                    
                    if (!data.authUrl) {
                      setError('Invalid response from server. Please try again.');
                      console.error('Missing authUrl in response:', data);
                      return;
                    }

                    // Redirect to Google OAuth
                    console.log('Redirecting to Google OAuth:', data.authUrl);
                    window.location.href = data.authUrl;
                  } catch (err) {
                    // Network errors or other exceptions
                    if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                      setError('Unable to connect to server. Make sure the backend server is running on port 3001.');
                    } else if (err instanceof SyntaxError) {
                      setError('Invalid response from server. Please check the server logs.');
                    } else {
                      setError(`Error: ${err.message || 'Unable to connect to server. Please try again.'}`);
                    }
                    console.error('Google Sign-In error:', err);
                  }
                }}
                className="w-full flex items-center justify-center gap-3 px-4 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-colors mb-4"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span className="text-gray-700 font-medium">Sign in with Google</span>
              </button>

              <div className="text-center">
                <button
                  onClick={() => {
                    setIsLoginMode(!isLoginMode);
                    setError('');
                    setEmail(''); // Clear email when switching modes
                    setPassword(''); // Clear password when switching modes
                  }}
                  className="text-teal hover:text-teal-dark text-sm font-medium"
                >
                  {isLoginMode ? "Don't have an account? Sign up" : 'Already have an account? Login'}
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <>
        {/* Success Message - Connection Established */}
        {connectionSuccess && (
          <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-down">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" />
            </svg>
            <span className="font-semibold">Connection established! You're now connected with your co-parent.</span>
          </div>
        )}

        {/* Modals - render at top level so they can show anytime */}
        {/* Context Setup Prompt - Non-blocking banner */}
        {showContextPrompt && !isJoined && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="bg-white rounded-3xl shadow-soft-lg w-full max-w-2xl my-4">
              <div className="bg-blue text-white px-6 py-4 rounded-t-3xl shadow-soft">
                <h2 className="text-2xl font-bold">Set Up Your Context (Optional)</h2>
                <p className="text-white opacity-90 mt-1">Help the AI mediator understand your situation</p>
              </div>
              <div className="p-6">
                <p className="text-gray-700 mb-6">
                  Adding context helps the AI mediator provide better support. You can always add this later in your profile settings.
                </p>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowSettings(true);
                      setShowContextPrompt(false);
                    }}
                    className="flex-1 bg-orange text-white py-3 rounded-xl font-semibold hover:bg-orange transition-colors shadow-neumorphic"
                  >
                    Set Up Context
                  </button>
                  <button
                    onClick={() => {
                      setShowContextPrompt(false);
                      setHasContext(false);
                      // Join chat room immediately - context is optional
                      if (socketRef.current && socketRef.current.connected) {
                        socketRef.current.emit('join', { username });
                      } else {
                        shouldAutoJoinRef.current = true;
                      }
                    }}
                    className="px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition-colors"
                  >
                    Skip for Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Non-blocking context suggestion banner (shown when in chat) */}
        {showContextPrompt && isJoined && !hasContext && (
          <div className="bg-teal-light border-l-4 border-teal p-4 mb-4 rounded-xl shadow-soft">
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <h3 className="text-sm font-semibold text-teal mb-1">Enhance AI Mediation</h3>
                <p className="text-sm text-teal">
                  Add context about your co-parenting situation to help the AI provide better support.
                </p>
              </div>
              <div className="flex gap-2 ml-4">
                <button
                  onClick={() => {
                    setShowSettings(true);
                    setShowContextPrompt(false);
                  }}
                  className="px-4 py-2 bg-orange text-white text-sm rounded-xl font-semibold hover:bg-orange transition-colors shadow-neumorphic"
                >
                  Add Context
                </button>
                <button
                  onClick={() => {
                    setShowContextPrompt(false);
                  }}
                  className="px-4 py-2 text-blue text-sm font-semibold hover:text-blue-dark transition-colors"
                >
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Profile/Settings Modal */}
        {showSettings && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="card-neumorphic w-full max-w-2xl max-h-[90vh] overflow-y-auto my-4">
              <div className="sticky top-0 bg-blue text-white px-6 py-4 rounded-t-3xl flex items-center justify-between shadow-soft">
                <div className="flex items-center gap-3">
                  <User className="w-6 h-6" />
                  <div>
                    <h2 className="text-2xl font-bold">Profile</h2>
                    <p className="text-sm text-white opacity-90">{username}</p>
                  </div>
                </div>
                <button
                  onClick={() => setShowSettings(false)}
                  className="text-white hover:text-gray-200 text-2xl font-bold"
                >
                  Ã—
                </button>
              </div>

              <div className="p-6">
                {/* Profile Section */}
                <div className="mb-6 pb-6 border-b border-gray-200">
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">Account Information</h3>
                  <div className="space-y-2">
                    <div className="flex items-center gap-3">
                      <div className={`w-12 h-12 rounded-full ${stringToColor(username)} flex items-center justify-center text-white font-bold text-lg`}>
                        {username.charAt(0).toUpperCase()}
                      </div>
                      <div>
                        <p className="font-semibold text-gray-800">Username</p>
                        <p className="text-sm text-gray-600">{username}</p>
                      </div>
                    </div>
                  </div>
                </div>

                <h3 className="text-lg font-semibold text-gray-800 mb-4">Co-Parenting Context</h3>
                <p className="text-sm text-gray-600 mb-6">
                  Help the AI mediator understand your situation by providing context about your co-parenting relationship.
                </p>

                <div className="space-y-6">
                  {/* Co-Parent Name */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Co-Parent Name
                    </label>
                    <input
                      type="text"
                      placeholder="Name of the person you're co-parenting with"
                      value={userContextData.coParentName}
                      onChange={(e) => setUserContextData(prev => ({ ...prev, coParentName: e.target.value }))}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue transition-colors shadow-neumorphic-inset"
                    />
                  </div>

                  {/* Separation Date */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      Date of Separation / Living Apart
                    </label>
                    <input
                      type="date"
                      value={userContextData.separationDate}
                      onChange={(e) => setUserContextData(prev => ({ ...prev, separationDate: e.target.value }))}
                      className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue transition-colors shadow-neumorphic-inset"
                    />
                  </div>

                  {/* Children */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <label className="block text-sm font-semibold text-gray-700">
                        Children (Shared Custody)
                      </label>
                      <button
                        onClick={addChild}
                        className="text-blue hover:text-blue-dark text-sm font-medium"
                      >
                        + Add Child
                      </button>
                    </div>
                    <div className="space-y-3">
                      {userContextData.children.map((child, index) => (
                        <div key={index} className="flex gap-2">
                          <input
                            type="text"
                            placeholder="Child name"
                            value={child.name}
                            onChange={(e) => updateChild(index, 'name', e.target.value)}
                            className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue"
                          />
                          <input
                            type="text"
                            placeholder="Birthday (e.g., 2015-03-15)"
                            value={child.birthday}
                            onChange={(e) => updateChild(index, 'birthday', e.target.value)}
                            className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue"
                          />
                          {userContextData.children.length > 1 && (
                            <button
                              onClick={() => removeChild(index)}
                              className="px-3 py-2 bg-pink-dark text-white rounded-lg hover:bg-pink-dark"
                            >
                              Ã—
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Concerns */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <label className="block text-sm font-semibold text-gray-700">
                        Concerns
                      </label>
                      <button
                        onClick={addConcern}
                        className="text-blue hover:text-blue-dark text-sm font-medium"
                      >
                        + Add Concern
                      </button>
                    </div>
                    <div className="space-y-2">
                      {userContextData.concerns.map((concern, index) => (
                        <div key={index} className="flex items-center gap-2">
                          <span className="flex-1 px-4 py-2 bg-gray-100 rounded-lg">{concern}</span>
                          <button
                            onClick={() => removeConcern(index)}
                            className="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                          >
                            Ã—
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* New Partner */}
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                      New Partner
                    </label>
                    <div className="space-y-3">
                      <input
                        type="text"
                        placeholder="Partner name"
                        value={userContextData.newPartner.name}
                        onChange={(e) => setUserContextData(prev => ({
                          ...prev,
                          newPartner: { ...prev.newPartner, name: e.target.value }
                        }))}
                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue transition-colors shadow-neumorphic-inset"
                      />
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={userContextData.newPartner.livesWith}
                          onChange={(e) => setUserContextData(prev => ({
                            ...prev,
                            newPartner: { ...prev.newPartner, livesWith: e.target.checked }
                          }))}
                          className="w-4 h-4"
                        />
                        <span className="text-sm text-gray-700">Lives with them</span>
                      </label>
                    </div>
                  </div>

                  {/* Join Existing Room */}
                  <div className="p-4 bg-teal-light border border-teal rounded-lg">
                    <h4 className="text-sm font-semibold text-teal-dark mb-1">Join an Existing Room</h4>
                    <p className="text-xs text-gray-600 mb-3">
                      Have an invite code from your co-parent? Enter it here to join their private chat room.
                    </p>
                    <div className="flex flex-col sm:flex-row gap-3">
                      <input
                        type="text"
                        placeholder="Enter invite code"
                        value={contextInviteCode}
                        onChange={(e) => {
                          setContextInviteCode(e.target.value);
                          if (contextInviteStatus) setContextInviteStatus(null);
                        }}
                        className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal font-mono text-sm"
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            e.preventDefault();
                            handleJoinRoomFromContext();
                          }
                        }}
                      />
                      <button
                        onClick={handleJoinRoomFromContext}
                        disabled={isJoiningRoom}
                        className="px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primary transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                        style={{ borderRadius: '8px' }}
                      >
                        {isJoiningRoom ? 'Joiningâ€¦' : 'Join Room'}
                      </button>
                    </div>
                    {contextInviteStatus && (
                      <p
                        className={`text-xs mt-2 ${
                          contextInviteStatus.type === 'success' ? 'text-green-600' : 'text-red-600'
                        }`}
                      >
                        {contextInviteStatus.message}
                      </p>
                    )}
                  </div>

                  {/* Generate Invite Code */}
                  <div className="p-4 bg-teal-light border border-teal rounded-xl space-y-4 shadow-soft">
                    <div>
                      <h4 className="text-sm font-semibold text-teal-dark mb-1">Generate Invite Code</h4>
                      <p className="text-xs text-gray-600 mb-3">
                        Generate a single-use invite code to share manually.
                      </p>
                      <button
                        onClick={() => {
                          setShowSettings(false);
                          handleCreateInvite();
                        }}
                        disabled={isCreatingInvite}
                        className="w-full px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-primary transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-neumorphic"
                        style={{ borderRadius: '8px' }}
                      >
                        {isCreatingInvite ? (
                          <>
                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                            Generating Code...
                          </>
                        ) : (
                          <>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            Generate Code
                          </>
                        )}
                      </button>
                    </div>
                  </div>

                  {/* Save Button */}
                  <div className="flex gap-3 pt-4">
                    <button
                      onClick={handleSaveContext}
                      disabled={isSavingContext}
                      className="flex-1 bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      {isSavingContext ? (
                        <>
                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                          Saving...
                        </>
                      ) : (
                        'Save Context'
                      )}
                    </button>
                    <button
                      onClick={() => setShowSettings(false)}
                      className="px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Join Room Modal */}
        {showJoinRoomModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="bg-white rounded-3xl shadow-soft-lg w-full max-w-md my-4">
              <div className="bg-primary text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <h2 className="text-2xl font-bold">Join an Existing Room</h2>
                <button
                  onClick={() => {
                    setShowJoinRoomModal(false);
                    setJoinRoomStatus(null);
                    setJoinRoomCode('');
                  }}
                  className="text-white hover:text-gray-200 text-2xl font-bold transition-colors"
                >
                  Ã—
                </button>
              </div>
              <div className="p-6 space-y-4">
                <p className="text-gray-700">
                  Enter the invite code shared with you to join a co-parent's private chat room.
                </p>
                <input
                  type="text"
                  placeholder="Invite code"
                  value={joinRoomCode}
                  onChange={(e) => {
                    setJoinRoomCode(e.target.value);
                    if (joinRoomStatus) setJoinRoomStatus(null);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      handleManualJoinRoom();
                    }
                  }}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal font-mono text-sm"
                />
                {joinRoomStatus && (
                  <div
                    className={`text-sm px-4 py-3 rounded-lg flex items-center gap-2 ${
                      joinRoomStatus.type === 'success'
                        ? 'bg-green-50 text-green-700 border border-green-200'
                        : 'bg-red-50 text-red-700 border border-red-200'
                    }`}
                  >
                    {joinRoomStatus.type === 'success' ? (
                      <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                      </svg>
                    ) : (
                      <AlertCircle className="w-4 h-4 flex-shrink-0" />
                    )}
                    <span>{joinRoomStatus.message}</span>
                  </div>
                )}
                <div className="flex gap-3 pt-2">
                  <button
                    onClick={handleManualJoinRoom}
                    disabled={isJoinRoomProcessing}
                    className="flex-1 bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    style={{ borderRadius: '8px' }}
                  >
                    {isJoinRoomProcessing ? (
                      <>
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        Joining...
                      </>
                    ) : (
                      'Join Room'
                    )}
                  </button>
                  <button
                    onClick={() => {
                      setShowJoinRoomModal(false);
                      setJoinRoomStatus(null);
                      setJoinRoomCode('');
                    }}
                    className="px-6 py-3 bg-white border-2 border-teal text-teal rounded-lg font-semibold hover:bg-teal-light transition-colors"
                    style={{ borderRadius: '8px' }}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Invite Modal */}
        {showInviteModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                <div className="card-neumorphic w-full max-w-lg my-auto max-h-[90vh] overflow-y-auto">
              <div className="bg-primary text-white px-4 sm:px-6 py-3 sm:py-4 rounded-t-3xl flex items-center justify-between shadow-soft">
                <h2 className="text-xl sm:text-2xl font-bold">Invite Your Co-Parent</h2>
                <button
                  onClick={() => {
                    setShowInviteModal(false);
                    setCopiedCode(false);
                  }}
                  className="text-white hover:text-gray-200 text-2xl font-bold transition-colors"
                >
                  Ã—
                </button>
              </div>
              <div className="p-4 sm:p-6">
                <p className="text-gray-700 mb-4 text-sm sm:text-base">
                  Share this invite code with your co-parent. They can enter it in the chat to join your private room:
                </p>
                <div className="bg-teal-light border-2 border-teal p-4 sm:p-6 rounded-2xl mb-4 text-center shadow-neumorphic">
                  <p className="text-xs text-teal-dark mb-2 font-semibold uppercase tracking-wide">Invite Code</p>
                  <div className="text-2xl sm:text-3xl md:text-4xl font-bold text-primary font-mono tracking-wider mb-2 break-all">
                    {inviteCode}
                </div>
                  <p className="text-xs text-gray-500">
                    Valid for 7 days â€¢ Single use only
                  </p>
                </div>
                <div className="flex flex-col sm:flex-row gap-3">
                  <button
                    onClick={handleCopyInviteCode}
                    className="flex-1 bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors flex items-center justify-center gap-2 shadow-neumorphic"
                    style={{ borderRadius: '8px' }}
                  >
                    {copiedCode ? (
                      <>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        Copied!
                      </>
                    ) : (
                      <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                        Copy Code
                      </>
                    )}
                  </button>
                  <button
                    onClick={() => {
                      setShowInviteModal(false);
                      setCopiedCode(false);
                    }}
                    className="px-4 sm:px-6 py-3 bg-white border-2 border-teal text-teal rounded-lg font-semibold hover:bg-teal-light transition-colors"
                    style={{ borderRadius: '8px' }}
                  >
                    Close
                  </button>
                </div>
                <p className="text-xs text-gray-500 mt-4 text-center">
                  Your co-parent can enter this code using the "Join Room" button in the chat.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Invite Accept Modal */}
        {showInviteAcceptModal && pendingInviteCode && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="bg-white rounded-3xl shadow-soft-lg w-full max-w-md my-4">
              <div className="bg-primary text-white px-6 py-4 rounded-t-2xl">
                <h2 className="text-2xl font-bold flex items-center gap-2">
                  <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  You've Been Invited!
                </h2>
              </div>
              <div className="p-6">
                <p className="text-gray-700 mb-4 text-lg">
                  You've been invited to join a <strong>private co-parenting chat room</strong>.
                </p>
                <div className="bg-teal-light border border-teal rounded-lg p-4 mb-6">
                  <p className="text-sm text-teal-dark">
                    {isAuthenticated
                      ? 'âœ“ You are logged in! Click "Accept Invite" below to join the room.'
                      : 'ðŸ‘¤ Create an account or sign in to activate your invite and join the private chat room.'}
                  </p>
                </div>
                <div className="flex gap-3">
                  {isAuthenticated ? (
                    <>
                      <button
                        onClick={handleAcceptInvite}
                        className="flex-1 bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors flex items-center justify-center gap-2"
                        style={{ borderRadius: '8px' }}
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        Accept Invite
                      </button>
                      <button
                        onClick={() => {
                          setShowInviteAcceptModal(false);
                          setPendingInviteCode(null);
                          window.history.replaceState({}, document.title, window.location.pathname);
                        }}
                        className="px-6 py-3 bg-white border-2 border-teal text-teal rounded-lg font-semibold hover:bg-teal-light transition-colors"
                        style={{ borderRadius: '8px' }}
                      >
                        Decline
                      </button>
                    </>
                  ) : (
                    <button
                      onClick={() => setShowInviteAcceptModal(false)}
                      className="flex-1 bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors shadow-neumorphic"
                      style={{ borderRadius: '8px' }}
                    >
                      Continue
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* No Co-Parent Connection Modal */}
        {showNoCoparentModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className="bg-white rounded-3xl shadow-soft-lg w-full max-w-md my-4">
              <div className="bg-primary text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <h2 className="text-2xl font-bold">Connect with Your Co-Parent</h2>
                <button
                  onClick={() => {
                    setShowNoCoparentModal(false);
                  }}
                  className="text-white hover:text-gray-200 text-2xl font-bold transition-colors"
                >
                  Ã—
                </button>
              </div>
              <div className="p-6 space-y-4">
                <p className="text-gray-700 text-lg">
                  You need to connect with your co-parent before you can start chatting. Choose an option below:
                </p>
                
                {/* Option 1: Create Invite Code */}
                <div className="p-4 bg-teal-light border border-teal rounded-xl">
                  <h3 className="text-lg font-semibold text-teal-dark mb-2">Create an Invite Code</h3>
                  <p className="text-sm text-gray-600 mb-3">
                    Generate a code to share with your co-parent. They'll use it to join your chat room.
                  </p>
                  <button
                    onClick={async () => {
                      setShowNoCoparentModal(false);
                      await handleCreateInvite();
                    }}
                    disabled={isCreatingInvite}
                    className="w-full px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-primary transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    style={{ borderRadius: '8px' }}
                  >
                    {isCreatingInvite ? (
                      <>
                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                        Creating...
                      </>
                    ) : (
                      <>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        Create Invite Code
                      </>
                    )}
                  </button>
                </div>

                {/* Option 2: Enter Invite Code */}
                <div className="p-4 bg-teal-light border border-teal rounded-xl">
                  <h3 className="text-lg font-semibold text-teal-dark mb-2">Enter an Invite Code</h3>
                  <p className="text-sm text-gray-600 mb-3">
                    Have a code from your co-parent? Enter it here to join their chat room.
                  </p>
                  <div className="space-y-3">
                    <input
                      type="text"
                      placeholder="Enter invite code"
                      value={joinRoomCode}
                      onChange={(e) => {
                        setJoinRoomCode(e.target.value);
                        if (joinRoomStatus) setJoinRoomStatus(null);
                      }}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          e.preventDefault();
                          handleManualJoinRoom();
                        }
                      }}
                      className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal font-mono text-sm"
                    />
                    {joinRoomStatus && (
                      <div
                        className={`text-sm px-4 py-3 rounded-lg flex items-center gap-2 ${
                          joinRoomStatus.type === 'success'
                            ? 'bg-green-50 text-green-700 border border-green-200'
                            : 'bg-red-50 text-red-700 border border-red-200'
                        }`}
                      >
                        {joinRoomStatus.type === 'success' ? (
                          <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        ) : (
                          <AlertCircle className="w-4 h-4 flex-shrink-0" />
                        )}
                        <span>{joinRoomStatus.message}</span>
                      </div>
                    )}
                    <button
                      onClick={async () => {
                        await handleManualJoinRoom();
                        if (joinRoomStatus && joinRoomStatus.type === 'success') {
                          setTimeout(() => {
                            setShowNoCoparentModal(false);
                            setCurrentView('chat');
                          }, 1500);
                        }
                      }}
                      disabled={isJoinRoomProcessing || !joinRoomCode.trim()}
                      className="w-full px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-primary transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                      style={{ borderRadius: '8px' }}
                    >
                      {isJoinRoomProcessing ? (
                        <>
                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                          Joining...
                        </>
                      ) : (
                        'Join Room'
                      )}
                    </button>
                  </div>
                </div>

                <button
                  onClick={() => {
                    setShowNoCoparentModal(false);
                  }}
                  className="w-full px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors"
                  style={{ borderRadius: '8px' }}
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Navigation Component - Only show when authenticated */}
        {isAuthenticated && (
          <nav className="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 shadow-sm md:flex md:items-center md:justify-between px-4 py-3" style={{ zIndex: 100 }}>
            <div className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-2">
                <img 
                  src="./assets/CEECE0%20(8).svg" 
                  alt="LiaiZen Logo" 
                  className="w-8 h-8 object-contain"
                  style={{ maxWidth: '32px', maxHeight: '32px' }}
                />
                <h1 className="text-lg sm:text-xl font-bold text-gray-900 truncate">LiaiZen</h1>
              </div>
              {/* Mobile menu button - hidden on desktop */}
              <div className="md:hidden relative user-menu-container" style={{ zIndex: 102 }}>
                <button
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Mobile menu button clicked, current state:', showUserMenu);
                    setShowUserMenu(prev => {
                      const newState = !prev;
                      console.log('Setting showUserMenu to:', newState);
                      return newState;
                    });
                  }}
                  className="text-gray-600 hover:text-gray-900 transition-colors"
                  aria-label="Menu"
                  type="button"
                  style={{ pointerEvents: 'auto' }}
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{ pointerEvents: 'none' }}>
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" style={{ pointerEvents: 'none' }} />
                  </svg>
                </button>
                
                {/* Mobile Dropdown Menu */}
                {showUserMenu && (
                  <div
                    className="absolute right-0 mt-2 w-48 max-w-[calc(100vw-2rem)] bg-white rounded-lg shadow-lg border border-gray-200 py-1 user-menu-dropdown"
                    style={{ zIndex: 1002, position: 'absolute' }}
                    onClick={(e) => {
                      e.stopPropagation();
                    }}
                  >
                    <button
                      onClick={() => {
                        setCurrentView('profile');
                        setShowUserMenu(false);
                      }}
                      className={`w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2 ${
                        currentView === 'profile' 
                          ? 'bg-gray-100 text-primary font-semibold' 
                          : 'text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      <User className="w-4 h-4" />
                      Profile
                    </button>
                    <button
                      onClick={() => {
                        setCurrentView('contacts');
                        setShowUserMenu(false);
                      }}
                      className={`w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2 ${
                        currentView === 'contacts' 
                          ? 'bg-gray-100 text-primary font-semibold' 
                          : 'text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      <Users className="w-4 h-4" />
                      Contacts
                    </button>
                    <button
                      onClick={() => {
                        setCurrentView('account');
                        setShowUserMenu(false);
                      }}
                      className={`w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2 ${
                        currentView === 'account' 
                          ? 'bg-gray-100 text-primary font-semibold' 
                          : 'text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                      Account
                    </button>
                    <div className="border-t border-gray-200 my-1"></div>
                    <button
                      onClick={() => {
                        setShowUserMenu(false);
                        handleLogout();
                      }}
                      className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                      </svg>
                      Logout
                    </button>
                  </div>
                )}
              </div>
            </div>
            {/* Desktop Navigation */}
            <div className="hidden md:flex items-center gap-2" style={{ position: 'relative', zIndex: 101 }}>
              <button
                onClick={handleChatClick}
                className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                  currentView === 'chat' ? 'bg-primary text-white' : 'text-gray-700 hover:bg-gray-100'
                }`}
                disabled={isCheckingCoparent}
              >
                {isCheckingCoparent ? 'Checking...' : 'Chat'}
              </button>
              <button
                onClick={() => {
                  setCurrentView('dashboard');
                  setShowDashboard(true);
                  loadOnboardingStatus();
                }}
                className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                  currentView === 'dashboard' ? 'bg-primary text-white' : 'text-gray-700 hover:bg-gray-100'
                }`}
              >
                Dashboard
              </button>
              
              {/* User Menu Dropdown */}
              <div className="relative user-menu-container" style={{ zIndex: 102 }}>
                <button
                  onClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Dropdown button clicked, current state:', showUserMenu);
                    setShowUserMenu(prev => {
                      const newState = !prev;
                      console.log('Setting showUserMenu to:', newState);
                      return newState;
                    });
                  }}
                  className="flex items-center gap-2 px-3 py-2 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 transition-colors cursor-pointer"
                  aria-label="User menu"
                  type="button"
                  style={{ pointerEvents: 'auto', position: 'relative', zIndex: 102 }}
                >
                  <div className="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-bold" style={{ pointerEvents: 'none' }}>
                    {username ? username.charAt(0).toUpperCase() : 'U'}
                  </div>
                  <svg 
                    className={`w-4 h-4 transition-transform ${showUserMenu ? 'rotate-180' : ''}`} 
                    fill="none" 
                    stroke="currentColor" 
                    viewBox="0 0 24 24"
                    style={{ pointerEvents: 'none' }}
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" style={{ pointerEvents: 'none' }} />
                  </svg>
                </button>
                
                {/* Dropdown Menu */}
                {showUserMenu && (
                  <div
                    className="absolute right-0 mt-2 w-48 max-w-[calc(100vw-2rem)] bg-white rounded-lg shadow-lg border border-gray-200 py-1 user-menu-dropdown"
                    style={{ zIndex: 1002, position: 'absolute' }}
                    onClick={(e) => {
                      e.stopPropagation();
                    }}
                  >
                  <button
                    onClick={() => {
                      setCurrentView('profile');
                      setShowUserMenu(false);
                    }}
                    className={`w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2 ${
                      currentView === 'profile' 
                        ? 'bg-gray-100 text-primary font-semibold' 
                        : 'text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    <User className="w-4 h-4" />
                    Profile
                  </button>
                  <button
                    onClick={() => {
                      setCurrentView('contacts');
                      setShowUserMenu(false);
                    }}
                    className={`w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2 ${
                      currentView === 'contacts' 
                        ? 'bg-gray-100 text-primary font-semibold' 
                        : 'text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    <Users className="w-4 h-4" />
                    Contacts
                  </button>
                  <button
                    onClick={() => {
                      setCurrentView('account');
                      setShowUserMenu(false);
                    }}
                    className={`w-full text-left px-4 py-2 text-sm transition-colors flex items-center gap-2 ${
                      currentView === 'account' 
                        ? 'bg-gray-100 text-primary font-semibold' 
                        : 'text-gray-700 hover:bg-gray-50'
                    }`}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Account
                  </button>
                  <div className="border-t border-gray-200 my-1"></div>
                  <button
                    onClick={() => {
                      setShowUserMenu(false);
                      handleLogout();
                    }}
                    className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                  </button>
                </div>
              )}
              </div>
            </div>
          </nav>
        )}

        {/* Mobile Navigation - Fixed bottom */}
        {isAuthenticated && (
          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40 md:hidden">
            <div className="flex items-center justify-around py-2">
              <button
                onClick={handleChatClick}
                className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
                  currentView === 'chat' ? 'bg-primary text-white' : 'text-gray-600'
                }`}
                disabled={isCheckingCoparent}
              >
                <MessageCircle className="w-5 h-5" />
                <span className="text-xs font-medium">{isCheckingCoparent ? 'Checking...' : 'Chat'}</span>
              </button>
              <button
                onClick={() => {
                  setCurrentView('dashboard');
                  setShowDashboard(true);
                  loadOnboardingStatus();
                }}
                className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
                  currentView === 'dashboard' ? 'bg-primary text-white' : 'text-gray-600'
                }`}
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span className="text-xs font-medium">Dashboard</span>
              </button>
            </div>
          </nav>
        )}

        <div className="min-h-screen bg-white flex items-center justify-center p-3 sm:p-4 overflow-x-hidden" style={{ paddingTop: isAuthenticated ? '80px' : '0', paddingBottom: isAuthenticated ? '80px' : '0' }}>
          {/* Show connecting screen if authenticated but not joined AND not showing context prompt or settings */}
          {!isJoined && !showContextPrompt && !showSettings && currentView === 'chat' ? (
            <div className="bg-white rounded-3xl shadow-soft-lg p-8 w-full max-w-md">
              <div className="flex items-center justify-center mb-6">
                <div className="relative">
                  <MessageCircle className="w-12 h-12 text-gray-400 animate-pulse" />
                  <div className="absolute inset-0 flex items-center justify-center">
                    <div className="w-6 h-6 border-2 border-gray-300 border-t-gray-900 rounded-full animate-spin" />
                  </div>
                </div>
              </div>
              <h1 className="text-3xl font-bold text-center text-gray-900 mb-2">
                Connecting...
              </h1>
                <p className="text-center text-gray-600 mb-6">
                Joining chat as <span className="font-semibold text-gray-900">{username}</span>
              </p>
            </div>
          ) : isJoined ? (
            <>
              {/* Conditional View Rendering */}
              {currentView === 'chat' && isJoined && (() => {
                // Get the other person's name from room members (not the current user)
                const otherPerson = roomMembers?.find(m => m.username && m.username.toLowerCase() !== username?.toLowerCase());
                const chatPartnerName = otherPerson?.username || coparentName || 'Co-Parent';
                return (
                <div className="card-neumorphic w-full max-w-5xl h-[calc(100vh-200px)] sm:h-[calc(100vh-180px)] md:h-[calc(100vh-120px)] flex flex-col" key="chat-view">
            <div className="flex-1 flex flex-col min-h-0">
              <div className="bg-teal border-b border-teal-dark px-4 sm:px-6 py-3 sm:py-4 rounded-t-2xl flex flex-col gap-3 flex-shrink-0">
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                  <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                    <div className="min-w-0">
                      <h2 className="text-base sm:text-lg md:text-xl font-bold text-white truncate">{chatPartnerName}</h2>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 w-full sm:w-auto">
                  {/* Only show invite options if NOT in shared room */}
                  {!isInSharedRoom && (
                    <>
                      <button
                        onClick={() => {
                          setShowJoinRoomModal(true);
                          setJoinRoomStatus(null);
                        }}
                        className="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 bg-white/20 border border-white/30 text-white hover:bg-white/30 rounded-xl transition-colors flex-1 sm:flex-initial"
                        title="Join Existing Room"
                      >
                        <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                        </svg>
                        <span className="text-xs sm:text-sm font-medium">Join Room</span>
                      </button>
                      <button
                        onClick={handleCreateInvite}
                        disabled={isCreatingInvite}
                        className="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 bg-white/20 border border-white/30 text-white hover:bg-white/30 rounded-xl transition-colors disabled:opacity-50 flex-1 sm:flex-initial"
                        title="Generate Invite Code"
                      >
                        <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        <span className="text-xs sm:text-sm font-medium">Generate Code</span>
                      </button>
                    </>
                  )}
                  </div>
                </div>
                
                {/* Message Search Bar */}
                <div className="relative w-full">
                  <div className="absolute left-3 top-1/2 transform -translate-y-1/2">
                    <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                  </div>
                  <input
                    type="text"
                    value={messageSearch}
                    onChange={(e) => setMessageSearch(e.target.value)}
                    placeholder="Search messages..."
                    className="w-full pl-10 pr-4 py-2 bg-white/90 border border-white/30 rounded-lg text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-white/50"
                  />
                  {messageSearch && (
                    <button
                      onClick={() => setMessageSearch('')}
                      className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  )}
                </div>
              </div>

              {error && (
                <div className="bg-red-50 border-b border-red-200 text-red-700 px-4 py-2 flex items-center gap-2 flex-shrink-0">
                  <AlertCircle className="w-4 h-4 flex-shrink-0" />
                  <span className="text-sm">{error}</span>
                </div>
              )}

                  <div className="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6 space-y-4 min-h-0">
                {messages
                  .filter(msg => {
                    if (!messageSearch.trim()) return true;
                    const searchLower = messageSearch.toLowerCase();
                    return (
                      msg.text?.toLowerCase().includes(searchLower) ||
                      msg.username?.toLowerCase().includes(searchLower) ||
                      msg.validation?.toLowerCase().includes(searchLower) ||
                      msg.tip1?.toLowerCase().includes(searchLower) ||
                      msg.tip2?.toLowerCase().includes(searchLower) ||
                      msg.rewrite?.toLowerCase().includes(searchLower)
                    );
                  })
                  .map((msg) => (
                  <div key={msg.id}>
                    {msg.type === 'system' ? (
                      // Don't display system messages for join/leave - users always stay in chat
                      null
                    ) : msg.type === 'contact_relationship_prompt' ? (
                      <div className="flex items-start gap-3 mb-4">
                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-white font-bold text-sm flex-shrink-0 border-2 border-white shadow-lg">
                          ðŸ’¡
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-baseline gap-2 mb-2">
                            <span className="font-semibold text-blue-dark">{msg.username}</span>
                            <span className="text-xs text-gray-500">{formatTimestamp(msg.timestamp)}</span>
                          </div>
                          <div className="bg-teal-light border-2 border-teal rounded-2xl px-5 py-4 shadow-neumorphic">
                            <p className="text-sm text-teal-dark mb-3">{msg.text}</p>
                            <div className="flex gap-2">
                              <input
                                type="text"
                                id={`relationship-input-${msg.id}`}
                                placeholder="e.g., therapist, teacher, friend"
                                className="flex-1 px-3 py-2 border-2 border-blue rounded-lg focus:outline-none focus:border-blue-dark text-sm"
                                onKeyPress={(e) => {
                                  if (e.key === 'Enter') {
                                    const relationship = e.target.value.trim();
                                    if (relationship) {
                                      socket.emit('contact_relationship', {
                                        detectedName: msg.detectedName,
                                        relationship
                                      });
                                      e.target.value = '';
                                    }
                                  }
                                }}
                              />
                              <button
                                onClick={() => {
                                  const input = document.getElementById(`relationship-input-${msg.id}`);
                                  const relationship = input.value.trim();
                                  if (relationship) {
                                    socket.emit('contact_relationship', {
                                      detectedName: msg.detectedName,
                                      relationship
                                    });
                                    input.value = '';
                                  }
                                }}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors"
                              >
                                Add
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : msg.type === 'ai_intervention' || msg.type === 'ai_comment' ? (
                      <div className="flex items-start gap-3 mb-4">
                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-teal to-primary flex items-center justify-center text-white font-bold text-sm flex-shrink-0 border-2 border-white shadow-lg">
                          ðŸ¤–
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-baseline gap-2 mb-2">
                            <span className="font-semibold text-blue-dark">{msg.username}</span>
                            <span className="text-xs text-gray-500">{formatTimestamp(msg.timestamp)}</span>
                          </div>
                          <div className={`rounded-2xl px-5 py-4 max-w-full break-words space-y-4 shadow-neumorphic ${
                            msg.type === 'ai_intervention' 
                              ? 'bg-pink-light border-2 border-pink' 
                              : 'bg-blue-light border-2 border-blue'
                          }`}>
                            {/* Validation */}
                            {msg.validation && (
                              <div>
                                <p className="text-xs font-semibold text-primary mb-1">ðŸ’™ Validation:</p>
                                <p className={`text-sm ${msg.type === 'ai_intervention' ? 'text-red-800' : 'text-purple-800'}`}>
                                  {msg.validation}
                                </p>
                              </div>
                            )}
                            
                            {/* Communication Tips */}
                            {(msg.tip1 || msg.tip2) && (
                              <div>
                                <p className="text-xs font-semibold text-primary mb-2">ðŸ’¡ Communication Tips:</p>
                                <ul className="space-y-2 list-disc list-inside">
                                  {msg.tip1 && (
                                    <li className={`text-sm ${msg.type === 'ai_intervention' ? 'text-red-800' : 'text-purple-800'}`}>
                                      {msg.tip1}
                                    </li>
                                  )}
                                  {msg.tip2 && (
                                    <li className={`text-sm ${msg.type === 'ai_intervention' ? 'text-red-800' : 'text-purple-800'}`}>
                                      {msg.tip2}
                                    </li>
                                  )}
                                </ul>
                              </div>
                            )}
                            
                            {/* Rewritten Message */}
                            {msg.rewrite && (
                              <div className="pt-3 border-t border-gray-300">
                                <p className="text-xs font-semibold text-green-600 mb-1">âœ¨ Suggested Rewrite:</p>
                                <p className={`text-sm font-medium ${msg.type === 'ai_intervention' ? 'text-red-800' : 'text-purple-800'}`}>
                                  "{msg.rewrite}"
                                </p>
                              </div>
                            )}
                            
                            {/* Fallback for old format */}
                            {msg.text && !msg.validation && !msg.tip1 && !msg.rewrite && (
                              <p className={msg.type === 'ai_intervention' ? 'text-red-800' : 'text-purple-800'}>
                                {msg.text}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div 
                        className={`flex items-start gap-3 mb-2 group ${msg.username === username ? 'flex-row-reverse' : ''}`}
                        onMouseEnter={(e) => {
                          const menu = e.currentTarget.querySelector('.message-menu');
                          if (menu) menu.style.opacity = '1';
                        }}
                        onMouseLeave={(e) => {
                          const messageMenu = e.currentTarget.querySelector('.message-menu');
                          if (messageMenu) messageMenu.style.opacity = '0';
                        }}
                      >
                        <div className={`flex-1 min-w-0 flex flex-col ${msg.username === username ? 'items-end' : 'items-start'}`}>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-sm font-semibold text-gray-800">{msg.username}</span>
                            <span className="text-xs text-gray-500">{formatTimestamp(msg.timestamp)}</span>
                          </div>
                          <div className={`rounded-2xl px-3 sm:px-4 py-2 sm:py-2.5 inline-block max-w-[85%] sm:max-w-[80%] break-words shadow-md relative ${
                            msg.username === username 
                              ? msg.flagged 
                                ? 'bg-orange-light border-2 border-orange text-orange shadow-orange/20' 
                                : 'bg-white border border-gray-200 text-gray-900 shadow-lg'
                              : msg.user_flagged_by && msg.user_flagged_by.includes(username)
                                ? 'bg-red-50 border-2 border-red-300 text-red-900 shadow-md'
                                : 'bg-white border border-gray-200 text-gray-900 shadow-md'
                          }`}>
                            <p>
                              {msg.text}
                            </p>
                            {msg.flagged && msg.username === username && (
                              <p className="text-xs text-orange mt-1 italic">This message was not sent to other users because it needs improvement.</p>
                            )}
                            {msg.user_flagged_by && msg.user_flagged_by.includes(username) && msg.username !== username && (
                              <p className="text-xs text-red-600 mt-1 italic flex items-center gap-1">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                You flagged this message as triggering
                              </p>
                            )}
                            
                            {/* Reactions */}
                            {msg.reactions && Object.keys(msg.reactions).length > 0 && (
                              <div className="flex flex-wrap gap-1 mt-2 pt-2 border-t border-gray-200">
                                {Object.entries(msg.reactions).map(([emoji, users]) => (
                                  <button
                                    key={emoji}
                                    onClick={() => {
                                      if (socketRef.current) {
                                        socketRef.current.emit('add_reaction', { messageId: msg.id, emoji });
                                      }
                                    }}
                                    className={`px-2 py-1 rounded-full text-xs flex items-center gap-1 transition-colors ${
                                      users.includes(username)
                                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300'
                                    }`}
                                    title={users.join(', ')}
                                  >
                                    <span>{emoji}</span>
                                    <span>{users.length}</span>
                                  </button>
                                ))}
                              </div>
                            )}
                            
                            {/* Message menu (flag and reactions) */}
                            <div 
                              className="message-menu absolute -right-2 -top-2 flex gap-1 opacity-0 transition-opacity"
                              style={{ opacity: 0 }}
                            >
                              {/* Flag button - only show for messages from other users */}
                              {msg.type === 'user' && msg.username !== username && (
                                <button
                                  onClick={() => {
                                    if (msg.user_flagged_by && msg.user_flagged_by.includes(username)) {
                                      // Unflag - no reason needed
                                      if (socketRef.current) {
                                        socketRef.current.emit('flag_message', { messageId: msg.id });
                                      }
                                    } else {
                                      // Flag - show modal to get reason
                                      setFlaggingMessageId(msg.id);
                                      setFlagReason('');
                                      setShowFlagModal(true);
                                    }
                                  }}
                                  className={`p-1.5 rounded-full shadow-md border transition-colors ${
                                    msg.user_flagged_by && msg.user_flagged_by.includes(username)
                                      ? 'bg-red-100 border-red-300 text-red-600 hover:bg-red-200'
                                      : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                                  }`}
                                  title={msg.user_flagged_by && msg.user_flagged_by.includes(username) 
                                    ? 'Unflag as triggering' 
                                    : 'Flag as triggering'}
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                  </svg>
                                </button>
                              )}
                              {/* Add reaction button */}
                              {msg.type === 'user' && !msg.flagged && (
                                <div className="relative">
                                  <button
                                    onClick={(e) => {
                                      const menu = e.currentTarget.nextSibling;
                                      if (menu) {
                                        menu.classList.toggle('hidden');
                                      }
                                    }}
                                    className="p-1.5 bg-white rounded-full shadow-md hover:bg-gray-50 border border-gray-200"
                                    title="Add reaction"
                                  >
                                    <span className="text-sm">ðŸ˜Š</span>
                                  </button>
                                  <div className={`hidden reaction-menu-${msg.id} absolute right-0 top-full mt-1 bg-white rounded-lg shadow-lg border border-gray-200 p-2 z-10`}>
                                    <div className="flex gap-1">
                                      {['ðŸ‘', 'â¤ï¸', 'ðŸ˜Š', 'ðŸ˜¢', 'ðŸ˜®', 'ðŸ™'].map(emoji => (
                                        <button
                                          key={emoji}
                                          onClick={() => {
                                            if (socketRef.current) {
                                              socketRef.current.emit('add_reaction', { messageId: msg.id, emoji });
                                            }
                                            const menu = document.querySelector(`.reaction-menu-${msg.id}`);
                                            if (menu) menu.classList.add('hidden');
                                          }}
                                          className="p-2 hover:bg-gray-100 rounded transition-colors text-lg"
                                        >
                                          {emoji}
                                        </button>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                          {msg.username === username && msg.flagged && (
                            <span className="text-xs text-orange font-medium mt-1">âš ï¸ Not sent</span>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
                
                {typingUsers.size > 0 && (
                  <div className="text-sm text-gray-500 italic">
                    {Array.from(typingUsers).join(', ')} {typingUsers.size === 1 ? 'is' : 'are'} typing...
                  </div>
                )}
                
                <div ref={messagesEndRef} />
              </div>

              <div className="border-t border-gray-200 p-3 sm:p-4 flex-shrink-0">
                <form onSubmit={handleSendMessage} className="flex gap-3">
                  <input
                    type="text"
                    placeholder="Type your message..."
                    value={inputMessage}
                    onChange={handleInputChange}
                    className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-teal transition-colors"
                    maxLength={500}
                    disabled={!isConnected}
                    autoFocus
                  />
                  <button
                    type="submit"
                    disabled={!inputMessage.trim() || !isConnected}
                    className="bg-teal text-white px-6 py-3 rounded-xl font-semibold hover:bg-teal transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 shadow-neumorphic"
                  >
                    <Send className="w-5 h-5" />
                    Send
                  </button>
                </form>
              </div>
            </div>
                    </div>
                );
              })()}

              {/* Dashboard View */}
              {currentView === 'dashboard' && isAuthenticated && (
                <div className="card-neumorphic w-full max-w-4xl overflow-hidden flex flex-col">
                  {/* Header */}
                  <div className="bg-teal border-b border-teal-dark text-white px-4 sm:px-6 py-4 sm:py-6 rounded-t-2xl">
                    <div className="flex items-center justify-between mb-4 gap-2">
                      <h2 className="text-2xl sm:text-3xl font-bold text-white truncate">
                        My <span className="text-white opacity-80">Tasks</span>
                      </h2>
                      <button
                        onClick={() => {
                          setEditingTask(null);
                          setTaskFormData({
                            title: '',
                            description: '',
                            status: 'open',
                            priority: 'medium',
                            due_date: ''
                          });
                          setShowTaskForm(true);
                        }}
                        className="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"
                        title="Add Task"
                      >
                        <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>

                    {/* Search Bar */}
                    <div className="relative mb-4">
                      <div className="absolute left-4 top-1/2 transform -translate-y-1/2">
                        <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                      </div>
                      <input
                        type="text"
                        value={taskSearch}
                        onChange={(e) => setTaskSearch(e.target.value)}
                        placeholder="Search Here..."
                        className="w-full px-4 py-2 pl-12 pr-4 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue transition-colors shadow-neumorphic-inset bg-white text-gray-900 placeholder-gray-400"
                      />
                    </div>

                    {/* Filter Buttons */}
                    <div className="flex gap-2">
                      <button
                        onClick={() => setTaskFilter('all')}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
                          taskFilter === 'all' ? 'bg-white text-teal' : 'bg-white/20 text-white hover:bg-white/30'
                        }`}
                      >
                        All
                      </button>
                      <button
                        onClick={() => setTaskFilter('open')}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
                          taskFilter === 'open' ? 'bg-white text-teal' : 'bg-white/20 text-white hover:bg-white/30'
                        }`}
                      >
                        Open
                      </button>
                      <button
                        onClick={() => setTaskFilter('completed')}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
                          taskFilter === 'completed' ? 'bg-white text-teal' : 'bg-white/20 text-white hover:bg-white/30'
                        }`}
                      >
                        Completed
                      </button>
                    </div>
                  </div>

                  {/* Tasks List */}
                  <div className="px-6 py-4">

                    {/* Tasks List */}
                    {isLoadingTasks ? (
                      <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-2 border-gray-200 border-t-teal"></div>
                      </div>
                    ) : tasks.length === 0 ? (
                      <div className="text-center py-12">
                        <p className="text-gray-500 text-lg">No tasks found. Create your first task to get started!</p>
                      </div>
                    ) : (
                      <div className="space-y-1">
                        {tasks.map((task) => {
                          const titleLower = (task.title || '').toLowerCase().trim();
                          const isCoparentTask = titleLower.includes('add your co-parent') || titleLower.includes('add coparent');
                          const isProfileTask = titleLower.includes('complete your profile') || titleLower.includes('complete profile');
                          const isChildrenTask = titleLower.includes('add your children') || titleLower.includes('add children');
                          const isSmartTask = task.status !== 'completed' && (isCoparentTask || isProfileTask || isChildrenTask);
                          
                          return (
                          <div
                            key={task.id}
                            onClick={() => {
                              // Open task form for editing or smart actions
                              setEditingTask(task);
                              setTaskFormData({
                                title: task.title,
                                description: task.description || '',
                                status: task.status,
                                priority: task.priority || 'medium',
                                due_date: task.due_date || ''
                              });
                              setShowTaskForm(true);
                            }}
                            className={`flex items-center gap-2 sm:gap-4 p-3 sm:p-4 rounded-xl cursor-pointer transition-all ${
                              task.status === 'completed'
                                ? 'bg-gray-50 opacity-60'
                                : 'bg-white hover:bg-gray-50 active:bg-gray-100'
                            }`}
                          >
                            {/* Task Icon/Status Circle */}
                            <div className="flex-shrink-0">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  async function toggleStatus() {
                                    try {
                                      const newStatus = task.status === 'completed' ? 'open' : 'completed';
                                      const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/tasks/${task.id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'include', // IMPORTANT: Include cookies for authentication
                                        body: JSON.stringify({
                                          username,
                                          status: newStatus
                                        })
                                      });
                                      if (response.ok) {
                                        loadTasks();
                                      }
                                    } catch (err) {
                                      console.error('Error updating task status:', err);
                                    }
                                  }
                                  toggleStatus();
                                }}
                                className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${
                                  task.status === 'completed'
                                    ? 'bg-green-500'
                                    : 'bg-teal'
                                }`}
                              >
                                {task.status === 'completed' ? (
                                  <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                  </svg>
                                ) : (
                                  <span className="text-white font-bold text-lg">
                                    {task.title.charAt(0).toUpperCase()}
                                  </span>
                                )}
                              </button>
                            </div>

                            {/* Task Content */}
                            <div className="flex-1 min-w-0 overflow-hidden">
                              <div className="flex items-center gap-2 min-w-0">
                                <h3 className={`text-sm sm:text-base font-semibold text-gray-800 mb-1 truncate ${
                                task.status === 'completed' ? 'line-through text-gray-400' : ''
                              }`}>
                                  {isSmartTask ? (
                                    isCoparentTask ? 'Add Co-parent' :
                                    isProfileTask ? 'Complete Profile' :
                                    isChildrenTask ? 'Add Children' :
                                    task.title
                                  ) : task.title}
                              </h3>
                                {isSmartTask && (
                                  <svg className="w-4 h-4 text-teal flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                  </svg>
                                )}
                              </div>
                              {task.description && (
                                <p className={`text-xs sm:text-sm text-gray-500 line-clamp-2 break-words ${
                                  task.status === 'completed' ? 'line-through text-gray-400' : ''
                                }`}>
                                  {task.description}
                                </p>
                              )}
                            </div>

                            {/* Task Meta Info - Right Side */}
                            <div className="flex items-center gap-3 flex-shrink-0">
                              <div className="flex flex-col items-end gap-1">
                                {task.priority && task.priority !== 'medium' && (
                                  <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                    task.priority === 'high' ? 'bg-red-100 text-red-700' :
                                    'bg-blue-100 text-blue-700'
                                  }`}>
                                    {task.priority}
                                  </span>
                                )}
                                {task.due_date && (
                                  <span className={`text-xs ${
                                    task.status === 'completed' ? 'text-gray-400' : 'text-gray-500'
                                  }`}>
                                    {new Date(task.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                  </span>
                                )}
                              </div>
                              
                              {/* Action Menu */}
                              <div className="relative" onClick={(e) => e.stopPropagation()}>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    const menu = document.getElementById(`task-menu-${task.id}`);
                                    if (menu) {
                                      menu.classList.toggle('hidden');
                                    }
                                  }}
                                  className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors"
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                  </svg>
                                </button>
                                
                                {/* Dropdown Menu */}
                                <div
                                  id={`task-menu-${task.id}`}
                                  className="hidden absolute right-0 top-full mt-1 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10 min-w-[160px] max-w-[calc(100vw-2rem)]"
                                >
                                  <button
                                    onClick={async () => {
                                      try {
                                        const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/tasks/${task.id}/duplicate`, {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ username })
                                        });
                                        if (response.ok) {
                                          loadTasks();
                                        }
                                        document.getElementById(`task-menu-${task.id}`).classList.add('hidden');
                                      } catch (err) {
                                        console.error('Error duplicating task:', err);
                                      }
                                    }}
                                    className="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"
                                  >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Duplicate
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (confirm('Are you sure you want to delete this task?')) {
                                        try {
                                          const response = await fetch(`${window.API_URL || 'http://localhost:3001'}/api/tasks/${task.id}?username=${encodeURIComponent(username)}`, {
                                            method: 'DELETE',
                                            credentials: 'include' // IMPORTANT: Include cookies for authentication
                                          });
                                          if (response.ok) {
                                            loadTasks();
                                          }
                                          document.getElementById(`task-menu-${task.id}`).classList.add('hidden');
                                        } catch (err) {
                                          console.error('Error deleting task:', err);
                                        }
                                      }
                                    }}
                                    className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                  >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Delete
                                  </button>
                                </div>
                              </div>

                              {/* Right Arrow */}
                              <svg className="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                              </svg>
                            </div>
                          </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                  
                  {/* Task Form Modal */}
                  {showTaskForm && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col my-4">
                        <div className="bg-teal border-b border-teal-dark text-white px-6 py-4 rounded-t-2xl flex items-center justify-between flex-shrink-0">
                          <h3 className="text-2xl font-bold">{editingTask ? 'Edit Task' : 'Add Task'}</h3>
                          <button
                            onClick={() => {
                              setShowTaskForm(false);
                              setEditingTask(null);
                              setTaskFormData({
                                title: '',
                                description: '',
                                status: 'open',
                                priority: 'medium',
                                due_date: ''
                              });
                            }}
                            className="text-white hover:text-gray-200 text-2xl font-bold"
                          >
                            Ã—
                          </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-4">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Title *</label>
                            <input
                              type="text"
                              value={taskFormData.title}
                              onChange={(e) => setTaskFormData({ ...taskFormData, title: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              placeholder="Task title"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                            <textarea
                              value={taskFormData.description}
                              onChange={(e) => setTaskFormData({ ...taskFormData, description: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              rows={4}
                              placeholder="Task description"
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                              <select
                                value={taskFormData.status}
                                onChange={(e) => setTaskFormData({ ...taskFormData, status: e.target.value })}
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              >
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">Priority</label>
                              <select
                                value={taskFormData.priority}
                                onChange={(e) => setTaskFormData({ ...taskFormData, priority: e.target.value })}
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              >
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                              </select>
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Due Date</label>
                            <input
                              type="date"
                              value={taskFormData.due_date}
                              onChange={(e) => setTaskFormData({ ...taskFormData, due_date: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                            />
                          </div>
                        </div>
                        <div className="border-t border-gray-200 bg-gray-50 px-6 py-4 rounded-b-2xl flex gap-3 flex-shrink-0">
                          <button
                            onClick={async () => {
                              const titleLower = (editingTask?.title || taskFormData.title || '').toLowerCase().trim();
                              const isWelcomeTask = titleLower.includes('welcome to liaizen');
                              const isProfileTask = titleLower.includes('complete your profile') || titleLower.includes('complete profile');
                              const isCoparentTask = titleLower.includes('add your co-parent') || titleLower.includes('add coparent');

                              // Special onboarding tasks with smart actions
                              if (editingTask && (isWelcomeTask || isProfileTask || isCoparentTask)) {
                                // Close the task modal first
                                setShowTaskForm(false);
                                setEditingTask(null);
                                setTaskFormData({
                                  title: '',
                                  description: '',
                                  status: 'open',
                                  priority: 'medium',
                                  due_date: ''
                                });

                                // Welcome to LiaiZen â†’ just acknowledge
                                if (isWelcomeTask) {
                                  return;
                                }

                                // Complete Your Profile â†’ go to Profile
                                if (isProfileTask) {
                                  setCurrentView('profile');
                                  return;
                                }

                                // Add Your Co-parent â†’ go to Contacts and open Add Contact with relationship preset
                                if (isCoparentTask) {
                                  setCurrentView('contacts');
                                  setShowContactForm(true);
                                  setEditingContact(null);
                                  setContactFormData(prev => ({
                                    ...prev,
                                    relationship: 'My Co-Parent'
                                  }));
                                  return;
                                }
                              }

                              // Default behavior: create or update task
                              try {
                                const url = editingTask
                                  ? `${window.API_URL || 'http://localhost:3001'}/api/tasks/${editingTask.id}`
                                  : `${window.API_URL || 'http://localhost:3001'}/api/tasks`;
                                const method = editingTask ? 'PUT' : 'POST';
                                
                                const response = await fetch(url, {
                                  method,
                                  headers: { 'Content-Type': 'application/json' },
                                  body: JSON.stringify({
                                    username,
                                    ...taskFormData
                                  })
                                });
                                
                                const data = await response.json();
                                if (response.ok) {
                                  setShowTaskForm(false);
                                  setEditingTask(null);
                                  setTaskFormData({
                                    title: '',
                                    description: '',
                                    status: 'open',
                                    priority: 'medium',
                                    due_date: ''
                                  });
                                  loadTasks();
                                } else {
                                  alert(data.error || 'Failed to save task');
                                }
                              } catch (err) {
                                console.error('Error saving task:', err);
                                alert('Failed to save task. Please try again.');
                              }
                            }}
                            disabled={!taskFormData.title.trim()}
                            className="flex-1 bg-teal text-white py-3 rounded-xl font-semibold hover:bg-teal transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed shadow-neumorphic"
                          >
                            {editingTask
                              ? (() => {
                                  const titleLower = (editingTask?.title || taskFormData.title || '').toLowerCase().trim();
                                  if (titleLower.includes('welcome to liaizen')) return 'OK';
                                  if (titleLower.includes('complete your profile') || titleLower.includes('complete profile')) return 'Update Profile';
                                  if (titleLower.includes('add your co-parent') || titleLower.includes('add coparent')) return 'Add Co-parent';
                                  return 'Update';
                                })()
                              : 'Create'}
                          </button>
                          <button
                            onClick={() => {
                              setShowTaskForm(false);
                              setEditingTask(null);
                              setTaskFormData({
                                title: '',
                                description: '',
                                status: 'open',
                                priority: 'medium',
                                due_date: ''
                              });
                            }}
                            className="px-6 py-3 border-2 border-gray-300 rounded-lg font-semibold hover:bg-gray-50 transition-colors"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Profile View */}
              {currentView === 'profile' && isAuthenticated && (
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 overflow-y-auto" style={{ maxHeight: 'calc(100vh - 200px)' }}>
                  <div className="mb-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">Profile</h2>
                    <p className="text-gray-600">Manage your personal information and profile details</p>
                  </div>

                  {error && (
                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6 flex items-center gap-2">
                      <AlertCircle className="w-5 h-5 flex-shrink-0" />
                      <span>{error}</span>
                    </div>
                  )}

                  {isLoadingProfile ? (
                    <div className="text-center py-8">
                      <div className="inline-block animate-spin rounded-full h-8 w-8 border-2 border-gray-200 border-t-teal"></div>
                      <p className="mt-2 text-gray-600">Loading profile...</p>
                    </div>
                  ) : (
                    <div className="space-y-8">
                      {/* Account Info Section */}
                      <div className="space-y-4">
                        <h3 className="text-xl font-semibold text-teal-dark mb-4">Account Information</h3>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Username</label>
                            <input
                              type="text"
                              value={profileData.username || ''}
                              onChange={(e) => {
                                const newUsername = e.target.value.trim();
                                if (newUsername.length <= 20) {
                                  setProfileData({ ...profileData, username: newUsername });
                                }
                              }}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              placeholder="Username"
                              maxLength={20}
                            />
                            <p className="text-xs text-gray-500 mt-1">2-20 characters</p>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                            <input
                              type="email"
                              value={profileData.email}
                              onChange={(e) => setProfileData({ ...profileData, email: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              placeholder="your@email.com"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Personal Information Section */}
                      <div className="space-y-4">
                        <h3 className="text-xl font-semibold text-teal-dark mb-4">Personal Information</h3>
                        <div className="space-y-4">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">First Name</label>
                              <input
                                type="text"
                                value={profileData.first_name}
                                onChange={(e) => setProfileData({ ...profileData, first_name: e.target.value })}
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                placeholder="First name"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">Last Name</label>
                              <input
                                type="text"
                                value={profileData.last_name}
                                onChange={(e) => setProfileData({ ...profileData, last_name: e.target.value })}
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                placeholder="Last name"
                              />
                            </div>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Address</label>
                            <input
                              type="text"
                              value={profileData.address}
                              onChange={(e) => setProfileData({ ...profileData, address: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              placeholder="Your address"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">
                              Household Members <span className="text-xs text-gray-500">(Private to User)</span>
                            </label>
                            <textarea
                              value={profileData.household_members}
                              onChange={(e) => setProfileData({ ...profileData, household_members: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              rows={3}
                              placeholder="List household members..."
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Occupation / Daily Responsibilities</label>
                            <textarea
                              value={profileData.occupation}
                              onChange={(e) => setProfileData({ ...profileData, occupation: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              rows={3}
                              placeholder="Describe your occupation and daily responsibilities..."
                            />
                            <p className="text-xs text-gray-500 mt-1">This helps understand your schedule demands</p>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">What is your parenting philosophy?</label>
                            <textarea
                              value={profileData.parenting_philosophy}
                              onChange={(e) => setProfileData({ ...profileData, parenting_philosophy: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              rows={4}
                              placeholder="Share your parenting philosophy and approach..."
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">What personal growth or changes would you like to work on during this process?</label>
                            <textarea
                              value={profileData.personal_growth}
                              onChange={(e) => setProfileData({ ...profileData, personal_growth: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              rows={4}
                              placeholder="Describe areas you'd like to improve or work on..."
                            />
                          </div>
                        </div>
                      </div>

                      {/* Password Change Section */}
                      <div className="space-y-4">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="text-xl font-semibold text-teal-dark">Password</h3>
                          <button
                            onClick={() => setShowPasswordChange(!showPasswordChange)}
                            className="px-4 py-2 bg-teal text-white rounded-xl font-semibold hover:bg-teal transition-colors text-sm shadow-neumorphic"
                          >
                            {showPasswordChange ? 'Cancel' : 'Change Password'}
                          </button>
                        </div>
                        {showPasswordChange && (
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">Current Password</label>
                              <input
                                type="password"
                                value={passwordData.currentPassword}
                                onChange={(e) => setPasswordData({ ...passwordData, currentPassword: e.target.value })}
                                autoComplete="current-password"
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">New Password</label>
                              <input
                                type="password"
                                value={passwordData.newPassword}
                                onChange={(e) => setPasswordData({ ...passwordData, newPassword: e.target.value })}
                                autoComplete="new-password"
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-semibold text-gray-700 mb-1">Confirm New Password</label>
                              <input
                                type="password"
                                value={passwordData.confirmPassword}
                                onChange={(e) => setPasswordData({ ...passwordData, confirmPassword: e.target.value })}
                                autoComplete="new-password"
                                className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              />
                            </div>
                            <button
                              onClick={handleChangePassword}
                              disabled={isChangingPassword}
                              className="w-full bg-teal text-white py-3 rounded-xl font-semibold hover:bg-teal transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed shadow-neumorphic"
                            >
                              {isChangingPassword ? 'Changing...' : 'Update Password'}
                            </button>
                          </div>
                        )}
                      </div>

                      {/* Save Button */}
                      <div className="flex gap-3 pt-4">
                        <button
                          onClick={handleSaveProfile}
                          disabled={isSavingProfile}
                          className="flex-1 bg-teal text-white py-3 rounded-xl font-semibold hover:bg-teal transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-neumorphic"
                        >
                          {isSavingProfile ? (
                            <>
                              <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                              Saving...
                            </>
                          ) : (
                            'Save Profile'
                          )}
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Contacts View */}
              {currentView === 'contacts' && isAuthenticated && (
                <div className="bg-white rounded-2xl w-full max-w-4xl overflow-hidden flex flex-col shadow-sm" style={{ maxHeight: 'calc(100vh - 200px)' }}>
                  {/* Clean Header */}
                  <div className="flex items-center justify-between px-6 py-4 border-b border-gray-100 flex-shrink-0">
                    <h2 className="text-2xl font-bold text-gray-900">Contacts</h2>
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => {
                          setEditingContact(null);
                          setContactFormData({ 
                            contact_name: '', 
                            contact_email: '', 
                            relationship: '', 
                            notes: '',
                            separation_date: '',
                            address: '',
                            difficult_aspects: '',
                            friction_situations: '',
                            legal_matters: '',
                            safety_concerns: '',
                            substance_mental_health: '',
                            neglect_abuse_concerns: '',
                            additional_thoughts: ''
                          });
                          setShowContactForm(true);
                        }}
                        className="p-2 text-gray-600 hover:bg-gray-50 rounded-lg transition-colors"
                        title="Add Contact"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* Search Bar - Clean and Rounded */}
                  <div className="px-6 py-4 flex-shrink-0">
                    <div className="relative">
                      <div className="absolute left-4 top-1/2 transform -translate-y-1/2">
                        <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                      </div>
                      <input
                        type="text"
                        value={contactSearch}
                        onChange={(e) => setContactSearch(e.target.value)}
                        placeholder="Search contacts"
                        className="w-full pl-12 pr-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue transition-colors shadow-neumorphic-inset bg-white text-gray-900 placeholder-gray-400"
                      />
                    </div>
                  </div>

                  {error && (
                    <div className="mx-6 mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl flex items-center gap-2">
                      <AlertCircle className="w-5 h-5 flex-shrink-0" />
                      <span className="text-sm">{error}</span>
                    </div>
                  )}

                  {/* Contact Form Modal */}
                  {showContactForm && (
                    <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 p-4">
                      <div className="bg-white rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-200">
                        <div className="border-b border-gray-100 px-6 py-5 flex items-center justify-between flex-shrink-0">
                          <h3 className="text-xl font-bold text-gray-900">{editingContact ? 'Edit Contact' : 'Add Contact'}</h3>
                          <button
                            onClick={() => {
                              setShowContactForm(false);
                              setEditingContact(null);
                              setContactFormData({ 
                                contact_name: '', 
                                contact_email: '', 
                                relationship: '', 
                                notes: '',
                                separation_date: '',
                                address: '',
                                difficult_aspects: '',
                                friction_situations: '',
                                legal_matters: '',
                                safety_concerns: '',
                                substance_mental_health: '',
                                neglect_abuse_concerns: '',
                                additional_thoughts: ''
                              });
                            }}
                            className="text-white hover:text-gray-200 text-2xl font-bold"
                          >
                            Ã—
                          </button>
                        </div>
                        <form 
                          id="contact-form"
                          onSubmit={(e) => {
                            e.preventDefault();
                            handleSaveContact();
                          }}
                          className="flex-1 overflow-y-auto p-6 space-y-4"
                        >
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Contact Name *</label>
                            <input
                              type="text"
                              value={contactFormData.contact_name}
                              onChange={(e) => setContactFormData({ ...contactFormData, contact_name: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              placeholder="Contact's name"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Relationship *</label>
                            <select
                              value={contactFormData.relationship}
                              onChange={(e) => setContactFormData({ ...contactFormData, relationship: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue transition-colors shadow-neumorphic-inset bg-white"
                              required
                            >
                              <option value="">Select relationship...</option>
                              <option value="My Co-Parent">My Co-Parent</option>
                              <option value="My Partner">My Partner</option>
                              <option value="My Partner's Child">My Partner's Child</option>
                              <option value="My Partner's Family">My Partner's Family</option>
                              <option value="My Partner's Co-Parent">My Partner's Co-Parent</option>
                              <option value="My Partner's Friend">My Partner's Friend</option>
                              <option value="My Child">My Child</option>
                              <option value="My Family">My Family</option>
                              <option value="My Friend">My Friend</option>
                              <option value="My Child's Friend">My Child's Friend</option>
                              <option value="My Child's Teacher">My Child's Teacher</option>
                              <option value="My Co-Parent's Partner">My Co-Parent's Partner</option>
                              <option value="My Co-Parent's Family">My Co-Parent's Family</option>
                              <option value="My Co-Parent's Friend">My Co-Parent's Friend</option>
                              <option value="Other">Other</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                            <input
                              type="email"
                              value={contactFormData.contact_email}
                              onChange={(e) => setContactFormData({ ...contactFormData, contact_email: e.target.value })}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              placeholder="contact@email.com"
                            />
                          </div>
                          {/* Relationship-specific fields */}
                          {(contactFormData.relationship === 'My Co-Parent' || editingContact?.relationship === 'My Co-Parent' || contactFormData.relationship === 'co-parent' || editingContact?.relationship === 'co-parent') && (
                            <>
                              <div className="border-t border-gray-200 pt-4 mt-4">
                                <h4 className="text-lg font-semibold text-gray-800 mb-4">Co-Parent Information</h4>
                                <p className="text-sm text-gray-600 mb-4">Provide details about your co-parenting relationship</p>
                                
                                <div className="mb-4">
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">
                                    Started Living in Separate Households: MM/YYYY
                                  </label>
                                  <input
                                    type="text"
                                    value={contactFormData.separation_date}
                                    onChange={(e) => {
                                      let value = e.target.value;
                                      // Remove any non-digit characters except "/"
                                      value = value.replace(/[^\d/]/g, '');
                                      
                                      // If user types digits, auto-format
                                      if (value.length > 0 && !value.includes('/')) {
                                        // After 2 digits, add "/"
                                        if (value.length === 2) {
                                          value = value + '/';
                                        } else if (value.length > 2) {
                                          // Insert "/" after 2 digits
                                          value = value.slice(0, 2) + '/' + value.slice(2);
                                        }
                                      }
                                      
                                      // Limit to MM/YYYY format (max 7 characters: MM/YYYY)
                                      if (value.length > 7) {
                                        value = value.slice(0, 7);
                                      }
                                      
                                      // Ensure month is valid (01-12)
                                      if (value.length >= 2) {
                                        const month = parseInt(value.slice(0, 2));
                                        if (month > 12) {
                                          value = '12' + value.slice(2);
                                        } else if (month === 0) {
                                          value = '01' + value.slice(2);
                                        }
                                      }
                                      
                                      setContactFormData({ ...contactFormData, separation_date: value });
                                    }}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                    placeholder="MM/YYYY"
                                    maxLength={7}
                                  />
                                </div>
                                
                                <div className="mb-4">
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">Address</label>
                                  <textarea
                                    value={contactFormData.address}
                                    onChange={(e) => setContactFormData({ ...contactFormData, address: e.target.value })}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                    rows={2}
                                    placeholder="Co-parent's address"
                                  />
                                </div>
                                
                                <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mt-4">
                                  <p className="text-sm font-semibold text-red-800 mb-3 flex items-center gap-2">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    Private (Not Shown to Co-Parent - This is for AI Contextual Understanding)
                                  </p>
                                  
                                  <div className="space-y-4">
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        What aspects of co-parenting do you find most difficult?
                                      </label>
                                      <textarea
                                        value={contactFormData.difficult_aspects}
                                        onChange={(e) => setContactFormData({ ...contactFormData, difficult_aspects: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={3}
                                        placeholder="Describe the challenges you face..."
                                      />
                                    </div>
                                    
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        What types of comments or situations usually create friction?
                                      </label>
                                      <textarea
                                        value={contactFormData.friction_situations}
                                        onChange={(e) => setContactFormData({ ...contactFormData, friction_situations: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={3}
                                        placeholder="Describe situations that typically lead to conflict..."
                                      />
                                    </div>
                                    
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        Are there any active legal matters (e.g., ongoing court case, restraining order)?
                                      </label>
                                      <textarea
                                        value={contactFormData.legal_matters}
                                        onChange={(e) => setContactFormData({ ...contactFormData, legal_matters: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={2}
                                        placeholder="Describe any active legal matters..."
                                      />
                                    </div>
                                    
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        Are there safety concerns (for you, the child, or the other parent)?
                                      </label>
                                      <textarea
                                        value={contactFormData.safety_concerns}
                                        onChange={(e) => setContactFormData({ ...contactFormData, safety_concerns: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={3}
                                        placeholder="Describe any safety concerns..."
                                      />
                                    </div>
                                    
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        Are there substance use or mental health issues impacting parenting?
                                      </label>
                                      <textarea
                                        value={contactFormData.substance_mental_health}
                                        onChange={(e) => setContactFormData({ ...contactFormData, substance_mental_health: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={3}
                                        placeholder="Describe any substance use or mental health concerns..."
                                      />
                                    </div>
                                    
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        Are there concerns about neglect, abuse, or inappropriate behavior?
                                      </label>
                                      <textarea
                                        value={contactFormData.neglect_abuse_concerns}
                                        onChange={(e) => setContactFormData({ ...contactFormData, neglect_abuse_concerns: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={3}
                                        placeholder="Describe any concerns about neglect, abuse, or inappropriate behavior..."
                                      />
                                    </div>
                                    
                                    <div>
                                      <label className="block text-sm font-semibold text-gray-700 mb-1">
                                        Additional Thoughts/Concerns:
                                      </label>
                                      <textarea
                                        value={contactFormData.additional_thoughts}
                                        onChange={(e) => setContactFormData({ ...contactFormData, additional_thoughts: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                        rows={4}
                                        placeholder="Any other thoughts or concerns you'd like to share..."
                                      />
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </>
                          )}
                          
                          {/* My Child specific fields */}
                          {contactFormData.relationship === 'My Child' && (
                            <div className="border-t border-gray-200 pt-4 mt-4">
                              <h4 className="text-lg font-semibold text-gray-800 mb-4">Child Information</h4>
                              <div className="space-y-4">
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">Date of Birth</label>
                                  <input
                                    type="date"
                                    value={contactFormData.notes?.includes('Date of Birth:') ? contactFormData.notes.split('Date of Birth:')[1]?.trim() || '' : ''}
                                    onChange={(e) => {
                                      const existingNotes = contactFormData.notes?.includes('Date of Birth:') 
                                        ? contactFormData.notes.split('\n').filter(line => !line.includes('Date of Birth:')).join('\n').trim()
                                        : contactFormData.notes;
                                      const dobLine = e.target.value ? `Date of Birth: ${e.target.value}` : '';
                                      const newNotes = [dobLine, existingNotes].filter(Boolean).join('\n');
                                      setContactFormData({ ...contactFormData, notes: newNotes });
                                    }}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">School/Grade</label>
                                  <input
                                    type="text"
                                    value={contactFormData.notes?.includes('School/Grade:') ? contactFormData.notes.split('School/Grade:')[1]?.split('\n')[0]?.trim() || '' : ''}
                                    onChange={(e) => {
                                      const existingNotes = contactFormData.notes?.split('\n').filter(line => !line.includes('School/Grade:') && !line.includes('Date of Birth:')).join('\n').trim();
                                      const dobLine = contactFormData.notes?.includes('Date of Birth:') ? contactFormData.notes.split('\n').find(line => line.includes('Date of Birth:')) : '';
                                      const schoolLine = e.target.value ? `School/Grade: ${e.target.value}` : '';
                                      const newNotes = [dobLine, schoolLine, existingNotes].filter(Boolean).join('\n');
                                      setContactFormData({ ...contactFormData, notes: newNotes });
                                    }}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                    placeholder="e.g., Lincoln Elementary, 3rd Grade"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">Other Parent</label>
                                  <select
                                    value={contactFormData.other_parent || ''}
                                    onChange={(e) => setContactFormData({ ...contactFormData, other_parent: e.target.value })}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                  >
                                    <option value="">Select other parent (optional)</option>
                                    {contacts
                                      .filter(c => 
                                        c.relationship === 'co-parent' || 
                                        c.relationship === 'My Co-Parent' || 
                                        c.relationship === 'My Partner'
                                      )
                                      .map(c => (
                                        <option key={c.id} value={c.contact_name}>
                                          {c.contact_name}
                                        </option>
                                      ))}
                                  </select>
                                  <p className="text-xs text-gray-500 mt-1">
                                    Link this child to your co-parent or partner's contact for shared custody tracking
                                  </p>
                                </div>
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">Special Needs or Considerations</label>
                                  <textarea
                                    value={contactFormData.notes?.includes('Special Needs:') ? contactFormData.notes.split('Special Needs:')[1]?.trim() || '' : (contactFormData.notes?.includes('Date of Birth:') || contactFormData.notes?.includes('School/Grade:') ? '' : contactFormData.notes || '')}
                                    onChange={(e) => {
                                      const dobLine = contactFormData.notes?.includes('Date of Birth:') ? contactFormData.notes.split('\n').find(line => line.includes('Date of Birth:')) : '';
                                      const schoolLine = contactFormData.notes?.includes('School/Grade:') ? contactFormData.notes.split('\n').find(line => line.includes('School/Grade:')) : '';
                                      const specialNeedsLine = e.target.value ? `Special Needs: ${e.target.value}` : '';
                                      const newNotes = [dobLine, schoolLine, specialNeedsLine].filter(Boolean).join('\n');
                                      setContactFormData({ ...contactFormData, notes: newNotes });
                                    }}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                    rows={3}
                                    placeholder="Any special needs, allergies, medical conditions, or other important information..."
                                  />
                                </div>
                              </div>
                            </div>
                          )}
                          
                          {/* My Child's Teacher specific fields */}
                          {contactFormData.relationship === "My Child's Teacher" && (
                            <div className="border-t border-gray-200 pt-4 mt-4">
                              <h4 className="text-lg font-semibold text-gray-800 mb-4">Teacher Information</h4>
                              <div className="space-y-4">
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">School Name</label>
                                  <input
                                    type="text"
                                    value={contactFormData.notes?.includes('School Name:') ? contactFormData.notes.split('School Name:')[1]?.split('\n')[0]?.trim() || '' : ''}
                                    onChange={(e) => {
                                      const existingNotes = contactFormData.notes?.split('\n').filter(line => !line.includes('School Name:') && !line.includes('Grade/Subject:')).join('\n').trim();
                                      const schoolLine = e.target.value ? `School Name: ${e.target.value}` : '';
                                      const gradeLine = contactFormData.notes?.includes('Grade/Subject:') ? contactFormData.notes.split('\n').find(line => line.includes('Grade/Subject:')) : '';
                                      const newNotes = [schoolLine, gradeLine, existingNotes].filter(Boolean).join('\n');
                                      setContactFormData({ ...contactFormData, notes: newNotes });
                                    }}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                    placeholder="School name"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-semibold text-gray-700 mb-1">Grade/Subject</label>
                                  <input
                                    type="text"
                                    value={contactFormData.notes?.includes('Grade/Subject:') ? contactFormData.notes.split('Grade/Subject:')[1]?.split('\n')[0]?.trim() || '' : ''}
                                    onChange={(e) => {
                                      const existingNotes = contactFormData.notes?.split('\n').filter(line => !line.includes('School Name:') && !line.includes('Grade/Subject:')).join('\n').trim();
                                      const schoolLine = contactFormData.notes?.includes('School Name:') ? contactFormData.notes.split('\n').find(line => line.includes('School Name:')) : '';
                                      const gradeLine = e.target.value ? `Grade/Subject: ${e.target.value}` : '';
                                      const newNotes = [schoolLine, gradeLine, existingNotes].filter(Boolean).join('\n');
                                      setContactFormData({ ...contactFormData, notes: newNotes });
                                    }}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                                    placeholder="e.g., 3rd Grade, Math"
                                  />
                                </div>
                              </div>
                            </div>
                          )}
                          
                          {/* General Notes for all relationships */}
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Additional Notes (Context for AI)</label>
                            <textarea
                              value={(() => {
                                // For My Child, extract only the unstructured notes
                                if (contactFormData.relationship === 'My Child') {
                                  const lines = contactFormData.notes?.split('\n') || [];
                                  return lines.filter(line => 
                                    !line.includes('Date of Birth:') && 
                                    !line.includes('School/Grade:') && 
                                    !line.includes('Special Needs:')
                                  ).join('\n').trim();
                                }
                                // For My Child's Teacher, extract only unstructured notes
                                if (contactFormData.relationship === "My Child's Teacher") {
                                  const lines = contactFormData.notes?.split('\n') || [];
                                  return lines.filter(line => 
                                    !line.includes('School Name:') && 
                                    !line.includes('Grade/Subject:')
                                  ).join('\n').trim();
                                }
                                // For other relationships, show all notes
                                return contactFormData.notes || '';
                              })()}
                              onChange={(e) => {
                                let newNotes = e.target.value;
                                // For My Child, preserve structured data
                                if (contactFormData.relationship === 'My Child') {
                                  const dobLine = contactFormData.notes?.split('\n').find(line => line.includes('Date of Birth:')) || '';
                                  const schoolLine = contactFormData.notes?.split('\n').find(line => line.includes('School/Grade:')) || '';
                                  const specialNeedsLine = contactFormData.notes?.split('\n').find(line => line.includes('Special Needs:')) || '';
                                  newNotes = [dobLine, schoolLine, specialNeedsLine, newNotes].filter(Boolean).join('\n');
                                }
                                // For My Child's Teacher, preserve structured data
                                if (contactFormData.relationship === "My Child's Teacher") {
                                  const schoolLine = contactFormData.notes?.split('\n').find(line => line.includes('School Name:')) || '';
                                  const gradeLine = contactFormData.notes?.split('\n').find(line => line.includes('Grade/Subject:')) || '';
                                  newNotes = [schoolLine, gradeLine, newNotes].filter(Boolean).join('\n');
                                }
                                setContactFormData({ ...contactFormData, notes: newNotes });
                              }}
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                              rows={4}
                              placeholder="Add contextual information about this contact that will help the AI mediator understand your situation..."
                            />
                          </div>
                        </form>
                        {/* Fixed footer with buttons */}
                        <div className="border-t border-gray-100 bg-white px-6 py-5 rounded-b-2xl flex gap-3 flex-shrink-0">
                          <button
                            type="submit"
                            form="contact-form"
                            disabled={isSavingContact || !contactFormData.contact_name.trim()}
                            className="flex-1 bg-primary text-white py-3 rounded-xl font-semibold hover:bg-primary transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed disabled:text-gray-500"
                          >
                            {isSavingContact ? 'Saving...' : (editingContact ? 'Update' : 'Add')}
                          </button>
                          <button
                            onClick={() => {
                              setShowContactForm(false);
                              setEditingContact(null);
                              setContactFormData({ 
                                contact_name: '', 
                                contact_email: '', 
                                relationship: '', 
                                notes: '',
                                separation_date: '',
                                address: '',
                                difficult_aspects: '',
                                friction_situations: '',
                                legal_matters: '',
                                safety_concerns: '',
                                substance_mental_health: '',
                                neglect_abuse_concerns: '',
                                additional_thoughts: ''
                              });
                            }}
                            className="px-6 py-3 border border-gray-300 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition-colors bg-white"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Contacts List - Clean Cards */}
                  <div className="flex-1 overflow-y-auto px-6 pb-6">
                    {isLoadingContacts ? (
                      <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-2 border-gray-200 border-t-gray-900"></div>
                        <p className="mt-3 text-gray-500 text-sm">Loading contacts...</p>
                      </div>
                    ) : (() => {
                      const filteredContacts = contacts.filter(contact => 
                        contact.contact_name.toLowerCase().includes(contactSearch.toLowerCase()) ||
                        (contact.relationship && contact.relationship.toLowerCase().includes(contactSearch.toLowerCase())) ||
                        (contact.contact_email && contact.contact_email.toLowerCase().includes(contactSearch.toLowerCase()))
                      );
                      
                      return filteredContacts.length === 0 ? (
                        <div className="text-center py-16">
                          <Users className="w-16 h-16 text-gray-200 mx-auto mb-4" />
                          <p className="text-gray-500 text-base">
                            {contactSearch ? 'No contacts found' : 'No contacts yet'}
                          </p>
                        </div>
                      ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          {filteredContacts.map((contact) => {
                            const initials = contact.contact_name
                              .split(' ')
                              .map(n => n[0])
                              .join('')
                              .toUpperCase()
                              .slice(0, 2);
                            const avatarColor = stringToColor(contact.contact_name);
                            
                            // Format timestamp (use created_at or updated_at)
                            const timestamp = contact.updated_at || contact.created_at;
                            const formatTimestamp = (dateStr) => {
                              if (!dateStr) return '';
                              const date = new Date(dateStr);
                              const now = new Date();
                              const diffMs = now - date;
                              const diffMins = Math.floor(diffMs / 60000);
                              const diffHours = Math.floor(diffMs / 3600000);
                              const diffDays = Math.floor(diffMs / 86400000);
                              
                              if (diffMins < 1) return 'Just now';
                              if (diffMins < 60) return `${diffMins}m ago`;
                              if (diffHours < 24) return `${diffHours}h ago`;
                              if (diffDays === 1) return 'Yesterday';
                              if (diffDays < 7) return `${diffDays}d ago`;
                              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            };
                            
                            return (
                              <div
                                key={contact.id}
                                onClick={() => handleEditContact(contact)}
                                className="bg-white rounded-2xl border border-gray-200 p-5 hover:border-gray-300 hover:shadow-sm cursor-pointer transition-all group"
                              >
                                <div className="flex items-start gap-4">
                                  {/* Avatar - Pop of Color */}
                                  <div className={`w-14 h-14 rounded-2xl ${avatarColor} flex items-center justify-center text-white font-bold text-base flex-shrink-0 shadow-sm`}>
                                    {initials}
                                  </div>
                                  
                                  {/* Contact Info */}
                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-start justify-between mb-1">
                                      <h3 className="text-base font-bold text-gray-900 truncate group-hover:text-gray-700">{contact.contact_name}</h3>
                                    </div>
                                    <p className="text-sm text-gray-500 mb-2 truncate">
                                      {contact.relationship === 'co-parent' ? 'My Co-Parent' : (contact.relationship || contact.contact_email || 'No details')}
                                    </p>
                                    <div className="flex items-center justify-between mt-2">
                                      <span className="text-xs text-gray-400">{formatTimestamp(timestamp)}</span>
                                      <svg className="w-4 h-4 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                      </svg>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      );
                    })()}
                  </div>

                </div>
              )}

              {/* Contact Suggestion Modal */}
              {showContactSuggestion && suggestedContact && (
                <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-2xl shadow-lg w-full max-w-md flex flex-col border border-gray-200">
                    <div className="border-b border-gray-100 px-6 py-5 flex items-center justify-between flex-shrink-0">
                      <div>
                        <h3 className="text-lg font-bold text-gray-900">Add Contact</h3>
                        <p className="text-sm text-gray-500 mt-1">Would you like to create a new contact for <span className="font-semibold text-gray-900">{suggestedContact.detectedName}</span>?</p>
                      </div>
                      <button
                        onClick={() => {
                          setShowContactSuggestion(false);
                          setSuggestedContact(null);
                          setSuggestedRelationship('');
                          socketRef.current?.emit('contact_suggestion_response', {
                            response: 'no',
                            detectedName: suggestedContact.detectedName
                          });
                        }}
                        className="text-gray-400 hover:text-gray-600 text-xl font-bold transition-colors"
                      >
                        Ã—
                      </button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">Relationship *</label>
                        <select
                          value={suggestedRelationship}
                          onChange={(e) => setSuggestedRelationship(e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:border-gray-400 transition-colors bg-white text-gray-900"
                          required
                        >
                          <option value="">Select relationship...</option>
                          <option value="My Co-Parent">My Co-Parent</option>
                          <option value="My Partner">My Partner</option>
                          <option value="My Partner's Child">My Partner's Child</option>
                          <option value="My Partner's Family">My Partner's Family</option>
                          <option value="My Partner's Co-Parent">My Partner's Co-Parent</option>
                          <option value="My Partner's Friend">My Partner's Friend</option>
                          <option value="My Child">My Child</option>
                          <option value="My Family">My Family</option>
                          <option value="My Friend">My Friend</option>
                          <option value="My Child's Friend">My Child's Friend</option>
                          <option value="My Child's Teacher">My Child's Teacher</option>
                          <option value="My Co-Parent's Partner">My Co-Parent's Partner</option>
                          <option value="My Co-Parent's Family">My Co-Parent's Family</option>
                          <option value="My Co-Parent's Friend">My Co-Parent's Friend</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                    </div>
                    <div className="border-t border-gray-100 bg-white px-6 py-5 rounded-b-2xl flex gap-3 flex-shrink-0">
                      <button
                        onClick={() => {
                          if (suggestedRelationship) {
                            // Map "My Co-Parent" to "co-parent" for backward compatibility
                            const relationshipValue = suggestedRelationship === 'My Co-Parent' ? 'co-parent' : suggestedRelationship;
                            
                            console.log('Adding contact from suggestion:', {
                              detectedName: suggestedContact.detectedName,
                              relationship: relationshipValue
                            });
                            
                            console.log('ðŸ“¤ Sending contact_suggestion_response:', {
                              response: 'yes',
                              detectedName: suggestedContact.detectedName,
                              relationship: relationshipValue,
                              socketConnected: socketRef.current?.connected
                            });
                            
                            if (!socketRef.current || !socketRef.current.connected) {
                              console.error('âŒ Socket not connected, cannot send contact suggestion response');
                              setError('Not connected to server. Please wait and try again.');
                              return;
                            }
                            
                            socketRef.current.emit('contact_suggestion_response', {
                              response: 'yes',
                              detectedName: suggestedContact.detectedName,
                              relationship: relationshipValue
                            });
                            
                            setShowContactSuggestion(false);
                            setSuggestedContact(null);
                            setSuggestedRelationship('');
                            
                            // Refresh contacts list after a delay to ensure server has saved
                            setTimeout(() => {
                              console.log('ðŸ”„ Refreshing contacts list...');
                              loadContacts();
                              loadOnboardingStatus();
                              loadCoparentName();
                            }, 1000); // Increased delay to ensure server has saved
                          }
                        }}
                        disabled={!suggestedRelationship}
                        className="flex-1 bg-gray-900 text-white py-3 rounded-xl font-semibold hover:bg-gray-800 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed disabled:text-gray-500"
                      >
                        Add Contact
                      </button>
                      <button
                        onClick={() => {
                          setShowContactSuggestion(false);
                          setSuggestedContact(null);
                          setSuggestedRelationship('');
                          socketRef.current?.emit('contact_suggestion_response', {
                            response: 'no',
                            detectedName: suggestedContact.detectedName
                          });
                        }}
                        className="px-6 py-3 border border-gray-300 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition-colors bg-white"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Flag Message Modal */}
              {showFlagModal && flaggingMessageId && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div className="mb-4">
                      <h3 className="text-xl font-bold text-gray-800 mb-2">Flag Message as Triggering</h3>
                      <p className="text-sm text-gray-600">
                        Help the AI understand why this message is triggering for you. This information will be saved to your co-parent's profile to improve future mediation.
                      </p>
                    </div>
                    
                    <div className="mb-4">
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        Why is this message triggering for you?
                      </label>
                      <textarea
                        value={flagReason}
                        onChange={(e) => setFlagReason(e.target.value)}
                        placeholder="e.g., This reminds me of past arguments about custody, or This tone feels dismissive..."
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"
                        rows={4}
                        style={{ minHeight: '100px' }}
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        Your response helps the AI better understand your communication needs.
                      </p>
                    </div>
                    
                    <div className="flex gap-3">
                      <button
                        onClick={() => {
                          if (flagReason.trim() && socketRef.current) {
                            socketRef.current.emit('flag_message', { 
                              messageId: flaggingMessageId,
                              reason: flagReason.trim()
                            });
                          }
                          setShowFlagModal(false);
                          setFlaggingMessageId(null);
                          setFlagReason('');
                        }}
                        disabled={!flagReason.trim()}
                        className="flex-1 px-6 py-3 bg-primary text-white rounded-xl font-semibold hover:bg-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        style={{ borderRadius: '8px' }}
                      >
                        Flag Message
                      </button>
                      <button
                        onClick={() => {
                          setShowFlagModal(false);
                          setFlaggingMessageId(null);
                          setFlagReason('');
                        }}
                        className="px-6 py-3 border border-gray-300 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition-colors bg-white"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Account View */}
              {currentView === 'account' && isAuthenticated && (
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8 overflow-y-auto" style={{ maxHeight: 'calc(100vh - 200px)' }}>
                  <div className="mb-6">
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">Account</h2>
                    <p className="text-gray-600">Manage your billing and subscription</p>
                  </div>

                  {/* Billing Section */}
                  <div className="space-y-6 mb-8">
                    <div className="border-b border-gray-200 pb-6">
                      <h3 className="text-xl font-semibold text-teal-dark mb-4">Billing & Subscription</h3>
                      
                      <div className="bg-teal-light border border-teal rounded-xl p-6 mb-4">
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h4 className="text-lg font-semibold text-teal-dark">Current Plan</h4>
                            <p className="text-sm text-gray-600 mt-1">Free Plan</p>
                          </div>
                          <div className="text-right">
                            <p className="text-2xl font-bold text-primary">$0</p>
                            <p className="text-xs text-gray-500">per month</p>
                          </div>
                        </div>
                      </div>

                      <div className="space-y-4">
                        <div className="p-4 border border-gray-200 rounded-lg">
                          <h4 className="font-semibold text-gray-800 mb-2">Available Plans</h4>
                          <div className="space-y-3">
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                              <div>
                                <p className="font-medium text-gray-800">AI Mediation</p>
                                <p className="text-sm text-gray-600">AI-powered communication assistance</p>
                              </div>
                              <div className="text-right">
                                <p className="font-semibold text-gray-800">$15/mo</p>
                                <p className="text-xs text-gray-500">or $150/yr</p>
                              </div>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                              <div>
                                <p className="font-medium text-gray-800">Integrated Co-Parent Platform</p>
                                <p className="text-sm text-gray-600">Calendar, Expenses, Document Sharing</p>
                              </div>
                              <div className="text-right">
                                <p className="font-semibold text-gray-800">$20/mo</p>
                                <p className="text-xs text-gray-500">or $240/yr</p>
                              </div>
                            </div>
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                              <div>
                                <p className="font-medium text-gray-800">Analytics and Coaching</p>
                                <p className="text-sm text-gray-600">Advanced insights and personalized coaching</p>
                              </div>
                              <div className="text-right">
                                <p className="font-semibold text-gray-800">$25/mo</p>
                                <p className="text-xs text-gray-500">or $300/yr</p>
                              </div>
                            </div>
                          </div>
                        </div>

                        <button
                          className="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors"
                          style={{ borderRadius: '8px' }}
                        >
                          Upgrade Plan
                        </button>
                        <p className="text-xs text-gray-500 text-center">
                          Billing management coming soon. Contact support for subscription changes.
                        </p>
                      </div>
                    </div>

                    {/* Referral Section */}
                    <div className="border-b border-gray-200 pb-6">
                      <h3 className="text-xl font-semibold text-teal-dark mb-4">Refer a Friend</h3>
                      <div className="bg-teal-light border border-teal rounded-xl p-6">
                        <p className="text-gray-700 mb-4">
                          Know someone who could benefit from LiaiZen? Share the app with them and help build a supportive co-parenting community.
                        </p>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input
                              type="email"
                              placeholder="friend@email.com"
                              className="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-teal transition-colors shadow-neumorphic-inset"
                            />
                          </div>
                          <button
                            className="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary transition-colors flex items-center justify-center gap-2"
                            style={{ borderRadius: '8px' }}
                          >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                            Send Referral
                          </button>
                          <p className="text-xs text-gray-500 text-center">
                            Your friend will receive an invitation email to join LiaiZen.
                          </p>
                        </div>
                      </div>
                    </div>

                    {/* Account Settings */}
                    <div>
                      <h3 className="text-xl font-semibold text-teal-dark mb-4">Account Settings</h3>
                      <div className="space-y-3">
                        {/* Notification Settings */}
                        <div className="p-4 border border-gray-200 rounded-lg">
                          <div className="flex items-center justify-between mb-2">
                            <div>
                              <h4 className="font-semibold text-gray-800">Push Notifications</h4>
                              <p className="text-sm text-gray-600">Get notified when you receive new messages</p>
                            </div>
                            <div className="flex items-center gap-2">
                              {notificationPermission === 'granted' ? (
                                <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                  Enabled
                                </span>
                              ) : notificationPermission === 'denied' ? (
                                <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">
                                  Blocked
                                </span>
                              ) : (
                                <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-semibold">
                                  Not Set
                                </span>
                              )}
                            </div>
                          </div>
                          {notificationPermission !== 'granted' && (
                            <button
                              onClick={requestNotificationPermission}
                              className="mt-2 w-full px-4 py-2 bg-primary text-white rounded-lg font-semibold hover:bg-primary transition-colors text-sm"
                              style={{ borderRadius: '8px' }}
                            >
                              {notificationPermission === 'denied' 
                                ? 'Notifications Blocked - Enable in Browser Settings' 
                                : 'Enable Notifications'}
                            </button>
                          )}
                          {notificationPermission === 'denied' && (
                            <p className="text-xs text-gray-500 mt-2">
                              To enable notifications, please update your browser settings and allow notifications for this site.
                            </p>
                          )}
                        </div>
                        <button
                          onClick={() => {
                            setShowPasswordChange(true);
                            setCurrentView('profile');
                          }}
                          className="w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-between"
                        >
                          <span className="text-gray-700">Change Password</span>
                          <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                          </svg>
                        </button>
                        <div className="p-4 bg-gray-50 rounded-lg">
                          <p className="text-sm text-gray-600">
                            <strong>Account ID:</strong> {username}
                          </p>
                          <p className="text-xs text-gray-500 mt-1">
                            Created: {profileData.created_at ? new Date(profileData.created_at).toLocaleDateString() : 'N/A'}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </>
          ) : (
            <div></div>
          )}
        </div>
        
        {/* Footer with Privacy and Terms Links */}
        <footer className="bg-white border-t border-gray-200 py-6 px-4 text-center text-sm text-gray-600 mt-8">
          <div className="flex flex-col md:flex-row justify-center items-center gap-4 mb-2">
            <a href="/privacy" className="hover:text-primary transition-colors">
              Privacy Policy
            </a>
            <span className="hidden md:inline text-gray-400">|</span>
            <a href="/terms" className="hover:text-primary transition-colors">
              Terms of Service
            </a>
          </div>
          <p className="text-gray-500 text-xs mt-2">Â© 2025 LiaiZen. All rights reserved.</p>
        </footer>
        </>
      );
    }
  </script>

  <script type="text/babel">
    try {
      if (typeof ChatRoom === 'undefined') {
        throw new Error('ChatRoom component is not defined');
      }
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error('Root element not found');
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(React.createElement(ChatRoom));
    } catch (error) {
      console.error('Error rendering React app:', error);
      const root = document.getElementById('root');
      if (root) {
        root.innerHTML = '<div style="padding: 20px; color: red; font-family: sans-serif;"><h1>Error Loading App</h1><p>' + error.message + '</p><p>Check the browser console for details.</p></div>';
      }
    }

    // Register Service Worker for PWA (only in production)
    const isLocalhost = window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1' ||
                       window.location.hostname.startsWith('192.168.') ||
                       window.location.hostname.startsWith('10.') ||
                       window.location.hostname.startsWith('172.');
    
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        if (isLocalhost) {
          // Development: Unregister all service workers
          navigator.serviceWorker.getRegistrations().then((registrations) => {
            if (registrations.length > 0) {
              console.log(`ðŸ”§ Unregistering ${registrations.length} service worker(s) for development...`);
              registrations.forEach((registration) => {
                registration.unregister().then((success) => {
                  if (success) {
                    console.log('âœ… Service Worker unregistered');
                  }
                });
              });
            }
          });
        } else {
          // Production: Register service worker
          const swPath = '/service-worker.js';
        navigator.serviceWorker.register(swPath)
          .then((registration) => {
            console.log('âœ… Service Worker registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.log('âš ï¸ Service Worker registration failed:', error);
          });
        }
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show install button or banner
      showInstallButton();
    });

    function showInstallButton() {
      // Check if app is already installed
      if (window.matchMedia('(display-mode: standalone)').matches) {
        return; // Already installed
      }

      // Create install button
      const installButton = document.createElement('button');
      installButton.id = 'pwa-install-button';
      installButton.innerHTML = 'ðŸ“± Install App';
      installButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #275559;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
      `;
      installButton.addEventListener('click', async () => {
        if (deferredPrompt) {
          // Show the install prompt
          deferredPrompt.prompt();
          // Wait for the user to respond
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response to install prompt: ${outcome}`);
          // Clear the deferredPrompt
          deferredPrompt = null;
          // Hide the install button
          installButton.remove();
        }
      });
      document.body.appendChild(installButton);
    }

    // Hide install button if app is already installed
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      const installButton = document.getElementById('pwa-install-button');
      if (installButton) {
        installButton.remove();
      }
      deferredPrompt = null;
    });
  </script>
</body>
</html>
